{"config":{"lang":["fr"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"ITWAY","text":""},{"location":"#presentation-generale-du-projet","title":"Pr\u00e9sentation G\u00e9n\u00e9rale du Projet","text":"<p>Ce projet a \u00e9t\u00e9 r\u00e9alis\u00e9 dans le cadre du parcours DSNS (D\u00e9veloppement de solutions num\u00e9riques s\u00e9curis\u00e9es), option Cybers\u00e9curit\u00e9, propos\u00e9 par la CCI d\u2019Avignon.</p> <p>Il s\u2019inscrit dans un cycle de formation visant \u00e0 d\u00e9velopper des comp\u00e9tences avanc\u00e9es en conception, d\u00e9ploiement et s\u00e9curisation d\u2019infrastructures r\u00e9seau et syst\u00e8me. L\u2019objectif final est de ma\u00eetriser la mise en \u0153uvre de solutions techniques robustes, en ad\u00e9quation avec les standards actuels de s\u00e9curit\u00e9, de performance et de conformit\u00e9.</p>"},{"location":"#participants","title":"Participants","text":"<p>Ce travail a \u00e9t\u00e9 r\u00e9alis\u00e9 en bin\u00f4me, par :</p> <ul> <li>Firas JEMAA</li> <li>Najet BOUKADOUR</li> </ul> <p>Le choix de travailler en bin\u00f4me a permis un partage \u00e9quitable des t\u00e2ches, une compl\u00e9mentarit\u00e9 des comp\u00e9tences et un enrichissement mutuel sur tous les aspects du projet, depuis l\u2019analyse initiale jusqu'\u00e0 la conception d\u2019une solution technique compl\u00e8te.</p>"},{"location":"#deroulement-du-projet","title":"D\u00e9roulement du projet","text":"<p>Le projet se structure en trois phases principales : Consult\u00e9 les 3 phases ici.</p>"},{"location":"#phase-1-analyse-du-cahier-des-charges","title":"Phase 1 \u2013 Analyse du Cahier des Charges","text":"<p>\u00c9tude approfondie des besoins de l\u2019entreprise ITWay, \u00e9valuation des solutions techniques (virtualisation, conteneurisation, s\u00e9curit\u00e9), \u00e9laboration d\u2019une premi\u00e8re architecture, et planification du projet.</p>"},{"location":"#phase-2-conception-deploiement-et-maintenance","title":"Phase 2 \u2013 Conception, D\u00e9ploiement et Maintenance","text":"<p>R\u00e9alisation concr\u00e8te de l\u2019infrastructure : choix des technologies, d\u00e9ploiement des services (r\u00e9seau, s\u00e9curit\u00e9, communication), configuration des outils, et documentation technique compl\u00e8te.</p>"},{"location":"#phase-3-modernisation-et-renforcement-de-la-securite","title":"Phase 3 \u2013 Modernisation et Renforcement de la S\u00e9curit\u00e9","text":"<p>Int\u00e9gration de technologies avanc\u00e9es (SIEM, supervision, MFA...), durcissement de la s\u00e9curit\u00e9, mise \u00e0 jour de la documentation et sensibilisation des utilisateurs aux bonnes pratiques.</p>"},{"location":"conception/","title":"Conception et Organisation du Projet ITWay","text":""},{"location":"conception/#introduction","title":"Introduction","text":"<p>Le projet ITWay a \u00e9t\u00e9 r\u00e9alis\u00e9 dans le cadre de notre formation DSNS \u2013 option Cybers\u00e9curit\u00e9. Il s\u2019agit d\u2019un projet de fin d\u2019ann\u00e9e ayant pour objectif la conception, le d\u00e9veloppement et la documentation compl\u00e8te d\u2019une infrastructure syst\u00e8me et r\u00e9seau s\u00e9curis\u00e9e, selon un cahier des charges pr\u00e9cis.</p> <p>Ce document pr\u00e9sente l\u2019organisation mise en place, la r\u00e9partition des t\u00e2ches, ainsi que le d\u00e9roulement du projet.</p>"},{"location":"conception/#cahier-des-charges","title":"Cahier des charges","text":"<p>Le cahier des charges centralise toutes les attentes fonctionnelles et les contraintes techniques du projet IT-WAY. Il sert de r\u00e9f\u00e9rence tout au long de la mise en \u0153uvre. Vous pouvez le consulter ici.</p>"},{"location":"conception/#repartition-des-roles","title":"R\u00e9partition des r\u00f4les","text":"<p>Nous avons travaill\u00e9 en bin\u00f4me, avec une r\u00e9partition des responsabilit\u00e9s claire et compl\u00e9mentaire :</p> <ul> <li> <p>Ensemble</p> <ul> <li>Conception de l\u2019architecture r\u00e9seau</li> <li>Configuration des routeurs, des VLAN et du plan d\u2019adressage</li> <li>Mise en place de la s\u00e9curit\u00e9 r\u00e9seau (pare-feu, filtrage, VPN)</li> <li>Supervision (Grafana)</li> <li>D\u00e9ploiement du service PKI</li> <li>R\u00e9daction de la documentation technique des services r\u00e9seau</li> </ul> </li> <li> <p>Firase JEMAA</p> <ul> <li>Automatisation des configurations avec Ansible</li> <li>D\u00e9ploiement des services dans la DMZ (serveur web, DNS, reverse proxy, serveur SMTP)</li> <li>Int\u00e9gration du serveur mail avec le serveur SMTP</li> <li>R\u00e9daction de la documentation</li> </ul> </li> <li> <p>Najet BOUKADOUR</p> <ul> <li>D\u00e9ploiement de l\u2019Active Directory et configuration du DNS interne</li> <li>Mise en place des strat\u00e9gies de groupe (GPO) et des unit\u00e9s d'organisations (OU)</li> <li>D\u00e9ploiement du serveur Grafana et Wazuh</li> <li>R\u00e9daction de la documentation</li> </ul> </li> </ul>"},{"location":"conception/#methodologie-de-travail","title":"M\u00e9thodologie de travail","text":"<p>Nous avons adopt\u00e9 une approche structur\u00e9e en plusieurs \u00e9tapes :</p> <p>Nous avons commenc\u00e9 par concevoir la structure du r\u00e9seau ensemble, afin que chacun ma\u00eetrise les fondamentaux et que nous soyons sur la m\u00eame longueur d\u2019onde. Par la suite, nous avons r\u00e9parti les t\u00e2ches en fonction des points forts de chaque membre de l'\u00e9quipe.</p> <p>Nous avons \u00e9galement convenu d\u2019organiser une r\u00e9union hebdomadaire de 4 heures pour faire un point sur l\u2019avancement de chacun et \u00e9changer sur les \u00e9ventuelles difficult\u00e9s rencontr\u00e9es. Le partage des documentations, des playbooks et autres fichiers s\u2019est fait via un d\u00e9p\u00f4t GitHub commun, tandis que le suivi des t\u00e2ches et du planning a \u00e9t\u00e9 g\u00e9r\u00e9 avec l\u2019outil Trello.</p>"},{"location":"conception/#deroulement-du-projet","title":"D\u00e9roulement du projet","text":"<p>Au d\u00e9part, nous avons commenc\u00e9 par la mise en place de l\u2019infrastructure, en prenant en compte l\u2019ensemble de l\u2019architecture afin d\u2019avoir une vision globale de chaque section et composant. Cela a impliqu\u00e9 la cr\u00e9ation et la configuration des VLANs n\u00e9cessaires.</p> <p>Une fois cette base pos\u00e9e, nous avons commenc\u00e9 par la configuration des routeurs, afin de permettre la connectivit\u00e9 entre les diff\u00e9rentes zones, mais sans appliquer de r\u00e8gles de pare-feu dans un premier temps. Ensuite, nous avons configur\u00e9 les switches et v\u00e9rifi\u00e9 que le routage inter-VLAN fonctionnait correctement, notamment \u00e0 travers le service DHCP h\u00e9berg\u00e9 sur le routeur.</p> <p>Apr\u00e8s cela, nous sommes pass\u00e9s \u00e0 l\u2019infrastructure des machines virtuelles.</p> <p>Nous avons d\u2019abord d\u00e9ploy\u00e9 la machine Ansible ainsi que la machine PKI, car Ansible nous permettait de d\u00e9ployer et configurer automatiquement les autres serveurs. En parall\u00e8le, nous avons \u00e9galement commenc\u00e9 la mise en place de l\u2019Active Directory (AD).</p> <p>Par la suite, chacun a configur\u00e9 les services qui lui \u00e9taient attribu\u00e9s, tout en partageant r\u00e9guli\u00e8rement l\u2019avancement pour coordonner les \u00e9tapes suivantes et garantir une coh\u00e9rence dans le d\u00e9ploiement global.</p>"},{"location":"core-rt/","title":"CORE-RT","text":""},{"location":"core-rt/#1-architecture-reseau-virtualisee-contexte-objectifs","title":"1. Architecture r\u00e9seau virtualis\u00e9e \u2013 Contexte &amp; Objectifs","text":"<p>Dans le cadre de ce projet, l'infrastructure r\u00e9seau est enti\u00e8rement virtualis\u00e9e sous GNS3. Elle simule l\u2019environnement informatique d\u2019une entreprise multisite. Le r\u00e9seau est con\u00e7u pour assurer :</p> <ul> <li>La s\u00e9paration des usages par VLAN  </li> <li>Une DMZ s\u00e9curis\u00e9e  </li> <li>L\u2019utilisation d\u2019un pare-feu Stormshield pour le filtrage, la segmentation, le routage inter-VLAN et le NAT  </li> <li>Un plan d\u2019adressage document\u00e9</li> </ul> <p>La mise en place de VLANs permet une isolation stricte entre les diff\u00e9rents services, services utilisateurs et serveurs. Les routeurs Stormshield g\u00e8rent :</p> <ul> <li>Le routage inter-VLAN  </li> <li>Le filtrage par r\u00e8gles de firewall  </li> <li>Le DHCP sp\u00e9cifique \u00e0 chaque segment r\u00e9seau  </li> <li>Les flux autoris\u00e9s entre DMZ et VLAN, ainsi que vers et depuis internet.  </li> <li>Le trafic vers la DMZ et Internet qui transite par les routeurs BORDER-RT \u2194 DMZ-RT</li> </ul> <p>BORDER-RT est le routeur frontalier qui fait la jonction entre le r\u00e9seau interne (LAN) et l'ext\u00e9rieur (Internet).</p> <p>DMZ-RT est le routeur qui fait la jonction entre la DMZ et les autres zones (r\u00e9seau interne et Internet).</p>"},{"location":"core-rt/#2-resume-de-la-configuration-nat","title":"2. R\u00e9sum\u00e9 de la configuration NAT","text":"<p>Acc\u00e8s \u00e0 la configuration :</p> <ul> <li>Aller \u00e0 Configuration &gt; Security Policy &gt; Filter NAT &gt; NAT.  </li> <li>Cr\u00e9er une nouvelle r\u00e8gle NAT (Simple Rule) et l\u2019\u00e9diter. Param\u00e9trage :  </li> <li>G\u00e9n\u00e9ral : Activer la r\u00e8gle, d\u00e9finir Source : Network Internals, Source Port : Any.  </li> <li>Original Destination : S\u00e9lectionner Internet, Destination Port : Any, Outgoing : Out.  </li> <li>Translated Source : Utiliser Firewall_out, Source Port : Ephemeral FW, activer Random port.  </li> <li>Translated Destination : Any.  </li> <li>Politique par d\u00e9faut : Configurer Filter NAT &gt; Default Policy sur Pass.  </li> </ul> <p>Test : Un ping vers 8.8.8.8 depuis un PC interne a \u00e9t\u00e9 effectu\u00e9. Le ping fonctionne donc la configuration NAT est correcte.</p>"},{"location":"core-rt/#3-plan-dadressage-et-vlans","title":"3. Plan d\u2019adressage et VLANs","text":"VLAN Interface Plage DHCP Gateway IT VLAN10 172.16.10.4 - 172.16.10.6 172.16.10.1 DIR VLAN20 192.168.20.2 - 192.168.20.14 192.168.20.1 COM VLAN30 192.168.30.2 - 192.168.30.14 192.168.30.1 PROD VLAN40 192.168.40.2 - 192.168.40.62 192.168.40.1 SRV VLAN50 172.16.50.5 - 172.16.50.6 172.16.50.1"},{"location":"core-rt/#4-configuration-des-vlans-sur-stormshield","title":"4. Configuration des VLANs sur Stormshield","text":"<p>Les VLANs sont configur\u00e9s directement dans le Stormshield, en utilisant les interfaces VLAN virtuelles sur le port LAN.</p> <p>Exemple : configuration pour VLAN 40 (Production) :</p> <p></p>"},{"location":"core-rt/#5-configuration-du-dhcp-sur-stormshield","title":"5. Configuration du DHCP sur Stormshield","text":"<p>Sur Stormshield :</p> <ul> <li>Objet r\u00e9seau DHCP-VLAN40 d\u00e9fini  </li> <li>Exclusion de la passerelle (192.168.40.1)  </li> <li>Attribue automatiquement des IPs dans la plage d\u00e9finie  </li> <li>DNS primaire/secondaire (IPs du serveur AD et AD2 si elle existait)</li> </ul> <p></p>"},{"location":"core-rt/#6-gestion-des-objets-sur-stormshield","title":"6. Gestion des objets sur Stormshield","text":"<p>L\u2019utilisation d\u2019objets Stormshield est essentielle pour la lisibilit\u00e9 et la r\u00e9utilisation dans les r\u00e8gles de s\u00e9curit\u00e9 :</p> <ul> <li>Objets IP (r\u00e9seaux, h\u00f4tes, plages)  </li> <li>Objets interface (VLANs, ports)  </li> <li>Objets services (HTTP, SMTP, etc.)  </li> <li>Groupes d\u2019objets (pour simplifier les ACLs)  </li> <li>\u2026</li> </ul> <p></p>"},{"location":"core-rt/#7-securite-bonne-pratique-sur-les-ports","title":"7. S\u00e9curit\u00e9 \u2013 Bonne pratique sur les ports","text":"<p>Une configuration importante sur Stormshield a \u00e9t\u00e9 effectu\u00e9e :</p> <p>Port 4 : port physique d\u00e9sactiv\u00e9, mais les VLANs associ\u00e9s restent fonctionnels.</p> <ul> <li>Cela \u00e9vite d\u2019attribuer une IP au port physique, donc r\u00e9duit la surface d\u2019attaque.  </li> <li>Les VLANs sont encapsul\u00e9s dans le port trunk mais le port en lui-m\u00eame n\u2019est pas expos\u00e9.</li> </ul> <p></p>"},{"location":"core-rt/#8-configuration-des-switchs","title":"8. Configuration des switchs","text":"<p>CORE-SW :</p> <ul> <li>Les ports uplink vers d\u2019autres VLANs ou vers le routeur sont en mode trunk (dot1q)  </li> <li>Le port vers le switch des serveurs (SW-SRV) est aussi en trunk </li> </ul> <p></p> <p>SW-SRV :</p> <ul> <li>Le port vers le CORE-SW est en trunk (dot1q)  </li> <li>Le port vers la machine du VLAN 40 est en mode access, VLAN 40</li> </ul>"},{"location":"core-rt/#9-regles-de-pare-feu","title":"9. R\u00e8gles de pare-feu","text":""},{"location":"core-rt/#91-objectif","title":"9.1 Objectif","text":"<p>Mettre en place une politique de filtrage rigoureuse sur les deux routeurs pare-feu de l\u2019infrastructure.</p> <p>La politique de base repose sur le principe de refus par d\u00e9faut (Deny All) : seuls les flux strictement n\u00e9cessaires sont autoris\u00e9s. Les r\u00e8gles sont organis\u00e9es par zone logique (INTERNET, DMZ NETWORK, DMZ-TUNNEL, LAN-NETWORK, IT-NETWORK, SRV-NETWORK et CORE-NETWORK) et fond\u00e9es sur le principe du moindre privil\u00e8ge : aucun service superflu ne doit \u00eatre accessible.</p>"},{"location":"core-rtold/","title":"Routeur Principal \u2013 CORE-RT (BORDER-RT)","text":""},{"location":"core-rtold/#presentation","title":"Pr\u00e9sentation","text":"<p>Le routeur CORE-RT (renomm\u00e9 BORDER-RT) constitue le c\u0153ur de l\u2019infrastructure. Il assure la connexion entre les sous-r\u00e9seaux internes (LAN, IT, SRV) et la DMZ, ainsi que l\u2019acc\u00e8s vers Internet.</p> <p>Il a \u00e9t\u00e9 d\u00e9ploy\u00e9 et configur\u00e9 dans GNS3 \u00e0 l\u2019aide du pare-feu Stormshield EVA.</p>"},{"location":"core-rtold/#deploiement","title":"D\u00e9ploiement","text":"<ul> <li>Template import\u00e9 : Stormshield EVA \u2013 version 4.3.33</li> <li>Connexion : <ul> <li>Port OUT reli\u00e9 \u00e0 Internet</li> <li>Port IN reli\u00e9 \u00e0 un switch CORE-SW</li> <li>Port DMZ reli\u00e9 au DMZ-RT</li> </ul> </li> </ul>"},{"location":"core-rtold/#configuration-initiale","title":"Configuration initiale","text":"<ul> <li>Acc\u00e8s console via VNC</li> <li>Clavier configur\u00e9 en AZERTY (<code>sudo loadkeys fr</code>)</li> <li>IP statique sur interface IN : <code>192.168.84.1/24</code></li> <li>Interface OUT configur\u00e9e en DHCP</li> <li>Interface Web accessible depuis un poste client Ubuntu</li> </ul>"},{"location":"core-rtold/#services-actives","title":"Services activ\u00e9s","text":"<ul> <li>DHCP sur les interfaces internes (SRV, LAN, etc.)</li> <li>VPN SSL pour acc\u00e8s distant via <code>vpn.itway.fr</code></li> <li>Routage inter-VLAN</li> <li>NAT sortant pour l'acc\u00e8s Internet depuis les r\u00e9seaux internes</li> <li>Filtrage pare-feu personnalis\u00e9 (par VLAN, par service)</li> <li>Acc\u00e8s administration restreint \u00e0 IT-NET uniquement</li> </ul>"},{"location":"core-rtold/#vlans-configures","title":"VLANs configur\u00e9s","text":"<p>REVOIR</p> VLAN Nom r\u00e9seau Plage IP Gateway 10 NET-IT 172.16.86.0/27 172.16.86.1 31 Direction &amp; Administratif 192.168.90.0/26 192.168.90.1 122 WAN/OUT DHCP (Internet) -"},{"location":"core-rtold/#securite","title":"S\u00e9curit\u00e9","text":"<ul> <li>Acc\u00e8s Web/SSH uniquement depuis IT-NET</li> <li>Authentification via comptes AD membres du groupe <code>GRP-SECU-IT</code></li> <li>Filtrage ICMP activ\u00e9 (dans les deux sens)</li> <li>NAT configur\u00e9 pour masquer les IP internes</li> <li>Mise en place de sauvegardes automatiques</li> </ul>"},{"location":"core-rtold/#sauvegarde","title":"Sauvegarde","text":"<ul> <li>Sauvegarde hebdomadaire manuelle (sur machine Windows)</li> <li>Objectif futur : sauvegarde automatique vers serveur HTTPS</li> <li>Test de restauration \u00e0 pr\u00e9voir</li> </ul>"},{"location":"core-rtold/#observations","title":"Observations","text":"<ul> <li>L\u2019infrastructure a \u00e9t\u00e9 test\u00e9e avec succ\u00e8s (ping 8.8.8.8 OK)</li> <li>Passage du switch Cisco \u00e0 un switch Ethernet pour compatibilit\u00e9</li> <li>Renommage de l\u2019\u00e9quipement dans l\u2019interface Stormshield : <code>BORDER-RT</code></li> </ul>"},{"location":"dmz-rt/","title":"Routeur DMZ \u2013 DMZ-RT","text":""},{"location":"dmz-rt/#presentation","title":"Pr\u00e9sentation","text":"<p>Le routeur DMZ-RT est d\u00e9di\u00e9 \u00e0 l\u2019isolation de la zone DMZ. Il permet la communication entre les services expos\u00e9s \u00e0 Internet (SMTP, Web, DNS) et l\u2019ext\u00e9rieur, tout en assurant un cloisonnement strict vis-\u00e0-vis du r\u00e9seau interne.</p>"},{"location":"dmz-rt/#deploiement","title":"D\u00e9ploiement","text":"<ul> <li>Mat\u00e9riel utilis\u00e9 : Stormshield EVA \u2013 version 4.3.33</li> <li>Interface IN connect\u00e9e \u00e0 DMZ-SW</li> <li>Interface OUT connect\u00e9e au routeur CORE-RT</li> </ul>"},{"location":"dmz-rt/#configuration-initiale","title":"Configuration initiale","text":"<ul> <li>Adresse IP : <code>192.168.86.2/24</code></li> <li>Acc\u00e8s administrateur : <code>admin / *********</code></li> <li>Interface Web activ\u00e9e pour supervision via un poste Ubuntu</li> <li>Connexion test\u00e9e depuis le r\u00e9seau DMZ avec succ\u00e8s</li> </ul>"},{"location":"dmz-rt/#services-actives","title":"Services activ\u00e9s","text":"<ul> <li>Filtrage pare-feu strict entre la DMZ et l\u2019interne</li> <li>NAT sortant configur\u00e9 pour les services de la DMZ (Web, SMTP)</li> <li>Acc\u00e8s entrants filtr\u00e9s depuis Internet (port 80/443, SMTP uniquement)</li> <li>DHCP d\u00e9sactiv\u00e9 (adressage statique utilis\u00e9)</li> </ul>"},{"location":"dmz-rt/#securite","title":"S\u00e9curit\u00e9","text":"<ul> <li>Aucun acc\u00e8s DMZ \u2192 Interne, sauf exceptions pr\u00e9cises (SMTP vers SRV-MAIL)</li> <li>Acc\u00e8s SSH/Web r\u00e9serv\u00e9 au r\u00e9seau IT-NET</li> <li>Objets r\u00e9seaux cr\u00e9\u00e9s pour chaque serveur DMZ</li> <li>R\u00e8gles sp\u00e9cifiques appliqu\u00e9es pour chaque service public expos\u00e9</li> <li>Sauvegardes manuelles enregistr\u00e9es localement</li> </ul>"},{"location":"dmz-rt/#observations","title":"Observations","text":"<ul> <li>Routeur test\u00e9 et fonctionnel</li> <li>Int\u00e9gration r\u00e9ussie avec le reverse proxy, serveur Web et serveur Mail</li> <li>Compatible avec les VLANs issus du CORE-SW (via trunking)</li> </ul>"},{"location":"indexold/","title":"Welcome to MkDocs","text":"<p>For full documentation visit mkdocs.org.</p>"},{"location":"indexold/#commands","title":"Commands","text":"<ul> <li><code>mkdocs new [dir-name]</code> - Create a new project.</li> <li><code>mkdocs serve</code> - Start the live-reloading docs server.</li> <li><code>mkdocs build</code> - Build the documentation site.</li> <li><code>mkdocs -h</code> - Print help message and exit.</li> </ul>"},{"location":"indexold/#project-layout","title":"Project layout","text":"<pre><code>mkdocs.yml    # The configuration file.\ndocs/\n    index.md  # The documentation homepage.\n    ...       # Other markdown pages, images and other files.\n</code></pre> <p>$</p> <p>source venv/bin/activate deactivate</p>"},{"location":"infra/","title":"Conception de l\u2019Infrastructure","text":""},{"location":"infra/#demarrage-du-projet","title":"D\u00e9marrage du projet","text":"<p>Au lancement du projet, nous avons d\u00e9cid\u00e9 de commencer par une phase de conception th\u00e9orique et visuelle de l\u2019infrastructure. Pour cela, nous avons utilis\u00e9 GNS3 afin de simuler l\u2019ensemble du r\u00e9seau, en tenant compte des besoins exprim\u00e9s dans le cahier des charges.</p> <p>Notre objectif \u00e9tait de visualiser les diff\u00e9rents sous-r\u00e9seaux, leurs interconnexions, les points critiques de s\u00e9curit\u00e9, ainsi que les futurs services \u00e0 d\u00e9ployer. Cela nous a permis de valider l\u2019architecture globale avant toute mise en \u0153uvre technique.</p> <p></p>"},{"location":"infra/#plan-dadressage-reseau","title":"Plan d\u2019adressage r\u00e9seau","text":"<p>Une fois le sch\u00e9ma g\u00e9n\u00e9ral \u00e9tabli, nous avons r\u00e9fl\u00e9chi \u00e0 un plan d\u2019adressage IP coh\u00e9rent, adapt\u00e9 \u00e0 la segmentation propos\u00e9e dans le cahier des charges. Nous avons attribu\u00e9 un plage IP distincte \u00e0 chaque sous-r\u00e9seau fonctionnel :</p> <ul> <li>CORE-NETWORK : pour le routage et la s\u00e9curit\u00e9 centrale (pare-feu Stormshield),</li> <li>SRV-NETWORK : pour les serveurs internes (PKI, AD, Intranet, Mail...),</li> <li>IT-NETWORK : pour l\u2019administration et les outils internes (Ansible, Grafana...),</li> <li>DMZ-NETWORK : pour les services accessibles depuis Internet (Web, SMTP, DNS, Reverse Proxy),</li> <li>LAN-NET-* : pour les postes clients des diff\u00e9rents services internes (Communication, Direction, Production).</li> </ul> <p>L\u2019adressage a \u00e9t\u00e9 pens\u00e9 de mani\u00e8re \u00e0 :</p> <ul> <li>Favoriser la lisibilit\u00e9 et la maintenance,</li> <li>Pr\u00e9voir des plages suffisantes pour l\u2019\u00e9volution future,</li> <li>R\u00e9pondre aux contraintes de filtrage et de routage d\u00e9finies dans les politiques de s\u00e9curit\u00e9.</li> </ul>"},{"location":"infra/#validation-et-iterations","title":"Validation et it\u00e9rations","text":"<p>Le sch\u00e9ma GNS3 et le plan d\u2019adressage ont \u00e9t\u00e9 revus et ajust\u00e9s \u00e0 plusieurs reprises en fonction des retours internes et des contraintes techniques rencontr\u00e9es lors de la phase de d\u00e9ploiement. Ce travail pr\u00e9paratoire nous a permis de gagner en efficacit\u00e9 lors de l\u2019impl\u00e9mentation r\u00e9elle et d\u2019assurer une coh\u00e9rence globale de l\u2019architecture.</p>"},{"location":"infra/#tableau-dadrressage","title":"Tableau d'adrressage","text":"R\u00e9seau / VLAN Adresse r\u00e9seau Broadcast Passerelle Nb total d\u2019IP Plage DHCP IPs r\u00e9serv\u00e9es (statiques) Observations DMZ NETWORK(R\u00e9seaux) 10.10.10.0/29 10.10.10.15 10.10.10.1 8 - DMZ-SMTP : 10.10.10.3DMZ-DNS : 10.10.10.4DMZ-RPROXY : 10.10.10.5DMZ-WEB : 10.10.10.2 La DMZ doit \u00eatre s\u00e9curis\u00e9e avec ACL/pare-feu STORM-NET(R\u00e9seaux) 10.11.11.0/30 10.11.11.1 4 - BORDER-RT : 10.11.11.1 DMZ-RT : 10.11.11.2 Tunnels entre les deux routeurs IT  NETWORK (VLAN 10) 172.16.10.0/29 172.16.10.7 172.16.10.1 8 172.16.10.4 \u2192 172.16.10.6 IT-ANSIBLE :  172.16.10.2 IT-GRAFANA : 172.16.10.3 R\u00e9seau d\u2019administration et supervision DIRECTION &amp; ADMINISTRATRIF(VLAN 20) 192.168.20.0/28 192.168.20.15 192.168.20.1 16 192.168.20.2 -&gt; 192.168.20.14 - COMMERCIAUX (VLAN 30) 192.168.30.0/28 192.168.30.15 192.168.30.1 16 192.168.30.2 -&gt; 192.168.30.14 - PRODUCTION (VLAN 40) 192.168.40.0/26 192.168.40.63 192.168.40.1 64 192.168.40.2 -&gt; 192.168.40.62 - SRV NETWORK (VLAN 50) 172.16.50.0/29 172.16.50.7 172.16.50.1 8 172.16.50.5 \u2192 172.16.50.6 SRV-MAIL : 172.16.50.4SRV-INTRANET : 172.16.50.3SRV-AD01 : 172.16.50.2 Serveurs internes, acc\u00e8s restreint CORE NETWORK (VLAN 60) 172.16.60.0/30 172.16.60.1 4 - BORDER-RT : 172.16.60.1WAZUH : 172.16.60.2 R\u00e9seau consacr\u00e9 \u00e0 Wazuh et le routeur Stormshield <p>La DMZ est en dehors du LAN principal, connect\u00e9e via Stormshield isol\u00e9e pour maximiser la s\u00e9curit\u00e9.</p>"},{"location":"phase1/","title":"Phase 1","text":""},{"location":"phase1/#analyse-du-cahier-des-charges","title":"Analyse du Cahier des Charges","text":""},{"location":"phase1/#presentation-de-la-phase-1","title":"Pr\u00e9sentation de la Phase 1","text":"<p>La premi\u00e8re phase du projet consistait \u00e0 analyser en profondeur le cahier des charges fourni par l\u2019entreprise ITWay. Cette \u00e9tape cruciale avait pour but de cerner les besoins de l\u2019organisation, d\u2019en comprendre les enjeux, et de poser les premi\u00e8res bases techniques de la future infrastructure r\u00e9seau et syst\u00e8me s\u00e9curis\u00e9e.</p> <p>Cette phase comprenait plusieurs volets essentiels :</p> <ul> <li>Compr\u00e9hension du besoin : \u00c9tude attentive du cahier des charges afin d\u2019identifier les contraintes fonctionnelles, de s\u00e9curit\u00e9, de performance, de disponibilit\u00e9, et de conformit\u00e9.</li> <li>Analyse des solutions techniques : Comparaison argument\u00e9e entre diff\u00e9rentes approches (virtualisation, conteneurisation, solutions classiques), notamment sur leur performance, leur impact environnemental et leur accessibilit\u00e9.</li> <li>Identification des risques : Recensement des menaces et vuln\u00e9rabilit\u00e9s, suivi d\u2019une \u00e9valuation des risques par composant.</li> <li>Premi\u00e8re conception technique : \u00c9laboration d\u2019une maquette d\u2019infrastructure r\u00e9pondant aux besoins identifi\u00e9s, avec sch\u00e9ma r\u00e9seau, propositions de technologies (Stormshield, NGINX, Active Directory, etc.), et plan de s\u00e9curit\u00e9.</li> <li>Planification du projet : Mise en place des outils collaboratifs (Trello, Notion, Google Meet), d\u00e9finition des r\u00f4les et responsabilit\u00e9s du bin\u00f4me, r\u00e9troplanning d\u00e9taill\u00e9.</li> </ul>"},{"location":"phase1/#contenu-du-livrable","title":"Contenu du livrable","text":"<p>Le document livr\u00e9 \u00e0 l\u2019issue de cette phase contient :</p> <ul> <li>Une analyse d\u00e9taill\u00e9e du contexte et des besoins de l\u2019entreprise ITWay.</li> <li>Un sch\u00e9ma r\u00e9seau segment\u00e9 en trois zones : LAN, DMZ, SRV, avec un plan d\u2019adressage IP s\u00e9curis\u00e9 et optimis\u00e9.</li> <li>Une \u00e9tude des solutions de s\u00e9curit\u00e9 et d\u2019automatisation (IDS/IPS, SIEM, GPO, PKI, etc.).</li> <li>Un plan de gestion du projet complet : organisation en bin\u00f4me, r\u00e9troplanning, outils utilis\u00e9s.</li> <li>Des mesures \u00e9coresponsables pour optimiser l\u2019utilisation des ressources.</li> <li>Une approche inclusive int\u00e9grant l\u2019accessibilit\u00e9 et la conformit\u00e9 r\u00e9glementaire (RGPD, ANSSI...).</li> </ul>"},{"location":"phase1/#lien-vers-le-fichier","title":"Lien vers le fichier","text":"<p>Le rendu complet de cette Phase 1, sous forme de cahier des charges analys\u00e9, est disponible via le lien suivant :</p> <p>\ud83d\udcce Acc\u00e9der au rendu en fichier PDF de la Phase 1</p>"},{"location":"phase2/","title":"Pr\u00e9sentation","text":""},{"location":"phase2/#phase-2-conception-deploiement-et-maintenance","title":"Phase 2 \u2014 Conception, D\u00e9ploiement et Maintenance","text":""},{"location":"phase2/#presentation-de-la-phase-2","title":"Pr\u00e9sentation de la Phase 2","text":"<p>Apr\u00e8s l\u2019analyse initiale r\u00e9alis\u00e9e lors de la premi\u00e8re phase, la Phase 2 marque l\u2019entr\u00e9e dans la phase op\u00e9rationnelle du projet. Cette \u00e9tape a pour objectif de concevoir, d\u00e9ployer et documenter une infrastructure syst\u00e8me et r\u00e9seau fonctionnelle, s\u00e9curis\u00e9e et conforme aux exigences identifi\u00e9es.</p> <p>Nous avons mis en \u0153uvre les \u00e9l\u00e9ments techniques d\u00e9finis dans la phase pr\u00e9c\u00e9dente, en choisissant les outils et technologies adapt\u00e9s, en installant et configurant les services, et en assurant la tra\u00e7abilit\u00e9 des choix et des proc\u00e9dures.</p>"},{"location":"phase2/#objectifs-de-la-phase","title":"Objectifs de la phase","text":"<ul> <li>Choix des technologies : s\u00e9lection rigoureuse des solutions logicielles et mat\u00e9rielles (routeurs, serveurs, services r\u00e9seau, outils de supervision, etc.).</li> <li>D\u00e9ploiement de l'infrastructure : installation et configuration des services comme Active Directory, DNS, messagerie, VPN, Reverse Proxy, supervision, etc.</li> <li>S\u00e9curit\u00e9 int\u00e9gr\u00e9e : application des bonnes pratiques en cybers\u00e9curit\u00e9, segmentation r\u00e9seau, authentification renforc\u00e9e, politique de mot de passe, monitoring.</li> <li>Documentation technique : production de fiches techniques, guides d\u2019installation et de configuration pour assurer la maintenance et la reproductibilit\u00e9 du syst\u00e8me.</li> <li>Tests et validation : mise en \u0153uvre de sc\u00e9narios de test pour s'assurer du bon fonctionnement de l\u2019infrastructure.</li> </ul>"},{"location":"phase2/#composants-mis-en-uvre","title":"Composants mis en \u0153uvre","text":"<p>Voici quelques \u00e9l\u00e9ments cl\u00e9s de l\u2019infrastructure d\u00e9ploy\u00e9e :</p> <ul> <li>R\u00e9seau segment\u00e9 en trois zones : LAN, DMZ, SRV.</li> <li>Active Directory avec GPO pour gestion centralis\u00e9e des utilisateurs et des droits.</li> <li>Serveur VPN IPsec (Stormshield) int\u00e9gr\u00e9 \u00e0 l\u2019annuaire AD.</li> <li>Reverse Proxy NGINX jouant le r\u00f4le de WAF avec s\u00e9curisation HTTPS.</li> <li>Serveur de messagerie Postfix ou Nextcloud pour la collaboration.</li> <li>Supervision avec Zabbix / Prometheus, alertes configur\u00e9es.</li> <li>Infrastructure de certificats (PKI) pour s\u00e9curisation SSL/TLS.</li> <li>Outils d\u2019automatisation comme Ansible et Vagrant pour le provisioning.</li> </ul>"},{"location":"phase2/#livrables","title":"Livrables","text":"<ul> <li>Documentation technique compl\u00e8te : configuration des services, captures d\u2019\u00e9crans, explications des choix techniques.</li> <li>Scripts et fichiers de configuration (dans un d\u00e9p\u00f4t Git).</li> <li>Plans de tests et r\u00e9sultats des tests (acc\u00e8s, s\u00e9curit\u00e9, disponibilit\u00e9).</li> <li>Proc\u00e9dures de maintenance pour la p\u00e9rennit\u00e9 de l\u2019infrastructure.</li> </ul>"},{"location":"phase3/","title":"Int\u00e9gration de Wazuh dans l\u2019infrastructure itway","text":""},{"location":"phase3/#1-presentation-de-wazuh-dans-le-projet","title":"1. Pr\u00e9sentation de Wazuh dans le projet","text":""},{"location":"phase3/#1-quest-ce-que-loutil-wazuh","title":"1. Qu\u2019est-ce que l\u2019outil Wazuh ?","text":"<p>Dans le cadre de notre infrastructure r\u00e9seau s\u00e9curis\u00e9e virtualis\u00e9e sous GNS3, Wazuh joue un r\u00f4le cl\u00e9 dans la surveillance de la s\u00e9curit\u00e9, la d\u00e9tection d'intrusions, et le monitoring des postes et serveurs critiques (tels que l\u2019Active Directory, les serveurs expos\u00e9s dans la DMZ ou les h\u00f4tes internes Linux).  Il s\u2019int\u00e8gre comme un SIEM, permettant ainsi de collecter, analyser et corr\u00e9ler les logs, d\u00e9tecter des comportements suspects, assurer la conformit\u00e9, et r\u00e9agir en cas d\u2019anomalies.</p> <p>Wazuh se compose de trois \u00e9l\u00e9ments principaux :</p> <ul> <li>Wazuh Server : centralise les \u00e9v\u00e9nements, applique les r\u00e8gles, g\u00e8re les agents.  </li> <li>Wazuh Indexer : moteur de recherche bas\u00e9 sur OpenSearch pour stocker et interroger les \u00e9v\u00e9nements.  </li> <li>Wazuh Dashboard : interface web d\u2019administration et de visualisation.  </li> <li>Wazuh Agent : install\u00e9 sur chaque machine supervis\u00e9e (serveurs Linux/Windows) pour envoyer les logs au serveur.</li> </ul>"},{"location":"phase3/#2-pourquoi-isoler-wazuh-dans-un-vlan-dedie","title":"2. Pourquoi isoler Wazuh dans un vlan d\u00e9di\u00e9 ?","text":"<p>Le serveur Wazuh :</p> <ul> <li>centralise les logs de s\u00e9curit\u00e9,  </li> <li>contient des informations sensibles sur les machines surveill\u00e9es (journalisation, alertes, signatures d\u2019attaque, r\u00e8gles de d\u00e9tection),  </li> <li>poss\u00e8de des acc\u00e8s aux agents d\u00e9ploy\u00e9s sur l\u2019ensemble des serveurs.</li> </ul> <p>S\u2019il est compromis, c\u2019est toute la visibilit\u00e9 s\u00e9curit\u00e9 du SIEM qui est perdue.</p> <p>En l\u2019isolant dans un VLAN, on prot\u00e8ge ce n\u0153ud strat\u00e9gique de l\u2019infrastructure contre les mouvements lat\u00e9raux d\u2019attaquants internes, les infections non cibl\u00e9es ou les attaques directes depuis la DMZ ou d'autres zones \u00e0 risque.</p> <p>Cela permet \u00e9galement de contr\u00f4ler pr\u00e9cis\u00e9ment les flux autoris\u00e9s entre tous les VLAN de l\u2019infrasructure itway et le VLAN de Wazuh. Ainsi on peut configurer le pare-feu pour autoriser uniquement les communications de type agent \u2192 serveur Wazuh et interdire les connexions entrantes depuis toute autre source non autoris\u00e9e.</p>"},{"location":"phase3/#2-configuration-reseau-de-la-machine-wazuh","title":"2. Configuration r\u00e9seau de la machine Wazuh","text":"<p>La machine virtuelle h\u00e9bergeant la pile Wazuh est configur\u00e9e avec une IP statique afin d'assurer la fiabilit\u00e9 des communications avec les agents.</p> <p>Param\u00e8tres r\u00e9seau :</p> <ul> <li>Adresse IP : <code>172.16.60.4</code> </li> <li>Masque de sous-r\u00e9seau : <code>255.255.255.248</code> </li> <li>Passerelle : <code>172.16.60.1</code></li> </ul>"},{"location":"phase3/#test-de-connectivite-internet","title":"Test de connectivit\u00e9 Internet","text":"<pre><code>ping 8.8.8.8\n</code></pre>"},{"location":"phase3/#3-preparation-de-la-machine-wazuh-debianubuntu","title":"3. Pr\u00e9paration de la machine Wazuh (Debian/Ubuntu)","text":"<p>Avant d\u2019installer Wazuh, il est important de mettre \u00e0 jour le syst\u00e8me : <pre><code>sudo apt update  \nsudo apt upgrade\n</code></pre></p>"},{"location":"phase3/#4-installation-automatisee-de-wazuh-serveur-complet","title":"4. Installation automatis\u00e9e de Wazuh (serveur complet)","text":""},{"location":"phase3/#telechargement","title":"T\u00e9l\u00e9chargement :","text":"<p><pre><code>curl -sO https://packages.wazuh.com/4.12/wazuh-install.sh\n</code></pre> Ex\u00e9cution du script officiel :  <pre><code>bash wazuh-install.sh -a\n</code></pre></p> <p>Ce script :</p> <ul> <li>Installe toutes les d\u00e9pendances</li> <li>Configure les diff\u00e9rents services de Wazuh  (indexer, dashboard, serveur)</li> <li>D\u00e9marre les composants n\u00e9cessaires</li> </ul> <p>Fin de l\u2019installation : Voici la confirmation de l\u2019ach\u00e8vement de l\u2019installation et les identifiants de connexion <pre><code>29/05/2025 08:18:12 INFO: You can access the web interface https://&lt;wazuh-dashboard-ip&gt;:443\n    User: admin\n    Password: **********\n29/05/2025 08:18:12 INFO: Installation finished.\n</code></pre></p>"},{"location":"phase3/#5-connexion-a-linterface-web","title":"5. Connexion \u00e0 l\u2019interface web","text":"<p>Acc\u00e9der \u00e0 :  <pre><code>https://172.16.60.4:443\n</code></pre></p> <p>S'authentifier avec les identifiants fournis \u00e0 la fin de l\u2019installation.</p>"},{"location":"phase3/#6-integration-dun-poste-windows-ex-serveur-ad","title":"6. Int\u00e9gration d\u2019un poste Windows (ex. : serveur AD)","text":""},{"location":"phase3/#etapes-depuis-le-poste-windows","title":"\u00c9tapes depuis le poste Windows :","text":""},{"location":"phase3/#1-telecharger-lagent-msi-depuis-le-site-wazuh-linstaller-et-renseigner-lip-du-serveur-wazuh-puis-save","title":"1. T\u00e9l\u00e9charger l\u2019agent <code>.msi</code> depuis le site Wazuh, l\u2019installer et renseigner l\u2019ip du serveur Wazuh puis Save :","text":""},{"location":"phase3/#2-sur-linterface-graphique-du-serveur-renseigner-les-champs","title":"2. Sur l\u2019interface graphique du serveur, renseigner les champs :","text":"<ul> <li>Assign a server address : <code>itway.local</code> </li> <li>Select one or more existing groups : <code>default</code></li> </ul>"},{"location":"phase3/#3-copier-la-commande-en-bas-de-page-puis-demarrer-le-service-wazuh-en-la-collant-sur-le-terminal-du-serveur-windows","title":"3. Copier la commande en bas de page, puis d\u00e9marrer le service Wazuh en la collant sur le terminal du serveur Windows :","text":"<pre><code>NET START WazuhSvc\n</code></pre> <p>Le terminal indiquera que le service a d\u00e9marr\u00e9.</p>"},{"location":"phase3/#4-sur-la-fenetre-wazuh-agent-cliquer-sur-refresh-pour-faire-apparaitre-la-cle","title":"4. Sur la fen\u00eatre Wazuh Agent, cliquer sur Refresh pour faire appara\u00eetre la cl\u00e9 :","text":""},{"location":"phase3/#5-retourner-dans-linterface-web-de-wazuh-pour-verifier-lapparition-du-poste","title":"5. Retourner dans l\u2019interface web de Wazuh pour v\u00e9rifier l\u2019apparition du poste.","text":""},{"location":"phase3/#7-integration-dun-poste-linux","title":"7. Int\u00e9gration d\u2019un poste Linux","text":""},{"location":"phase3/#a-installation-de-gnupg","title":"a. Installation de GnuPG","text":"<pre><code>apt install gnupg\n</code></pre> <p>Cette commande utilise le gestionnaire de paquets apt pour installer GNU Privacy Guard, un outil de chiffrement et de signature permettant de g\u00e9rer des cl\u00e9s GPG. GnuPG est n\u00e9cessaire ici pour importer et v\u00e9rifier la cl\u00e9 GPG du d\u00e9p\u00f4t Wazuh, garantissant l'authenticit\u00e9 des paquets t\u00e9l\u00e9charg\u00e9s.</p>"},{"location":"phase3/#b-importation-de-la-cle-gpg-wazuh","title":"b. Importation de la cl\u00e9 GPG Wazuh","text":"<p><pre><code>curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | \\  \ngpg --no-default-keyring --keyring gnupg-ring:/tmp/wazuh.gpg --import\n</code></pre> Cette commande t\u00e9l\u00e9charge la cl\u00e9 GPG publique de Wazuh depuis leur site officiel \u00e0 l'aide de <code>curl -s</code> (en mode silencieux). La cl\u00e9 est ensuite import\u00e9e dans un trousseau temporaire nomm\u00e9 <code>/tmp/wazuh.gpg</code> en utilisant gpg. L'option <code>--no-default-keyring</code> emp\u00eache l'utilisation du trousseau par d\u00e9faut, et <code>--keyring gnupg-ring:/tmp/wazuh.gpg</code> sp\u00e9cifie un fichier temporaire pour stocker la cl\u00e9 import\u00e9e.</p>"},{"location":"phase3/#c-deplacement-et-permission-de-la-cle","title":"c. D\u00e9placement et permission de la cl\u00e9","text":"<p><pre><code>mv /tmp/wazuh.gpg /usr/share/keyrings/wazuh.gpg  \n</code></pre> Cette commande d\u00e9place le fichier temporaire <code>/tmp/wazuh.gpg</code> vers un emplacement standard pour les cl\u00e9s GPG, <code>/usr/share/keyrings/wazuh.gpg</code>, afin qu'il soit utilis\u00e9 par le syst\u00e8me pour v\u00e9rifier les paquets du d\u00e9p\u00f4t Wazuh. <pre><code>chmod 644 /usr/share/keyrings/wazuh.gpg\n</code></pre> Le <code>chmod</code> permet d\u2019appliquer les permissions 644 (lecture/\u00e9criture pour le propri\u00e9taire, lecture seule pour le groupe et les autres) pour garantir que le fichier est accessible de mani\u00e8re s\u00e9curis\u00e9e par le syst\u00e8me.</p>"},{"location":"phase3/#d-ajout-du-depot-wazuh","title":"d. Ajout du d\u00e9p\u00f4t Wazuh","text":"<p><pre><code>echo \"deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main\" \\  \n| tee /etc/apt/sources.list.d/wazuh.list\n</code></pre> Cette commande ajoute le d\u00e9p\u00f4t Wazuh \u00e0 la liste des sources de paquets du syst\u00e8me. La ligne <code>deb [signed-by=/usr/share/keyrings/wazuh.gpg]</code> sp\u00e9cifie que les paquets du d\u00e9p\u00f4t doivent \u00eatre v\u00e9rifi\u00e9s avec la cl\u00e9 GPG stock\u00e9e dans <code>/usr/share/keyrings/wazuh.gpg</code>. L'URL <code>https://packages.wazuh.com/4.x/apt/</code> stable main indique la source des paquets Wazuh pour la version 4.x. La commande tee \u00e9crit cette configuration dans le fichier /etc/apt/sources.list.d/wazuh.list.</p>"},{"location":"phase3/#e-mise-a-jour-des-depots-et-installation-de-lagent","title":"e. Mise \u00e0 jour des d\u00e9p\u00f4ts et installation de l\u2019agent","text":"<p><pre><code>apt update  \n</code></pre> Mise \u00e0 jour de la liste des paquets disponibles \u00e0 partir de tous les d\u00e9p\u00f4ts configur\u00e9s, y compris le d\u00e9p\u00f4t Wazuh nouvellement ajout\u00e9. <pre><code>WAZUH_MANAGER=\"172.16.60.4\" apt-get install wazuh-agent\n</code></pre> Cette commande d\u00e9finit la variable d\u2019environnement WAZUH_MANAGER avec l\u2019adresse IP du serveur Wazuh (172.16.60.4), qui sera utilis\u00e9e par l\u2019agent Wazuh pour communiquer avec le serveur. Ensuite, apt-get install wazuh-agent installe l\u2019agent Wazuh, qui permet la surveillance de s\u00e9curit\u00e9 et la collecte de journaux sur ce poste Linux.</p>"},{"location":"phase3/#f-activation-du-service","title":"f. Activation du service","text":"<p><pre><code>service wazuh-agent start\n</code></pre> Cette commande d\u00e9marre le service de l\u2019agent Wazuh sur le syst\u00e8me. Une fois d\u00e9marr\u00e9, l\u2019agent commence \u00e0 collecter des informations (journaux, \u00e9v\u00e9nements) et \u00e0 communiquer avec le serveur Wazuh sp\u00e9cifi\u00e9 dans la configuration. Cela active la surveillance en temps r\u00e9el.</p>"},{"location":"phase3/#g-ajout-du-module-docker-listener","title":"g. Ajout du module docker-listener","text":"<p>L\u2019infrastructure itway h\u00e9bergeant des conteneurs Docker, il est n\u00e9cessaire d\u2019activer le module docker listener pour activer leur supervision.</p> <p>Pour cel\u00e0 il faut \u00e9diter le fichier de configuration suivant : </p> <pre><code>nano /var/ossec/etc/ossec.conf\n</code></pre> <p>Ajouter \u00e0 la fin du fichier : <pre><code>&lt;ossec_config&gt;  \n  #active le module de surveillance des conteneurs Docker \n  &lt;wodle name=\"docker-listener\"&gt;\n    #d\u00e9finit la fr\u00e9quence de v\u00e9rification des conteneurs toutes les 10 minutes\n    &lt;interval&gt;10m&lt;/interval&gt;\n    #indique que Wazuh tentera 5 fois de se connecter \u00e0 l\u2019API Docker en cas d\u2019\u00e9chec  \n    &lt;attempts&gt;5&lt;/attempts&gt;\n    #lance le module d\u00e8s le d\u00e9marrage de l\u2019agent\n    &lt;run_on_start&gt;yes&lt;/run_on_start&gt;  \n    #active explicitement le module\n    &lt;disabled&gt;no&lt;/disabled&gt;  \n  &lt;/wodle&gt;  \n&lt;/ossec_config&gt;  \n</code></pre></p>"},{"location":"prerequis/","title":"Configuration des postes avant d\u00e9ploiement","text":"<p>Cette phase est essentielle pour garantir le bon fonctionnement de chaque poste. Avant de commencer, il est important de respecter le plan d\u2019adressage d\u00e9fini dans la section Infrastructure, afin d\u2019\u00e9viter tout conflit d\u2019adresses IP. </p>"},{"location":"prerequis/#configuration-dune-adresse-ip-statique-sur-chaque-machine","title":"Configuration d'une adresse IP statique sur chaque machine","text":"<p>Chaque machine de la DMZ doit \u00eatre configur\u00e9e avec une adresse IP statique pour assurer une connectivit\u00e9 stable.</p>"},{"location":"prerequis/#1-les-etapes-pour-acceder-a-la-configuration-reseau","title":"1. Les \u00e9tapes pour acc\u00e8der \u00e0 la configuration r\u00e9seau :","text":"<ol> <li>Se connecter sur la machine au switch d\u00e9di\u00e9 dans GNS3.</li> <li>Configurer la machine manuellement :<ul> <li>Clic droit sur la machine dans GNS3 \u2192 Configure.</li> <li>Aller dans l\u2019onglet General settings.</li> <li>Descendre jusqu\u2019\u00e0 Network configuration et cliquer sur Edit.</li> </ul> </li> </ol>"},{"location":"prerequis/#2-modification-du-fichier-de-configuration-reseau","title":"2. Modification du fichier de configuration r\u00e9seau","text":"<p>Ouvrir le fichier de configuration r\u00e9seau et activer l\u2019IP statique, comme dans l'exemple ci-dessous : <pre><code>iface eth0 inet static\n    address 10.10.10.2         # Adresse IP de la machine\n    netmask 255.255.255.240    # Masque de sous-r\u00e9seau\n    gateway 10.10.10.1         # Passerelle d\u00e9di\u00e9\n    # Le dns qui lui correspond (DMZ-DNS ici)\n    up echo \"nameserver 10.10.10.4\" &gt; /etc/resolv.conf \n    up echo \"nameserver 8.8.8.8\" &gt;&gt; /etc/resolv.conf\n</code></pre></p> <p>Remarque : Si un serveur DNS interne est utilis\u00e9, remplacer le dns pr\u00e9f\u00e9r\u00e9 par <code>172.16.50.2</code> (IP du serveur DNS local) et <code>8.8.8.8</code>.</p>"},{"location":"prerequis/#3-appliquer-les-modifications-et-tester-la-connexion","title":"3. Appliquer les modifications et tester la connexion","text":"<ol> <li> <p>Red\u00e9marrer l\u2019interface r\u00e9seau avec :     <pre><code>ip link set eth0 down\nip link set eth0 up\n</code></pre></p> </li> <li> <p>V\u00e9rifier l\u2019assignation IP :     <pre><code>ip a\n</code></pre></p> </li> <li> <p>Tester la connectivit\u00e9 :     <pre><code>ping 10.10.10.1    # Tester la communication avec la passerelle\nping 8.8.8.8         # Tester la connectivit\u00e9 Internet\n</code></pre></p> </li> </ol>"},{"location":"prerequis/#5-repeter-loperation-pour-les-autres-machines","title":"5. R\u00e9p\u00e9ter l\u2019op\u00e9ration pour les autres machines","text":"<ul> <li>Modifier l\u2019adresse IP pour chaque machine en respectant la plage d\u00e9finie.</li> <li>Assigner une IP unique pour \u00e9viter les conflits.</li> <li>V\u00e9rifier que chaque machine peut communiquer avec la passerelle et les autres \u00e9quipements.</li> </ul>"},{"location":"prerequis/#rendre-la-configuration-persistante","title":"Rendre la configuration persistante","text":"<p>Dans GNS3, les conteneurs Docker sont par d\u00e9faut \u00e9ph\u00e9m\u00e8res. Cela signifie que toute modification effectu\u00e9e \u00e0 l\u2019int\u00e9rieur (installation de paquets, fichiers cr\u00e9\u00e9s, configurations r\u00e9seau\u2026) est perdue au red\u00e9marrage si elle n\u2019est pas explicitement sauvegard\u00e9e.</p> <p>Activer la persistance, c\u2019est dire \u00e0 GNS3 quels dossiers doivent \u00eatre conserv\u00e9s m\u00eame apr\u00e8s arr\u00eat ou red\u00e9marrage du conteneur.</p> <ol> <li>Faire un clic droit sur la machine, ensuite cliquer sur \"Configure\"</li> <li>Dans l'onglet \"Advanced\" nous avons le second champ qui nous renseigne : \"Additional directories to make persistent that are not included in the image VOLUMES config. One directory per line.\"</li> <li>Ajouter les r\u00e9pertoires suivants : <pre><code>/bin\n/boot\n/etc\n/gns3\n/home\n/lib\n/lib64\n/media\n/mnt\n/opt\n/root\n/run\n/sbin\n/srv\n/tmp\n/usr\n/var\n</code></pre></li> </ol>"},{"location":"prerequis/#installation-openssh-server","title":"Installation OpenSSH Server","text":"<p>Configurer l'acc\u00e8s SSH sur chaque machine pour permettre l\u2019automatisation via Ansible, de mani\u00e8re s\u00e9curis\u00e9e et persistante.</p>"},{"location":"prerequis/#1-ouvrir-la-console-du-conteneur-dans-gns3","title":"1. Ouvrir la console du conteneur dans GNS3","text":"<ol> <li>Lancer le conteneur dans GNS3.</li> <li>Faire un clic droit &gt; Console.</li> <li>Le shell s'ouvre avec utilisateur par d\u00e9faut <code>root</code> directement.</li> </ol>"},{"location":"prerequis/#2-installation-du-serveur-ssh","title":"2. Installation du serveur SSH","text":"<p>Depuis la console du conteneur entrer les commandes suivantes pour installer le service SSH (fichier binaire <code>sshd</code>) et les d\u00e9pendances : <pre><code>apt update \napt install openssh-server -y\n</code></pre></p>"},{"location":"prerequis/#3-verifier-et-demarrer-le-service-ssh","title":"3. V\u00e9rifier (et d\u00e9marrer) le service SSH","text":"<pre><code>service ssh start\n</code></pre>"},{"location":"prerequis/#4-attribuer-un-mot-de-passe-root","title":"4. Attribuer un mot de passe <code>root</code>","text":"<p>Souvent dans Docker, le compte <code>root</code> n\u2019a pas de mot de passe, pour \u00e9viter des erreurs et des probl\u00e8mes avec ssh et ansible alors on modifie cela. Pour en mettre un : <pre><code>passwd root\n</code></pre></p> <p>Il nous sera demand\u00e9 de saisir puis confirmer un mot de passe.</p>"},{"location":"prerequis/#5-creer-un-un-autre-utilisateur-pour-ansible","title":"5. Cr\u00e9er un un autre utilisateur pour Ansible","text":""},{"location":"prerequis/#pourquoi","title":"Pourquoi ?","text":"<p>Le fait d\u2019autoriser une connexion SSH directe en tant que root est g\u00e9n\u00e9ralement consid\u00e9r\u00e9 comme moins s\u00e9curis\u00e9 pour plusieurs raisons :</p> <ul> <li>Surface d\u2019attaque plus large : S\u2019il est compromis l\u2019attaquant dispose imm\u00e9diatement de tous les droits.</li> <li>Cible \u00e9vidente : brute force sur utilisateur \"root\".</li> <li>Moins de tra\u00e7abilit\u00e9 : Dans le journal des logs seul l'utilisateur <code>root</code> est utilis\u00e9, ce qui ne permet pas d'identifier qui a effectuer quelles actions.</li> </ul>"},{"location":"prerequis/#creer-un-utilisateur-standard-avec-droits-sudo","title":"Cr\u00e9er un utilisateur standard avec droits <code>sudo</code>","text":"<pre><code>adduser ansible\nusermod -aG sudo ansible\n</code></pre>"},{"location":"prerequis/#desactiver-lauthentification-root-par-mot-de-passe","title":"D\u00e9sactiver l\u2019authentification <code>root</code> par mot de passe","text":"<p>Dans le fichier de configuration SSH (<code>/etc/ssh/sshd_config</code>) d\u00e9-commenter la ligne suivante et la modifier pour interdire compl\u00e8tement la connexion SSH directe de root (m\u00eame via une cl\u00e9) : <pre><code>PermitRootLogin no\n</code></pre></p> <p>Cela force l\u2019utilisation d\u2019un autre utilisateur pour la connexion SSH, ou impose l\u2019usage d\u2019une cl\u00e9 SSH s\u2019il faut malgr\u00e9 tout se connecter en <code>root</code>.</p> <p>Red\u00e9marrer le service : <pre><code>service ssh restart\n</code></pre></p>"},{"location":"prerequis/#installation-sudo","title":"Installation <code>sudo</code>","text":"<p>Par d\u00e9faut, dans beaucoup de conteneurs Docker (comme ceux utilis\u00e9s dans GNS3), sudo n\u2019est pas install\u00e9 car on y est souvent connect\u00e9 directement en tant que root. Mais pour des raisons de s\u00e9curit\u00e9 et de bonnes pratiques, nous avons choisi de :</p> <ul> <li>Cr\u00e9er un utilisateur non-root (ansible)</li> <li>D\u00e9sactiver l'acc\u00e8s SSH direct au compte <code>root</code></li> </ul> <p>Mais l'utilisateur aura besoin de droits administratifs. C\u2019est l\u00e0 qu\u2019intervient <code>sudo</code>, il permet \u00e0 un utilisateur standard (comme <code>ansible</code>) d'ex\u00e9cuter des commandes avec les privil\u00e8ges <code>root</code>, sans devoir se connecter en <code>root</code>.</p>"},{"location":"prerequis/#on-installe-sudo-sur-la-machine-distante","title":"On installe sudo sur la machine distante :","text":"<pre><code>apt install sudo \n</code></pre>"},{"location":"prerequis/#on-edite-la-configuration-sudo-via-visudo-sur-la-machine-distante","title":"On \u00e9dite la configuration sudo via <code>visudo</code> sur la machine distante :","text":"<pre><code>visudo\n</code></pre>"},{"location":"prerequis/#ajouter-la-ligne-suivante-a-la-fin-du-fichier","title":"Ajouter la ligne suivante \u00e0 la fin du fichier :","text":"<p><pre><code>ansible ALL=(ALL) NOPASSWD: ALL\n</code></pre> Cela permet \u00e0 Ansible d\u2019ex\u00e9cuter des commandes sudo sans mot de passe.</p>"},{"location":"prerequis/#configuration-ssh","title":"Configuration SSH","text":""},{"location":"prerequis/#a-quoi-ca-sert-exactement-ce-fichier-sshconfig","title":"\u00c0 quoi \u00e7a sert exactement ce fichier <code>~/.ssh/config</code> ?","text":"<p>Ce fichier permet de pr\u00e9configurer des connexions SSH, en donnant un nom court (alias) \u00e0 chaque machine, avec : - son adresse IP ou nom de domaine (<code>HostName</code>) - l\u2019utilisateur par d\u00e9faut (<code>User</code>) - la cl\u00e9 \u00e0 utiliser (<code>IdentityFile</code>) - et plein d\u2019autres options utiles (port, compression, etc.)</p>"},{"location":"prerequis/#1-cree-et-remplir-le-fichier-config","title":"1. Cr\u00e9\u00e9 et remplir le fichier <code>config</code>","text":"<p>J'\u00e9cris dans <code>~/.ssh/config</code> (sur la machine IT-ANSIBLE) :</p> <pre><code>Host dmz-smtp\n  HostName 10.10.10.2\n  User ansible\n  IdentityFile ~/.ssh/id_ed25519\n\nHost dmz-dns\n  HostName 10.10.10.3\n  User ansible\n  IdentityFile ~/.ssh/id_ed25519\n\nHost dmz-web\n  HostName 10.10.10.4\n  User ansible\n  IdentityFile ~/.ssh/id_ed25519\n\n...\n</code></pre>"},{"location":"prerequis/#2-verifier-les-permissions","title":"2. V\u00e9rifier les permissions","text":"<p>SSH exige que ce fichier ait les bonnes permissions : <pre><code>chmod 600 ~/.ssh/config\n</code></pre></p>"},{"location":"prerequis/#sans-ce-fichier","title":"Sans ce fichier","text":"<p>On doit taper la commande longue \u00e0 chaque fois : <pre><code>ssh -i ~/.ssh/id_ed25519 ansible@10.10.10.2\n</code></pre></p>"},{"location":"prerequis/#avec-ce-fichier","title":"Avec ce fichier","text":"<p>On peut taper : <pre><code>ssh dmz-smtp\n</code></pre></p> <p>SSH saura automatiquement : - Quelle IP utiliser - Quel utilisateur - Quelle cl\u00e9 utiliser</p>"},{"location":"prerequis/#script-de-demarrage-automatique-pour-les-conteneurs","title":"Script de d\u00e9marrage automatique pour les conteneurs","text":"<p>Le script suivant est utilis\u00e9 pour initialiser automatiquement certains services (comme SSH, Grafana, Prometheus) et s'assurer que les droits sur sudo sont correctement configur\u00e9s \u00e0 chaque d\u00e9marrage du conteneur. <pre><code>#!/bin/sh\n# run docker startup, first arg is new PATH, remainder is command\n\nPATH=\"$1\"         # Le premier argument est utilis\u00e9 comme nouvelle valeur de la variable d\u2019environnement PATH\nshift             # On d\u00e9cale les arguments pour ex\u00e9cuter la vraie commande apr\u00e8s\n\n# S'assurer que sudo appartient \u00e0 root et a les bons droits\nchown root:root /usr/bin/sudo \nchmod 4755 /usr/bin/sudo\n\n# D\u00e9marrer les services n\u00e9cessaires\n\n# Lancer la commande par d\u00e9faut du conteneur\nexec \"$@\"\n</code></pre></p>"},{"location":"routeurs/","title":"Configuration des Routeurs","text":""},{"location":"routeurs/#role-des-routeurs-dans-linfrastructure","title":"R\u00f4le des routeurs dans l'infrastructure","text":"<p>Dans le cadre de l\u2019infrastructure ITWay, nous avons utilis\u00e9 deux routeurs principaux :</p> <ul> <li>CORE-RT : routeur central connect\u00e9 \u00e0 tous les sous-r\u00e9seaux internes,</li> <li>DMZ-RT : routeur de la DMZ, isol\u00e9 du reste du r\u00e9seau pour s\u00e9curiser les services expos\u00e9s \u00e0 Internet.</li> </ul> <p>Ces routeurs sont essentiels pour :</p> <ul> <li>Segmenter les diff\u00e9rents r\u00e9seaux (IT, SRV, DMZ, LAN\u2026),</li> <li>Appliquer des politiques de filtrage strictes,</li> <li>G\u00e9rer le routage entre les sous-r\u00e9seaux internes,</li> <li>Assurer la s\u00e9curit\u00e9 gr\u00e2ce \u00e0 la configuration des ACLs, NAT, VPN, etc.</li> </ul>"},{"location":"routeurs/#routeur-core-rt-stormshield-eva","title":"Routeur CORE-RT (Stormshield EVA)","text":"<p>Fonctions principales :</p> <ul> <li>Connexion entre tous les sous-r\u00e9seaux internes</li> <li>Fourniture de la passerelle par d\u00e9faut</li> <li>Configuration des VLANs et du plan d\u2019adressage</li> <li>Politique de filtrage entre zones</li> <li>Gestion du VPN SSL pour l\u2019acc\u00e8s distant</li> </ul> <p>Exemples de configuration appliqu\u00e9e :</p> <ul> <li>Interfaces VLAN configur\u00e9es pour chaque r\u00e9seau (IT-NET, SRV-NET, DMZ-TUNNEL, etc.)</li> <li>Routage inter-VLAN activ\u00e9</li> <li>VPN SSL accessible depuis vpn.itway.fr</li> <li>NAT pour la DMZ et les services internes</li> <li>Filtrage Web/SSH accessible uniquement depuis IT-NET</li> <li>Authentification admin via Active Directory (GRP-SECU-IT)</li> </ul> <p>S\u00e9curit\u00e9 appliqu\u00e9e :</p> <ul> <li>Acc\u00e8s Web/SSH uniquement depuis le r\u00e9seau IT</li> <li>VPN SSL authentifi\u00e9 via certificats internes</li> <li>Interfaces d\u2019administration restreintes</li> <li>Politique par d\u00e9faut : tout trafic entrant bloqu\u00e9</li> <li>Protocoles ICMP autoris\u00e9s dans les deux sens</li> <li>Certificats sign\u00e9s par le serveur PKI (SRV-PKI)</li> </ul>"},{"location":"routeurs/#routeur-dmz-rt-stormshield-eva","title":"Routeur DMZ-RT (Stormshield EVA)","text":"<p>Fonctions principales :</p> <ul> <li>S\u00e9parer le r\u00e9seau DMZ du r\u00e9seau interne</li> <li>Assurer la communication vers Internet</li> <li>Appliquer des r\u00e8gles de filtrage renforc\u00e9es</li> </ul> <p>Principes appliqu\u00e9s :</p> <ul> <li>Aucun acc\u00e8s de la DMZ vers l\u2019interne sauf exceptions justifi\u00e9es (SMTP vers SRV-MAIL par exemple)</li> <li>Interfaces d\u2019administration accessibles uniquement depuis IT-NET</li> <li>NAT configur\u00e9 pour les services publics (Web, Mail, etc.)</li> </ul>"},{"location":"routeurs/#conclusion","title":"Conclusion","text":"<p>Les routeurs Stormshield ont \u00e9t\u00e9 configur\u00e9s pour garantir compartimentage, s\u00e9curit\u00e9 des flux, et gestion centralis\u00e9e. Leur int\u00e9gration dans GNS3 a permis de tester et valider toutes les r\u00e8gles avant mise en production simul\u00e9e.</p>"},{"location":"structuredoc/","title":"Structuredoc","text":""},{"location":"structuredoc/#structure-de-documentation-machine-nom","title":"\ud83d\udcd8 Structure de documentation \u2013 Machine [NOM]","text":""},{"location":"structuredoc/#1-objectif-de-la-machine","title":"1. Objectif de la machine","text":"<p>D\u00e9finir clairement le r\u00f4le de la machine dans l'infrastructure. (Ex : Serveur DNS, Contr\u00f4leur de domaine, Reverse Proxy, etc.)</p>"},{"location":"structuredoc/#2-presentation-du-service","title":"2. Pr\u00e9sentation du service","text":"<p>Expliquer de quoi il s'agit (le principe du service ou du logiciel principal utilis\u00e9). (Ex : Ansible = outil d'automatisation, DNS = r\u00e9solution de noms, etc.)</p>"},{"location":"structuredoc/#3-solutions-choisies","title":"3. Solutions choisies","text":"<ul> <li>Logiciels/technologies utilis\u00e9s (et versions)</li> <li>Raisons du choix (simplicit\u00e9, compatibilit\u00e9, s\u00e9curit\u00e9, etc.)</li> </ul>"},{"location":"structuredoc/#4-methodologie-de-mise-en-place","title":"4. M\u00e9thodologie de mise en place","text":"<p>D\u00e9roulement chronologique de l\u2019installation et de la configuration :</p> <ul> <li>Installation de l\u2019OS</li> <li>Installation des services</li> <li>Structuration du syst\u00e8me</li> </ul>"},{"location":"structuredoc/#5-detail-de-la-configuration-par-blocs-logiques","title":"5. D\u00e9tail de la configuration (par blocs logiques)","text":"<p>Divis\u00e9 par parties selon les fichiers ou modules de configuration :</p> <ul> <li>Exemple : <code>/etc/bind/named.conf.options</code></li> <li>Exemple : configuration LDAP pour l'intranet</li> <li>Exemple : r\u00e8gles de pare-feu</li> </ul>"},{"location":"structuredoc/#6-gestion-de-la-securite","title":"6. Gestion de la s\u00e9curit\u00e9","text":"<ul> <li>Mesures mises en place (authentification, certificats, acc\u00e8s restreints, etc.)</li> <li>VLANs et r\u00e8gles de communication</li> <li>Int\u00e9gration au syst\u00e8me global de s\u00e9curit\u00e9</li> </ul>"},{"location":"structuredoc/#7-problemes-rencontres-et-solutions-apportees","title":"7. Probl\u00e8mes rencontr\u00e9s et solutions apport\u00e9es","text":"<ul> <li>Description des erreurs rencontr\u00e9es</li> <li>Raisons et analyse</li> <li>R\u00e9solution ou contournement</li> </ul>"},{"location":"structuredoc/#8-supervision-et-maintenance","title":"8. Supervision et maintenance","text":"<ul> <li>Outils de monitoring utilis\u00e9s</li> <li>Fichiers/journaux \u00e0 surveiller</li> <li>Proc\u00e9dures de sauvegarde ou d\u2019administration</li> </ul>"},{"location":"structuredoc/#9-conclusion","title":"9. Conclusion","text":"<ul> <li>R\u00e9sultat obtenu</li> <li>Points d\u2019am\u00e9lioration potentiels</li> <li>Retour d\u2019exp\u00e9rience</li> </ul> <p>Avec cette structure, tu assures :</p> <ul> <li>Une coh\u00e9rence pour chaque machine</li> <li>Un aper\u00e7u clair pour chaque lecteur</li> <li>Une base solide pour les livrables \u00e0 rendre</li> </ul>"},{"location":"dmz/dmz/","title":"DMZ","text":""},{"location":"dmz/dmz/#dmz-zone-demilitarisee","title":"DMZ \u2013 Zone D\u00e9militaris\u00e9e","text":""},{"location":"dmz/dmz/#1-en-quoi-consiste-la-dmz","title":"1. En quoi consiste la DMZ ?","text":"<p>La DMZ (Demilitarized Zone) est une zone r\u00e9seau interm\u00e9diaire entre Internet et le r\u00e9seau interne de l\u2019entreprise. Son r\u00f4le principal est de prot\u00e9ger l\u2019infrastructure interne tout en permettant l\u2019acc\u00e8s public \u00e0 certains services.</p> <p>Elle sert de barri\u00e8re de s\u00e9curit\u00e9 pour exposer uniquement les services n\u00e9cessaires (web, DNS, SMTP\u2026) \u00e0 Internet tout en isolant les serveurs internes sensibles.</p>"},{"location":"dmz/dmz/#2-objectifs-de-la-dmz-dans-le-projet-it-way","title":"2. Objectifs de la DMZ dans le projet IT-WAY","text":"<ul> <li>H\u00e9berger les services accessibles depuis Internet</li> <li>Garantir une s\u00e9paration stricte avec les r\u00e9seaux internes</li> <li>Appliquer des r\u00e8gles de filtrage et de contr\u00f4le des flux r\u00e9seau</li> <li>Limiter les risques en cas de compromission d\u2019un service public</li> </ul>"},{"location":"dmz/dmz/#3-services-presents-dans-la-dmz","title":"3. Services pr\u00e9sents dans la DMZ","text":"Nom d\u2019h\u00f4te R\u00f4le Domaine DMZ-RPROXY Reverse Proxy pour les services web itway.fr / webmail.itway.fr DMZ-WEB Serveur web public WordPress (vitrine) itway.fr / dmz-web.int.itway.fr DMZ-DNS Serveur DNS public pour la zone itway.fr dns.itway.fr DMZ-SMTP Serveur relais mail (entr\u00e9e/sortie) mail.itway.fr DMZ-RT Routeur DMZ (Stormshield EVA) dmz-rt.int.itway.fr"},{"location":"dmz/dmz/#4-adressage-ip-reseau-dmz","title":"4. Adressage IP \u2013 R\u00e9seau DMZ","text":"<p>Nous avons choisi le plan d\u2019adressage 10.10.10.0/24 pour le r\u00e9seau DMZ, en coh\u00e9rence avec les autres sous-r\u00e9seaux de l\u2019infrastructure IT-WAY.</p> Machine Adresse IP Interface accessible DMZ-RPROXY 10.10.10.5 Internet, Interne DMZ-WEB 10.10.10.2 Internet, Interne DMZ-DNS 10.10.10.4 Internet, Interne DMZ-SMTP 10.10.10.3 Internet, Interne DMZ-RT 10.10.10.1 Connexion vers CORE-RT et Internet"},{"location":"dmz/dmz/#5-resume-technique","title":"5. R\u00e9sum\u00e9 technique","text":"<ul> <li>Routage filtr\u00e9 via DMZ-RT \u2192 CORE-RT</li> <li>Chaque serveur dispose d\u2019un certificat TLS sign\u00e9 par la PKI interne</li> <li>Tous les acc\u00e8s en SSH ou administration se font depuis IT-NET uniquement</li> <li>Zone DNS distincte pour <code>int.itway.fr</code> non expos\u00e9e \u00e0 Internet</li> </ul>"},{"location":"dmz/dns/","title":"Serveur DNS (<code>dmz-dns.itway.fr</code>)","text":"<p>Playbook Ansible complet</p>"},{"location":"dmz/dns/#1-objectifs","title":"1. Objectifs","text":"<p>L'objectif du DNS dans le projet :</p> <ul> <li>D\u00e9ployer un serveur DNS public dans la DMZ nomm\u00e9 <code>dmz-dns.itway.fr</code>.</li> <li>Ce serveur g\u00e8re la r\u00e9solution DNS de la zone publique <code>itway.fr</code> ainsi que de la zone interne <code>int.itway.fr</code>.</li> <li>La zone itway.fr doit \u00eatre accessible depuis Internet.</li> <li>La zone int.itway.fr est strictement priv\u00e9e, non expos\u00e9e.</li> <li>Aucune communication entre DNS interne et DMZ n\u2019est autoris\u00e9e.</li> <li>L\u2019outil choisi est BIND9, d\u00e9ploy\u00e9 automatiquement via Ansible.</li> </ul>"},{"location":"dmz/dns/#2-dns-domain-name-system","title":"2. DNS (Domain Name System)","text":""},{"location":"dmz/dns/#21-cest-quoi-un-dns","title":"2.1  C'est quoi un DNS","text":"<p>C\u2019est le \"r\u00e9pertoire t\u00e9l\u00e9phonique d\u2019Internet\".</p> <p>Il sert \u00e0 traduire des noms de domaine lisibles par l\u2019homme (comme google.com ou itway.fr) en adresses IP (comme 142.250.74.238), que les ordinateurs utilisent pour communiquer.</p>"},{"location":"dmz/dns/#22-pourquoi-on-a-besoin-du-dns-dans-le-projet","title":"2.2 Pourquoi on a besoin du DNS dans le projet","text":"<p>On doit cr\u00e9er un serveur DNS dans la DMZ, accessible depuis Internet et les r\u00e9seaux internes de confiance.</p> <p>Il sert \u00e0 :</p> Domaine demand\u00e9 Ce qu\u2019il renvoie O\u00f9 \u00e7a sert <code>itway.fr</code> adresse IP du reverse proxy sur Internet <code>webmail.itway.fr</code> adresse IP du mail ou proxy sur Internet et internes <code>dmz-web.int.itway.fr</code> IP du serveur web priv\u00e9 uniquement r\u00e9seau interne <code>dmz-rt.int.itway.fr</code> IP du routeur priv\u00e9 uniquement interne"},{"location":"dmz/dns/#3-ce-que-fait-le-dmz-dns-dans-itway","title":"3 Ce que fait le DMZ-DNS dans ITWAY","text":"<ol> <li>R\u00e9pondre aux requ\u00eates DNS publiques pour itway.fr (serveur dans DMZ)</li> <li>R\u00e9pondre aux requ\u00eates DNS priv\u00e9es pour int.itway.fr (mais uniquement pour les internes)</li> <li>Ne pas laisser les zones internes visibles depuis Internet</li> <li>Ne pas communiquer avec le DNS interne pour \u00e9viter les fuites de donn\u00e9es</li> </ol>"},{"location":"dmz/dns/#4-justification-des-choix","title":"4. Justification des choix","text":"\u00c9l\u00e9ment Choix effectu\u00e9 Raisons Serveur DNS BIND9 R\u00e9f\u00e9rence open-source, tr\u00e8s flexible, bien document\u00e9e Automatisation Ansible + r\u00f4les + Jinja2 R\u00e9utilisable, versionnable, idempotent Organisation R\u00f4les s\u00e9par\u00e9s (<code>dmz-dns</code>) Isolation de la logique m\u00e9tier et clart\u00e9 S\u00e9curit\u00e9 R\u00e9cursion restreinte, pas de transfert de zone, DNSSEC R\u00e9duction des vecteurs d\u2019attaque"},{"location":"dmz/dns/#5-structure-du-projet-ansible","title":"5. Structure du projet Ansible","text":"<pre><code>.\n\u251c\u2500\u2500 inventory/\n\u2502   \u2514\u2500\u2500 hosts.ini\n\u251c\u2500\u2500 playbooks/\n\u2502   \u2514\u2500\u2500 setup-dmz-dns.yml\n\u2514\u2500\u2500 roles/\n    \u2514\u2500\u2500 dmz-dns/\n        \u251c\u2500\u2500 tasks/\n        \u2502   \u2514\u2500\u2500 main.yml\n        \u251c\u2500\u2500 handlers/\n        \u2502   \u2514\u2500\u2500 main.yml\n        \u251c\u2500\u2500 templates/\n        \u2502   \u251c\u2500\u2500 named.conf.local.j2\n        \u2502   \u251c\u2500\u2500 named.conf.options.j2\n        \u2502   \u251c\u2500\u2500 db.itway.fr.j2\n        \u2502   \u251c\u2500\u2500 db.int.itway.fr.j2\n        \u2502   \u2514\u2500\u2500 db.10.10.10.rev.j2\n</code></pre>"},{"location":"dmz/dns/#6-ce-que-le-playbook-execute-dans-dmz-dns","title":"6. Ce que le Playbook execute dans <code>dmz-dns</code>","text":"<p>Vous pouvez visiter les playbook ici.</p>"},{"location":"dmz/dns/#explication-du-role-du-playbook-etape-par-etape","title":"Explication du r\u00f4le du playbook \u00e9tape par \u00e9tape","text":"<ol> <li>Installation de Bind9 : Installer Bind9 et les paquets n\u00e9cessaires.</li> <li>D\u00e9ploiement de la configuration locale : D\u00e9clarer les zones DNS \u00e0 g\u00e9rer. (Plus en d\u00e9tail)</li> <li>D\u00e9ploiement des options globales : Configurer les forwarders, la r\u00e9cursion, les IPs autoris\u00e9es, etc. (Plus en d\u00e9tail)</li> <li>Fichiers de zone : Configurer le fichier de zone (SOA, CNAME, MX, TXT). (Plus en d\u00e9tail)</li> <li>Zone interne (priv\u00e9e) :  Configurer le fichier de zone interne \"Intranet\" (SOA, CNAME, MX, TXT). (Plus en d\u00e9tail)</li> <li>Zone de r\u00e9solution invers\u00e9e (Plus en d\u00e9tail)</li> <li>V\u00e9rification de Bind9 : V\u00e9rifier que Bind9 tourne correctement.</li> <li>D\u00e9marrage conditionnel : Red\u00e9marrage de Bind9</li> </ol>"},{"location":"dmz/dns/#7-fichiers-de-configuration","title":"7. Fichiers de configuration","text":""},{"location":"dmz/dns/#71-namedconfoptionsj2","title":"7.1 <code>named.conf.options.j2</code>","text":"<p>Le fichier <code>named.conf.options.j2</code> d\u00e9finit les options globales de configuration du serveur BIND. Il est utilis\u00e9 pour r\u00e9gler des param\u00e8tres g\u00e9n\u00e9raux comme :</p> <ul> <li>O\u00f9 se trouve le cache,</li> <li>Quels serveurs DNS sont utilis\u00e9s comme relais (forwarders),</li> <li>Qui est autoris\u00e9 \u00e0 poser des questions r\u00e9cursives (r\u00e9cursion DNS),</li> <li>Les comportements r\u00e9seau (interfaces, IPv6, s\u00e9curit\u00e9, etc.).</li> </ul>"},{"location":"dmz/dns/#contenu-du-fichiers","title":"Contenu du fichiers","text":"<pre><code>options {\n    directory \"/var/cache/bind\";\n\n    // Forward DNS non g\u00e9r\u00e9s vers l\u2019ext\u00e9rieur\n    forwarders { 8.8.8.8; 8.8.4.4; };\n\n    // Autoriser la r\u00e9cursion UNIQUEMENT \u00e0 nos r\u00e9seaux internes :\n    allow-recursion {\n        10.10.10.0/28;      // DMZ\n        172.16.10.0/27;     // IT           \n        172.16.50.0/29;     // SRV         \n        172.16.85.0/27;     // NET-SRV   \n        10.11.11.0/30;      // STORM-NET \n        192.168.20.0/28;    // VLAN 20   \n        192.168.30.0/28;    // VLAN 30   \n        192.168.40.0/26;    // VLAN 40   \n    };\n\n    recursion yes;               // mais uniquement pour les r\u00e9seaux list\u00e9s\n    allow-transfer { none; };    // bloque les transferts de zones (s\u00e9curit\u00e9)\n    dnssec-validation auto;      // active la validation DNSSEC (si utilis\u00e9)\n    listen-on { any; };          // \u00e9coute toutes les interfaces IPv4\n    listen-on-v6 { any; };       // \u00e9coute toutes les interfaces IPv6\n};\n</code></pre>"},{"location":"dmz/dns/#explication","title":"Explication","text":"Ligne \u00c9l\u00e9ment Explication <code>directory \"/var/cache/bind\";</code> Cache DNS Emplacement o\u00f9 BIND stocke son cache de requ\u00eates DNS. <code>forwarders { 8.8.8.8; 8.8.4.4; };</code> Redirecteurs DNS Si le serveur ne conna\u00eet pas la r\u00e9ponse, il la demande \u00e0 ces serveurs DNS (Google DNS). <code>allow-recursion { ... };</code> Contr\u00f4le d'acc\u00e8s Limite les requ\u00eates r\u00e9cursives aux adresses IP internes uniquement. Cela \u00e9vite que le serveur soit utilis\u00e9 comme un DNS ouvert (faille de s\u00e9curit\u00e9). <code>recursion yes;</code> R\u00e9cursion activ\u00e9e Autorise la r\u00e9cursion DNS (n\u00e9cessaire pour les clients internes), mais seulement pour les IP list\u00e9es ci-dessus. <code>allow-transfer { none; };</code> S\u00e9curit\u00e9 zone DNS Interdit les transferts de zone (AXFR) aux autres serveurs DNS \u2192 protection contre la copie de donn\u00e9es. <code>dnssec-validation auto;</code> S\u00e9curit\u00e9 DNSSEC Active automatiquement la validation de DNSSEC (si disponible). Cela permet de v\u00e9rifier l'authenticit\u00e9 des r\u00e9ponses DNS. <code>listen-on { any; };</code> Interfaces IPv4 Le serveur DNS \u00e9coute sur toutes les interfaces r\u00e9seau IPv4. <code>listen-on-v6 { any; };</code> Interfaces IPv6 Idem pour IPv6."},{"location":"dmz/dns/#72-namedconflocalj2","title":"7.2 <code>named.conf.local.j2</code>","text":"<p>Le fichier <code>named.conf.local.j2</code> contient la d\u00e9claration des zones DNS dont le serveur BIND est ma\u00eetre (master). C\u2019est ici qu'on lies chaque domaine DNS \u00e0 son fichier de donn\u00e9es (fichier de zone).</p> <p>Il joue un r\u00f4le fondamental : sans ce fichier, le serveur DNS ne saurait pas quelles zones il doit g\u00e9rer, ni o\u00f9 trouver leurs enregistrements.</p> <p>Ce fichier est un template Ansible (.j2), qui sera transform\u00e9 \u00e0 l\u2019ex\u00e9cution en <code>/etc/bind/named.conf.local</code>.</p>"},{"location":"dmz/dns/#contenu","title":"Contenu","text":"<pre><code>//\n// named.conf.local\n//\n\n// Vue publique (zone expos\u00e9e)\nzone \"itway.fr\" {\n    type master;\n    file \"/etc/bind/db.itway.fr\";\n    allow-transfer { none; };\n};\n\n// Interne uniquement (zone priv\u00e9e)\nzone \"int.itway.fr\" {\n    type master;\n    file \"/etc/bind/db.int.itway.fr\";\n    allow-transfer { none; };\n};\n\nzone \"10.10.10.in-addr.arpa\" {\n    type master;\n    file \"/etc/bind/db.10.10.10.rev\";\n    allow-transfer { none; };\n};\n</code></pre>"},{"location":"dmz/dns/#declarations-des-zones","title":"D\u00e9clarations des zones :","text":""},{"location":"dmz/dns/#quest-ce-quun-fichier-de-zone-dns","title":"Qu'est-ce qu'un fichier de Zone DNS ?","text":"<p>Un fichier de zone d\u00e9crit tous les enregistrements DNS pour un domaine donn\u00e9. Par exemple : db.itway.fr est le fichier de zone pour le domaine itway.fr.</p> <ul> <li>Publique <code>itway.fr</code> :</li> </ul> \u00c9l\u00e9ment Signification <code>zone \"itway.fr\"</code> D\u00e9clare que le serveur g\u00e8re la zone <code>itway.fr</code> <code>type master;</code> Le serveur est ma\u00eetre (responsable principal) pour cette zone <code>file \"/etc/bind/db.itway.fr\"</code> Le fichier de zone contenant les enregistrements se trouve \u00e0 cette adresse <code>allow-transfer { none; };</code> Interdit tout transfert de zone \u00e0 d'autres serveurs DNS (protection contre la copie ou les fuites DNS) <p>Cette zone est publique : elle contient des noms accessibles depuis Internet (www.itway.fr, mail.itway.fr, etc.).</p> <ul> <li>Priv\u00e9e <code>int.itway.fr</code> :</li> </ul> \u00c9l\u00e9ment Signification <code>zone \"int.itway.fr\"</code> D\u00e9clare la zone DNS priv\u00e9e interne <code>type master;</code> Le serveur est aussi ma\u00eetre ici <code>file \"/etc/bind/db.int.itway.fr\"</code> Fichier contenant les noms internes (<code>dmz-web.int.itway.fr</code>, etc.) <code>allow-transfer { none; };</code> Toujours interdit, pour s\u00e9curiser la zone <p>Cette zone est interne uniquement : elle contient des noms non visibles sur Internet, pour \u00e9viter de d\u00e9voiler des d\u00e9tails de l\u2019infrastructure</p> <ul> <li>Reverse DNS <code>10.10.10.in-addr.arpa</code></li> </ul> \u00c9l\u00e9ment Signification <code>zone \"10.10.10.in-addr.arpa\"</code> Zone DNS inverse, utilis\u00e9e pour traduire une IP \u2192 nom <code>file \"/etc/bind/db.10.10.10.rev\"</code> Fichier contenant les enregistrements PTR <code>type master</code> et <code>allow-transfer { none; };</code> Identique aux autres zones : autorit\u00e9 principale et s\u00e9curit\u00e9 <p>Cette zone est essentielle pour la r\u00e9solution inverse DNS : elle permet, par exemple, \u00e0 10.10.10.3 de r\u00e9pondre qu\u2019il s\u2019agit de mail.itway.fr.</p>"},{"location":"dmz/dns/#le-fichier-namedconflocalj2-sert-a","title":"Le fichier <code>named.conf.local.j2</code> sert \u00e0 :","text":"<ul> <li>D\u00e9clarer quelles zones le serveur DNS va g\u00e9rer (itway.fr, int.itway.fr, reverse DNS),</li> <li>Associer chaque zone \u00e0 son fichier de donn\u00e9es DNS,</li> <li>Interdire les transferts de zone, pour des raisons de s\u00e9curit\u00e9.</li> <li>Il est indispensable pour que BIND sache comment et quoi servir en tant que DNS ma\u00eetre.</li> </ul>"},{"location":"dmz/dns/#73-dbitwayfrj2","title":"7.3 <code>db.itway.fr.j2</code>","text":"<p>Le fichier <code>db.itway.fr.j2</code> est un \u00e9l\u00e9ment central dans la configuration DNS. </p>"},{"location":"dmz/dns/#le-contenu-du-fichier","title":"Le contenu du fichier :","text":""},{"location":"dmz/dns/#a-le-serveur-dns-principal-soa","title":"A. Le serveur DNS principal (SOA)","text":"<p>SOA = Start of Authority</p> <p>C\u2019est le premier enregistrement obligatoire dans un fichier de zone DNS. Il indique qui est l\u2019autorit\u00e9 principale pour cette zone, et comment elle se g\u00e8re (temps, rafra\u00eechissement, etc.).</p> <p>Il d\u00e9clare le serveur DNS ma\u00eetre pour cette zone et d\u00e9finit des param\u00e8tres de gestion comme : </p> <ul> <li>Quand les DNS secondaires doivent se synchroniser,</li> <li>Quel est le contact admin,</li> <li>Quel est le num\u00e9ro de version de la zone (s\u00e9rial).</li> </ul> <p>SOA d\u00e9finit dans le playbook :  <pre><code>$TTL 1h\n@   IN  SOA ns1.itway.fr. admin.itway.fr. (\n        2025052905 ; Serial auto\n        1h   ; Refresh\n        15m  ; Retry\n        1w   ; Expire\n        1h ) ; Neg TTL\n</code></pre></p> <p>Explication :</p> \u00c9l\u00e9ment Description <code>@</code> Repr\u00e9sente le domaine courant (<code>itway.fr</code>) <code>IN</code> Classe Internet <code>SOA</code> D\u00e9but d\u2019autorit\u00e9 <code>ns1.itway.fr.</code> Nom du serveur DNS ma\u00eetre (serveur principal) <code>admin.itway.fr.</code> Contact admin (\u2192 <code>admin@itway.fr</code>) <code>2025052901</code> Serial = version du fichier de zone <code>1h</code> (Refresh) Tous les 1h, un esclave v\u00e9rifie si la zone a chang\u00e9 <code>15m</code> (Retry) Si l\u2019esclave \u00e9choue, il r\u00e9essaie dans 15 minutes <code>1w</code> (Expire) Si aucune maj en 1 semaine, il consid\u00e8re la zone invalide <code>1h</code> (Negative TTL) Dur\u00e9e pour laquelle une r\u00e9ponse \"non trouv\u00e9e\" est gard\u00e9e en cache"},{"location":"dmz/dns/#b-les-noms-et-leurs-ips-ex-mailitwayfr-1010103","title":"B. Les noms et leurs IPs (ex : mail.itway.fr \u2192 10.10.10.3)","text":"<p>C\u2019est ici que l\u2019on associe les noms des machines (hostnames) \u00e0 leurs adresses IP. Cela permet au serveur DNS de r\u00e9pondre aux clients en traduisant un nom de domaine en adresse IP.</p> \u00c9l\u00e9ment Nom du param\u00e8tre Signification <code>ns1</code> Nom (ou label) C\u2019est le nom de l\u2019h\u00f4te (dans ce cas, <code>ns1.itway.fr</code>) <code>IN</code> Classe Signifie \"Internet\" (valeur presque toujours <code>IN</code>) <code>A</code> Type Type d\u2019enregistrement DNS : ici, un <code>A</code> pour une adresse IPv4 <code>10.10.10.4</code> Valeur C\u2019est l\u2019adresse IP associ\u00e9e au nom <code>ns1</code> <ul> <li><code>@</code> : est un raccourci qui repr\u00e9sente le nom de domaine racine de la zone (ici, itway.fr). L\u2019enregistrement MX indique \u00e0 quel serveur envoyer les emails destin\u00e9s au domaine.</li> <li><code>ns1</code> : ns1.itway.fr pointe vers l\u2019IP 10.10.10.4</li> <li><code>CNAME</code> : signifie que www.itway.fr redirige vers ce que rproxy.itway.fr pointe (donc \u00e9vite la redondance).</li> <li><code>TXT</code> : Un enregistrement TXT (Text) permet d\u2019ajouter du texte libre dans une zone DNS. Il est souvent utilis\u00e9 pour la s\u00e9curit\u00e9 (SPF, DKIM, DMARC), la v\u00e9rification de domaine, ou des informations sp\u00e9cifiques aux services. Exemple dans le projet : <pre><code>@   IN  TXT \"v=spf1 mx -all\"\n</code></pre> <code>v=spf1 mx -all</code> \u2192 contenu du texte, ici une politique SPF <p>SPF = Sender Policy Framework C\u2019est un m\u00e9canisme de protection contre le spoofing (falsification d\u2019exp\u00e9diteur dans les emails). Il indique quels serveurs ont le droit d\u2019envoyer des emails au nom du domaine.</p> </li> </ul>"},{"location":"dmz/dns/#74-dbintitwayfrj2","title":"7.4 <code>db.int.itway.fr.j2</code>","text":"<p>Le fichier db.int.itway.fr.j2 d\u00e9finit une zone DNS priv\u00e9e, non accessible depuis Internet. Il est utilis\u00e9 pour la r\u00e9solution des noms internes \u00e0 l\u2019entreprise, notamment ceux qui ne doivent \u00eatre visibles que depuis les r\u00e9seaux internes de confiance.</p>"},{"location":"dmz/dns/#quest-ce-quune-zone-dns-interne","title":"Qu'est-ce qu'une zone DNS interne ?","text":"<p>C\u2019est un fichier de zone qui d\u00e9crit des noms et adresses IP internes, souvent associ\u00e9s \u00e0 des services ou infrastructures non publics. Dans notre cas, cette zone couvre le domaine int.itway.fr, utilis\u00e9 pour d\u00e9signer des machines internes de la DMZ.</p>"},{"location":"dmz/dns/#contenu-du-fichier","title":"Contenu du fichier :","text":"<pre><code>$TTL 1h\n@   IN  SOA ns1.int.itway.fr. admin.itway.fr. (\n        {{ ansible_date_time.date | regex_replace('-', '') }}01 ; Serial\n        1h   ; Refresh\n        15m  ; Retry\n        1w   ; Expire\n        1h ) ; Neg TTL\n\n    IN  NS  ns1.int.itway.fr.\n\nns1         IN  A   10.10.10.4\ndmz-web     IN  A   10.10.10.2\ndmz-rt      IN  A   10.10.10.1\ndmz-rproxy  IN  A   10.10.10.5\n</code></pre>"},{"location":"dmz/dns/#pourquoi-faire-un-deuxieme-fichier-au-lieu-de-tout-mettre-dans-un-seul","title":"Pourquoi faire un deuxi\u00e8me fichier au lieu de tout mettre dans un seul ?","text":"<p>Parce que itway.fr est une zone publique mais int.itway.fr est une zone priv\u00e9e (interne). Ce sont deux zones DNS distinctes, avec des usages, des acc\u00e8s et des contraintes de s\u00e9curit\u00e9 diff\u00e9rents. </p> <p>La s\u00e9paration permet une meilleure s\u00e9curit\u00e9, une meilleure organisation, et respecte le fonctionnement technique de Bind9.</p> <p>Il ne faut pas oublier qu'on \u00e0 d\u00e9clarer deux zones dans <code>named.conf.local.j2</code> et on limite les requ\u00eates r\u00e9cursives dans dans <code>named.conf.options.j2</code>.</p>"},{"location":"dmz/dns/#75-db101010revj2","title":"7.5 <code>db.10.10.10.rev.j2</code>","text":"<p>Ce fichier est une zone de r\u00e9solution inverse (reverse DNS). Il permet de faire l\u2019inverse de ce que fait un enregistrement A : Au lieu de traduire un nom en IP, il traduit une IP en nom.</p>"},{"location":"dmz/dns/#quest-ce-quune-zone-inverse","title":"Qu'est ce qu'une zone inverse ?","text":"<p>Quand une machine conna\u00eet l\u2019IP (ex. 10.10.10.3) et veut conna\u00eetre le nom de domaine associ\u00e9, elle effectue une requ\u00eate PTR (Pointer Record) via une zone dite inverse.</p> <p>Cette zone est toujours associ\u00e9e \u00e0 des IPs et suit le format : x.x.x.in-addr.arpa <pre><code>    2   IN  PTR dmz-web.itway.fr.\n    3   IN  PTR mail.itway.fr.\n    4   IN  PTR ns1.itway.fr.\n    5   IN  PTR rproxy.itway.fr.\n</code></pre></p>"},{"location":"dmz/dns/#lavantage-dune-zone-inverse","title":"L'avantage d'une zone inverse ?","text":"<ul> <li>Certains serveurs refusent des connexions SMTP s\u2019il n\u2019y a pas de PTR valide.</li> <li>Cela am\u00e9liore la l\u00e9gitimit\u00e9 DNS de tes services aux yeux d\u2019Internet.</li> <li>Utile pour l\u2019analyse de logs r\u00e9seau.</li> </ul>"},{"location":"dmz/dns/#7-securite-conformite","title":"7. S\u00e9curit\u00e9 &amp; conformit\u00e9","text":"S\u00e9curit\u00e9 appliqu\u00e9e Description R\u00e9cursion filtr\u00e9e <code>allow-recursion</code> restreint aux r\u00e9seaux internes Pas de transfert <code>allow-transfer { none; }</code> pour \u00e9viter vol de zones Zone interne priv\u00e9e <code>int.itway.fr</code> non expos\u00e9e via firewall et config Pas de communication avec DNS interne Isolation r\u00e9seau stricte"},{"location":"dmz/dns/#8-probleme-rencontre-permissions-sudo-brisees","title":"8. Probl\u00e8me rencontr\u00e9 : permissions <code>sudo</code> bris\u00e9es","text":""},{"location":"dmz/dns/#solution-appliquee","title":"Solution appliqu\u00e9e :","text":"<pre><code>chown root:root /usr/bin/sudo\nchmod 4755 /usr/bin/sudo\n</code></pre>"},{"location":"dmz/dns/#conclusion","title":"Conclusion","text":"<p>Ce projet met en place un serveur DNS s\u00e9curis\u00e9 et bien segment\u00e9 :</p> <ul> <li>Zones publiques et internes distinctes.</li> <li>Isolation DMZ/infrastructure.</li> <li>Ansible pour fiabilit\u00e9 et industrialisation.</li> <li>Conforme au cahier des charges.</li> </ul>"},{"location":"dmz/rproxy/","title":"Serveur RPROXY (Reverse Proxy)","text":""},{"location":"dmz/rproxy/#1-objectifs","title":"1. Objectifs","text":"<p>Mettre en place un serveur Reverse Proxy s\u00e9curis\u00e9 (DMZ-RPROXY) dans la DMZ, accessible depuis :</p> <ul> <li>Internet</li> <li>Tous les r\u00e9seaux internes de confiance</li> </ul> <p>Ce serveur a pour mission de :</p> <ul> <li>Exposer les services web internes de mani\u00e8re s\u00e9curis\u00e9e via HTTPS :<ul> <li><code>itway.fr</code></li> <li><code>webmail.itway.fr</code></li> </ul> </li> <li>Rediriger les requ\u00eates vers les serveurs internes correspondants :<ul> <li><code>DMZ-WEB</code> (ex : 10.10.10.2)</li> <li><code>Serveur mail/webmail</code> (ex : 10.10.10.3)</li> </ul> </li> <li>G\u00e9rer les certificats SSL/TLS via une PKI interne (<code>SRV-PKI</code>)</li> <li>Appliquer des r\u00e8gles de s\u00e9curit\u00e9 avanc\u00e9es (headers, protocoles, ciphers)</li> </ul>"},{"location":"dmz/rproxy/#2-reverse-proxy","title":"2. Reverse Proxy","text":""},{"location":"dmz/rproxy/#21-cest-quoi-un-reverse-proxy","title":"2.1 C'est quoi un Reverse Proxy","text":"<p>Un reverse proxy est un serveur interm\u00e9diaire entre un client (navigateur) et un ou plusieurs serveurs d'application.</p>"},{"location":"dmz/rproxy/#fonctionnement","title":"Fonctionnement :","text":"<ol> <li>Le client se connecte au reverse proxy.</li> <li>Le proxy re\u00e7oit la requ\u00eate, la redirige vers le bon serveur (en DMZ ou LAN).</li> <li>Il re\u00e7oit la r\u00e9ponse et la renvoie au client comme si elle venait de lui.</li> </ol>"},{"location":"dmz/rproxy/#avantages","title":"Avantages :","text":"B\u00e9n\u00e9fice D\u00e9tail S\u00e9curit\u00e9 Les serveurs r\u00e9els sont masqu\u00e9s HTTPS centralis\u00e9 Un seul point de gestion du chiffrement Load balancing possible Peut r\u00e9partir les requ\u00eates entre plusieurs backends Contr\u00f4le du trafic Possibilit\u00e9 de filtrer, journaliser, r\u00e9\u00e9crire les requ\u00eates"},{"location":"dmz/rproxy/#3-justification-des-choix","title":"3. Justification des choix","text":"Composant Choix effectu\u00e9 Justification Reverse Proxy Nginx L\u00e9ger, rapide, facile \u00e0 configurer SSL/TLS Certificat sign\u00e9 par SRV-PKI S\u00e9curit\u00e9, int\u00e9gration dans ton infrastructure Automatisation Ansible + r\u00f4les D\u00e9ploiement reproductible et versionn\u00e9 S\u00e9paration des domaines <code>itway.fr</code>, <code>webmail.itway.fr</code> Permet une gestion claire des services"},{"location":"dmz/rproxy/#4-structure-du-projet-ansible","title":"4. Structure du projet Ansible","text":"<pre><code>roles/\n\u2514\u2500\u2500 dmz-rproxy/\n    \u251c\u2500\u2500 tasks/\n    \u2502   \u251c\u2500\u2500 main.yml\n    \u2502   \u2514\u2500\u2500 cert.yml\n    \u251c\u2500\u2500 templates/\n    \u2502   \u251c\u2500\u2500 nginx.conf.j2\n    \u2502   \u251c\u2500\u2500 default.conf.j2\n    \u2502   \u251c\u2500\u2500 webmail.conf.j2\n    \u2502   \u251c\u2500\u2500 ssl_params.conf.j2\n    \u2502   \u2514\u2500\u2500 security_headers.conf.j2\n    \u251c\u2500\u2500 vars/\n    \u2502   \u2514\u2500\u2500 main.yml\n    \u2514\u2500\u2500 handlers/\n        \u2514\u2500\u2500 main.yml\n</code></pre>"},{"location":"dmz/rproxy/#5-gestion-du-certificat-tls","title":"5. Gestion du certificat TLS","text":"<p>Le certificat TLS est :</p> <ul> <li>G\u00e9n\u00e9r\u00e9 localement sur DMZ-RPROXY (<code>.key</code>)</li> <li>Une CSR est cr\u00e9\u00e9e (<code>.csr</code>)</li> <li>Elle est envoy\u00e9e et sign\u00e9e par <code>SRV-PKI</code></li> <li>Le certificat sign\u00e9 (<code>.crt</code>) + la CA (<code>ca.crt</code>) sont r\u00e9cup\u00e9r\u00e9s</li> <li>Un fichier <code>fullchain.crt</code> est assembl\u00e9</li> </ul> <p>Ceci est enti\u00e8rement automatis\u00e9 via Ansible (<code>tasks/cert.yml</code>)</p>"},{"location":"dmz/rproxy/#6-configuration-nginx","title":"6. Configuration Nginx","text":""},{"location":"dmz/rproxy/#61-nginxconfj2","title":"6.1 <code>nginx.conf.j2</code>","text":"<p>Le fichier nginx.conf.j2 est le fichier de configuration principal de Nginx. Il est d\u00e9ploy\u00e9 automatiquement via Ansible gr\u00e2ce au template .j2.</p> <p>Ce fichier configure les comportements globaux de Nginx :</p> <ul> <li>Utilisateur syst\u00e8me</li> <li>Nombre de processus</li> <li>Gestion des connexions</li> <li>Fichiers de logs</li> <li>Chargement des fichiers de configuration suppl\u00e9mentaires</li> </ul>"},{"location":"dmz/rproxy/#explication-bloc-1-parametres-globaux","title":"Explication Bloc 1 : Param\u00e8tres globaux","text":"<pre><code>user www-data;\nworker_processes auto;\npid /run/nginx.pid;\n</code></pre> Ligne Signification <code>user www-data;</code> D\u00e9finit l\u2019utilisateur syst\u00e8me pour Nginx (par d\u00e9faut sur Debian : <code>www-data</code>) <code>worker_processes auto;</code> Nombre de processus = auto-adapt\u00e9 selon les c\u0153urs CPU disponibles <code>pid /run/nginx.pid;</code> Fichier contenant le PID principal de Nginx (utilis\u00e9 pour la gestion du service)"},{"location":"dmz/rproxy/#explication-bloc-2-gestion-des-connexions","title":"Explication Bloc 2 : Gestion des connexions","text":"<pre><code>events {\n    worker_connections 1024;\n}\n</code></pre> Ligne Signification <code>worker_connections 1024;</code> Chaque worker peut accepter jusqu\u2019\u00e0 1024 connexions simultan\u00e9es"},{"location":"dmz/rproxy/#explication-bloc-3-bloc-http-principal","title":"Explication Bloc 3 : Bloc HTTP principal","text":"<pre><code>http {\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n\n    sendfile on;\n    keepalive_timeout 65;\n\n    access_log /var/log/nginx/access.log;\n    error_log  /var/log/nginx/error.log;\n\n    include /etc/nginx/conf.d/*.conf;\n    include /etc/nginx/sites-enabled/*;\n}\n</code></pre> Ligne Signification <code>include /etc/nginx/mime.types;</code> Charge la liste des types MIME (text/html, image/png...) <code>default_type application/octet-stream;</code> Type de fichier par d\u00e9faut si non reconnu (binaire g\u00e9n\u00e9rique) <code>sendfile on;</code> Utilise une m\u00e9thode optimis\u00e9e pour envoyer les fichiers statiques <code>keepalive_timeout 65;</code> Garde les connexions HTTP ouvertes pendant 65 secondes (timeout) <code>access_log /var/log/nginx/access.log;</code> Journalise toutes les requ\u00eates re\u00e7ues <code>error_log /var/log/nginx/error.log;</code> Journalise les erreurs rencontr\u00e9es <code>include /etc/nginx/conf.d/*.conf;</code> Charge les fichiers de configuration globaux (certificats, headers, etc.) <code>include /etc/nginx/sites-enabled/*;</code> Charge les vhosts activ\u00e9s (itway.fr, webmail.itway.fr, etc.)"},{"location":"dmz/rproxy/#62-defaultconfj2","title":"6.2 <code>default.conf.j2</code>","text":"<p>Le fichier <code>default.conf.j2</code> est un template Ansible qui g\u00e9n\u00e8re la configuration Nginx pour le site principal itway.fr. Il d\u00e9finit :</p> <ul> <li>Une redirection automatique de HTTP vers HTTPS,</li> <li>Une configuration s\u00e9curis\u00e9e pour le reverse proxy en HTTPS,</li> <li>La connexion s\u00e9curis\u00e9e vers le backend web_front (le serveur web interne),</li> <li>L\u2019int\u00e9gration de la s\u00e9curit\u00e9 TLS (certificats, headers).</li> </ul> <p>Vhost principal pour :</p> <ul> <li><code>itway.fr</code> (redirection HTTP \u279c HTTPS)</li> <li>Reverse proxy vers <code>10.10.10.2</code></li> </ul>"},{"location":"dmz/rproxy/#explication-bloc-1-redirection-http-vers-https","title":"Explication Bloc 1 : Redirection HTTP vers HTTPS","text":"<pre><code># Redirection HTTP \u2192 HTTPS\nserver {\n    listen 80;\n    listen [::]:80;\n    server_name itway.fr www.itway.fr;\n    return 301 https://$host$request_uri;\n}\n</code></pre> Ligne Signification <code>listen 80;</code> Nginx \u00e9coute sur le port 80 (HTTP) <code>listen [::]:80;</code> Idem pour IPv6 <code>server_name itway.fr www.itway.fr;</code> Ce bloc concerne ces domaines <code>return 301 https://$host$request_uri;</code> Redirige toutes les requ\u00eates HTTP vers HTTPS (code 301 = redirection permanente) <p>But : forcer tous les utilisateurs \u00e0 passer par une connexion s\u00e9curis\u00e9e.</p>"},{"location":"dmz/rproxy/#explication-bloc-2-definition-du-backend","title":"Explication Bloc 2 : D\u00e9finition du backend","text":"<pre><code># Bloc principal HTTPS\nupstream web_front {\n    server 10.10.10.2:443;\n}\n</code></pre> Ligne Signification <code>upstream web_front</code> D\u00e9finit un groupe de serveurs backend, ici appel\u00e9 <code>web_front</code> <code>server 10.10.10.2:443;</code> Ce backend est le serveur DMZ-WEB interne, \u00e9coutant en HTTPS"},{"location":"dmz/rproxy/#explication-bloc-3-serveur-principal-https","title":"Explication Bloc 3 : Serveur principal HTTPS","text":"<pre><code>server {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n    server_name itway.fr www.itway.fr;\n\n    ssl_certificate           {{ rproxy_ssl_dir }}/{{ rproxy_fullchain_filename }};\n    ssl_certificate_key       {{ rproxy_ssl_dir }}/{{ rproxy_key_filename }};\n    ssl_trusted_certificate   {{ rproxy_ssl_dir }}/{{ rproxy_ca_filename }};\n\n    include {{ rproxy_nginx_snippet_dir }}/ssl_params.conf;\n    include {{ rproxy_nginx_snippet_dir }}/security_headers.conf;\n\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n\n    location / {\n        proxy_pass https://web_front;\n        proxy_ssl_verify off;\n        proxy_read_timeout 30s;\n    }\n}\n</code></pre> Ligne Signification <code>listen 443 ssl http2;</code> Le serveur \u00e9coute en HTTPS sur IPv4 <code>listen [::]:443 ssl http2;</code> Idem pour IPv6 <code>server_name ...</code> Ce serveur s\u2019applique \u00e0 <code>itway.fr</code> et <code>www.itway.fr</code> <code>ssl_certificate</code> Le certificat TLS (sign\u00e9 par ta PKI) <code>ssl_certificate_key</code> La cl\u00e9 priv\u00e9e associ\u00e9e <code>ssl_trusted_certificate</code> La cha\u00eene de confiance (CA) pour v\u00e9rification c\u00f4t\u00e9 client <code>Host</code> Nom de domaine original <code>X-Real-IP</code> Adresse IP du client <code>X-Forwarded-For</code> Historique des proxys travers\u00e9s <code>X-Forwarded-Proto</code> Protocole utilis\u00e9 (http/https) <code>proxy_pass</code> Redirige les requ\u00eates vers <code>https://web_front</code> (d\u00e9fini plus haut) <code>proxy_ssl_verify off</code> D\u00e9sactive la v\u00e9rification TLS c\u00f4t\u00e9 backend (car c\u2019est un certif interne non public) <code>proxy_read_timeout 30s</code> Timeout de lecture des r\u00e9ponses (au-del\u00e0 de 30s \u2192 erreur)"},{"location":"dmz/rproxy/#63-webmailconfj2","title":"6.3 <code>webmail.conf.j2</code>","text":"<p>M\u00eame principe que <code>default.itway.fr</code> pour <code>webmail.itway.fr</code> \u279c vers <code>10.10.10.3</code> (SMTP).</p>"},{"location":"dmz/rproxy/#7-securite-https","title":"7. S\u00e9curit\u00e9 HTTPS","text":""},{"location":"dmz/rproxy/#71-ssl_paramsconfj2","title":"7.1 <code>ssl_params.conf.j2</code>","text":"<p>Le fichier ssl_params.conf.j2 est un fichier de configuration inclus dans chaque server HTTPS de Nginx. Il est utilis\u00e9 pour configurer la s\u00e9curit\u00e9 TLS/SSL du reverse proxy. On y d\u00e9finit les protocoles autoris\u00e9s, les chiffrements (ciphers), et des protections comme OCSP Stapling ou HSTS.</p>"},{"location":"dmz/rproxy/#a-quoi-sert-ce-fichier","title":"\u00c0 quoi sert ce fichier ?","text":"<p>Il permet de :</p> <ul> <li>S\u00e9curiser la connexion HTTPS</li> <li>Emp\u00eacher l\u2019utilisation de protocoles obsol\u00e8tes</li> <li>D\u00e9finir quelles suites de chiffrement (ciphers) le serveur doit accepter</li> <li>Am\u00e9liorer la vitesse et la fiabilit\u00e9 avec OCSP stapling</li> <li>Prot\u00e9ger les utilisateurs avec HSTS (forcer HTTPS sur longue dur\u00e9e)</li> </ul>"},{"location":"dmz/rproxy/#contenu-du-fichier","title":"Contenu du fichier","text":"<ul> <li> <p>Activer uniquement les protocoles TLS sp\u00e9cifi\u00e9s dans les variables Ansible : <pre><code>ssl_protocols {{ rproxy_ssl_protocols }};\n</code></pre></p> </li> <li> <p>Permettre au client (navigateur) de choisir le chiffrement pr\u00e9f\u00e9r\u00e9e parmi celles propos\u00e9es : <pre><code>ssl_prefer_server_ciphers off;\n</code></pre></p> </li> <li> <p>D\u00e9finir les ciphers autoris\u00e9s (suites de chiffrement TLS) : <pre><code>ssl_ciphers {{ rproxy_ssl_ciphers }};\n</code></pre></p> <p>Objectif : accepter uniquement les ciphers modernes, s\u00fbrs, et r\u00e9sistants aux attaques (ex : ECDHE-RSA-AES256-GCM-SHA384)</p> </li> <li> <p>OSCP Stapling : <pre><code>ssl_stapling on;\nssl_stapling_verify on;\n</code></pre></p> <ul> <li> <p><code>ssl_stapling on;</code> : Permet de fournir une preuve que le certificat est valide (revocation check rapide)</p> </li> <li> <p><code>ssl_stapling_verify on;</code> : V\u00e9rifie la signature de cette preuve</p> </li> </ul> </li> <li> <p>HSTS \u2013 Force HTTPS c\u00f4t\u00e9 client : <pre><code>{% if rproxy_hsts_max_age|int &gt; 0 %}\nadd_header Strict-Transport-Security \"max-age={{ rproxy_hsts_max_age }}; includeSubDomains\";\n{% endif %}\n</code></pre></p> </li> </ul> <p>Active HSTS (HTTP Strict Transport Security) uniquement si rproxy_hsts_max_age &gt; 0 et envoie un header au client pour forcer l\u2019usage de HTTPS pour une dur\u00e9e d\u00e9finie</p>"},{"location":"dmz/rproxy/#72-security_headersconfj2","title":"7.2 <code>security_headers.conf.j2</code>","text":"<p>Le fichier security_headers.conf.j2 est un fichier inclus dans la configuration Nginx HTTPS, servant \u00e0 appliquer des en-t\u00eates HTTP de s\u00e9curit\u00e9.</p> <p>L'objectif est de renforcer la s\u00e9curit\u00e9 c\u00f4t\u00e9 client en envoyant des instructions suppl\u00e9mentaires au navigateur via des HTTP headers. Ces headers ne modifient pas le contenu des pages mais imposent des r\u00e8gles de s\u00e9curit\u00e9.</p>"},{"location":"dmz/rproxy/#a-quoi-sert-ce-fichier_1","title":"\u00c0 quoi sert ce fichier ?","text":"<p>Ce fichier configure les en-t\u00eates HTTP de s\u00e9curit\u00e9 que le serveur Nginx va ajouter \u00e0 chaque r\u00e9ponse.</p> <p>Il est inclus dans chaque bloc server HTTPS pour renforcer la protection des clients (navigateurs) contre :</p> <ul> <li>Les attaques XSS (Cross-Site Scripting)</li> <li>Le clickjacking</li> <li>L\u2019injection de contenu malveillant</li> <li>La fuite d\u2019informations sensibles</li> </ul> <p>Il am\u00e9liore la posture de s\u00e9curit\u00e9 du site sans toucher au code applicatif.</p>"},{"location":"dmz/rproxy/#contenu-du-fichier_1","title":"Contenu du fichier","text":"<ul> <li> <p>Emp\u00eacher le site d\u2019\u00eatre charg\u00e9 dans une iframe depuis un autre domaine : <pre><code>add_header X-Frame-Options \"SAMEORIGIN\" always;\n</code></pre></p> <p>Prot\u00e8ge contre le clickjacking (attaques qui pi\u00e8gent l\u2019utilisateur avec des boutons invisibles).</p> </li> <li> <p>Emp\u00eacher le navigateur d\u2019interpr\u00e9ter le type de contenu diff\u00e9remment de celui annonc\u00e9 par le serveur : <pre><code>add_header X-Content-Type-Options \"nosniff\" always;\n</code></pre></p> <p>Prot\u00e8ge contre les attaques MIME-type sniffing.</p> </li> <li> <p>Contr\u00f4ler ce que le navigateur envoie comme en-t\u00eate Referer lors d\u2019un lien vers un autre site : <pre><code>add_header Referrer-Policy \"strict-origin-when-cross-origin\" always;\n</code></pre></p> <p>Prot\u00e8ge la vie priv\u00e9e de l\u2019utilisateur et limite les fuites d\u2019URL internes.</p> </li> <li> <p>Politique CSP : elle d\u00e9finit ce que le navigateur a le droit de charger et d\u2019afficher <pre><code>add_header Content-Security-Policy \"default-src 'self'; frame-ancestors 'self'; upgrade-insecure-requests\" always;\n</code></pre></p> <p>Emp\u00eache les scripts externes non autoris\u00e9s (contre XSS) et force l\u2019usage du HTTPS.</p> </li> <li> <p>Contr\u00f4ler les API sensibles du navigateur (g\u00e9olocalisation, micro, etc.) <pre><code>add_header Permissions-Policy \"geolocation=(), microphone=()\" always;\n</code></pre></p> <p>Limite les fonctions dangereuses et prot\u00e8ge la vie priv\u00e9e.</p> </li> </ul> <p>A Savoir :</p> <p><code>always</code> : ajoute l'en-t\u00eate m\u00eame si le code HTTP n\u2019est pas 200 OK (utile pour erreurs 404, redirections, etc.)</p>"},{"location":"dmz/rproxy/#8-tests-fonctionnels","title":"8. Tests fonctionnels","text":""},{"location":"dmz/rproxy/#redirection-http-https","title":"Redirection HTTP \u279c HTTPS :","text":"<pre><code>curl -I http://itway.fr\n# HTTP/1.1 301 Moved Permanently\n</code></pre>"},{"location":"dmz/rproxy/#test-https","title":"Test HTTPS :","text":"<pre><code>curl -k https://itway.fr\n# Affiche la page web servie par DMZ-RPROXY\n</code></pre>"},{"location":"dmz/rproxy/#test-https-webmailitwayfr","title":"Test HTTPS <code>webmail.itway.fr</code> :","text":"<pre><code>curl -vk https://webmail.itway.fr\n# Connexion TLS OK\n</code></pre>"},{"location":"dmz/rproxy/#test-en-externe-internet","title":"Test en externe (Internet)","text":"<ul> <li>Via <code>nslookup</code>, j'obtiens :</li> </ul> <pre><code>Name: itway.fr\nAddress: 10.10.10.5\n</code></pre> <p>En testant depuis l\u2019ext\u00e9rieur :</p> <pre><code>curl -vk https://192.168.122.24\n</code></pre> <p>R\u00e9sultat obtenu : connexion TLS valide, contenu HTML renvoy\u00e9</p>"},{"location":"dmz/rproxy/#9-liens-utiles","title":"9. Liens utiles","text":"<ul> <li>Playbook complet Ansible et r\u00f4les</li> <li>R\u00e9f\u00e9rence officielle Nginx TLS</li> </ul>"},{"location":"dmz/rproxy/#10-resume-du-role-de-dmz-rproxy","title":"10. R\u00e9sum\u00e9 du r\u00f4le de DMZ-RPROXY","text":"\u00c9tape Action 1 Le client (navigateur) appelle <code>https://itway.fr</code> 2 DMZ-RPROXY r\u00e9pond avec son certificat SSL 3 Il redirige la requ\u00eate en interne vers <code>10.10.10.2</code> 4 Le contenu est renvoy\u00e9 au client via DMZ-RPROXY"},{"location":"dmz/rproxy/#conclusion","title":"Conclusion","text":"<p>La mise en place du serveur DMZ-RPROXY joue un r\u00f4le crucial dans l'architecture r\u00e9seau de l\u2019entreprise. Il sert de point d\u2019entr\u00e9e s\u00e9curis\u00e9 entre les utilisateurs (internes ou externes) et les services web de l\u2019infrastructure, notamment itway.fr et webmail.itway.fr.</p> <p>Gr\u00e2ce \u00e0 l\u2019utilisation de Nginx comme reverse proxy, cette solution permet de :</p> <ul> <li>Centraliser la gestion du protocole HTTPS et des certificats TLS,</li> <li>Prot\u00e9ger les serveurs backend en les rendant inaccessibles directement depuis Internet,</li> <li>Appliquer des r\u00e8gles de s\u00e9curit\u00e9 strictes \u00e0 toutes les connexions HTTP/HTTPS (headers, HSTS, chiffrement moderne),</li> <li>Et assurer une compatibilit\u00e9, une performance et une maintenabilit\u00e9 \u00e9lev\u00e9es via un d\u00e9ploiement automatis\u00e9 avec Ansible.</li> </ul> <p>Le reverse proxy constitue donc un composant fondamental de la DMZ, garantissant \u00e0 la fois la s\u00e9curit\u00e9, la disponibilit\u00e9 et la transparence des services web expos\u00e9s.</p>"},{"location":"dmz/rproxyold/","title":"Mise en place d'un Reverse Proxy S\u00e9curis\u00e9 avec Nginx dans une Infrastructure en DMZ","text":""},{"location":"dmz/rproxyold/#1-introduction-theorique","title":"1. Introduction Th\u00e9orique","text":""},{"location":"dmz/rproxyold/#quest-ce-quun-reverse-proxy","title":"Qu'est-ce qu'un Reverse Proxy ?","text":"<p>Un reverse proxy est un serveur interm\u00e9diaire qui re\u00e7oit les requ\u00eates des clients et les transmet \u00e0 un ou plusieurs serveurs backend. Contrairement \u00e0 un proxy classique (forward proxy), qui agit pour le compte de clients internes vers l'ext\u00e9rieur, le reverse proxy agit pour le compte de serveurs internes vers les clients.</p>"},{"location":"dmz/rproxyold/#avantages-dun-reverse-proxy","title":"Avantages d'un Reverse Proxy","text":"<ul> <li>S\u00e9curit\u00e9 : Le reverse proxy masque l'architecture interne.</li> <li>SSL/TLS : Gestion centralis\u00e9e des certificats et du chiffrement HTTPS.</li> <li>Load Balancing : Peut r\u00e9partir les requ\u00eates entre plusieurs serveurs backend.</li> <li>Cache : Peut r\u00e9duire la charge des serveurs backend.</li> <li>Compression et Optimisation : Am\u00e9lioration des performances.</li> </ul>"},{"location":"dmz/rproxyold/#role-dans-notre-projet","title":"R\u00f4le dans notre Projet","text":"<p>Dans notre projet, le reverse proxy est situ\u00e9 dans la DMZ (zone d\u00e9militaris\u00e9e) et agit comme unique point d'entr\u00e9e HTTP/HTTPS pour des services internes, notamment :</p> <ul> <li><code>itway.fr</code> (site institutionnel)</li> <li><code>webmail.itway.fr</code> (interface Roundcube + PostfixAdmin)</li> </ul> <p>Ce reverse proxy redirige les requ\u00eates HTTPS entrantes vers les serveurs internes <code>DMZ-WEB</code>, <code>DMZ-SMTP</code>, etc., tout en appliquant une couche de s\u00e9curit\u00e9 via SSL/TLS.</p>"},{"location":"dmz/rproxyold/#2-choix-techniques","title":"2. Choix Techniques","text":""},{"location":"dmz/rproxyold/#serveur-http","title":"Serveur HTTP","text":"<ul> <li>Nginx est choisi pour sa l\u00e9g\u00e8ret\u00e9, ses performances, et son support natif de la configuration reverse proxy.</li> </ul>"},{"location":"dmz/rproxyold/#certificats-ssltls","title":"Certificats SSL/TLS","text":"<ul> <li>G\u00e9n\u00e9r\u00e9s et sign\u00e9s par une PKI interne (SRV-PKI).</li> <li>Stock\u00e9s localement sur DMZ-RPROXY.</li> <li>fullchain.crt : contient le certificat + cha\u00eene d'interm\u00e9diaires jusqu'\u2019\u00e0 la CA.</li> </ul>"},{"location":"dmz/rproxyold/#outils-dautomatisation","title":"Outils d'automatisation","text":"<ul> <li>Ansible : Utilis\u00e9 pour automatiser l'installation, la configuration et la g\u00e9n\u00e9ration des certificats.</li> </ul>"},{"location":"dmz/rproxyold/#3-architecture-de-la-solution","title":"3. Architecture de la Solution","text":"<pre><code>    [Client] &lt;--HTTPS--&gt; [DMZ-RPROXY] &lt;--HTTP--&gt; [DMZ-WEB/DMZ-SMTP]\n                                   |\n                                   |---&gt; 10.10.10.2 (Web)\n                                   |---&gt; 10.10.10.3 (Webmail)\n                                   |---&gt; 172.16.50.4 (PostfixAdmin)\n</code></pre>"},{"location":"dmz/rproxyold/#4-etapes-de-mise-en-place","title":"4. \u00c9tapes de Mise en Place","text":""},{"location":"dmz/rproxyold/#a-configuration-dns","title":"a) Configuration DNS","text":"<ul> <li><code>itway.fr</code> et <code>webmail.itway.fr</code> doivent pointer vers l'adresse IP du reverse proxy : <code>10.10.10.5</code></li> </ul>"},{"location":"dmz/rproxyold/#b-generation-des-certificats","title":"b) G\u00e9n\u00e9ration des Certificats","text":"<ul> <li>G\u00e9n\u00e9ration de la cl\u00e9 priv\u00e9e et de la CSR sur <code>DMZ-RPROXY</code>.</li> <li>Transfert de la CSR vers <code>SRV-PKI</code> pour signature.</li> <li>R\u00e9cup\u00e9ration du certificat sign\u00e9 et de la CA.</li> <li>Cr\u00e9ation d'un fullchain.crt pour la configuration Nginx.</li> </ul>"},{"location":"dmz/rproxyold/#c-installation-de-nginx","title":"c) Installation de Nginx","text":"<ul> <li>Installation via apt.</li> <li>Activation du module SSL.</li> </ul>"},{"location":"dmz/rproxyold/#d-configuration-de-nginx","title":"d) Configuration de Nginx","text":"<ul> <li> <p>Mise en place des fichiers suivants :</p> </li> <li> <p><code>default.conf</code> : g\u00e8re <code>itway.fr</code></p> </li> <li><code>webmail.conf</code> : g\u00e8re <code>webmail.itway.fr</code></li> <li><code>ssl_params.conf</code> : durcit la configuration SSL (TLS1.2+, ciphers s\u00e9curis\u00e9s)</li> <li>Chaque fichier est li\u00e9 via <code>sites-enabled/</code></li> </ul>"},{"location":"dmz/rproxyold/#e-reverse-proxy-location-et-proxy_pass","title":"e) Reverse Proxy : <code>location</code> et <code>proxy_pass</code>","text":"<ul> <li>Redirection des chemins vers les IPs internes.</li> <li>Headers HTTP ajout\u00e9s pour transparence : <code>Host</code>, <code>X-Real-IP</code>, <code>X-Forwarded-Proto</code></li> </ul>"},{"location":"dmz/rproxyold/#f-test-et-verification","title":"f) Test et V\u00e9rification","text":"<ul> <li>Commandes CURL depuis l\u2019int\u00e9rieur et l\u2019ext\u00e9rieur.</li> <li>V\u00e9rification du certificat via navigateur.</li> <li>V\u00e9rification du code HTTP (301 pour redirection, 200 pour succ\u00e8s).</li> </ul>"},{"location":"dmz/rproxyold/#g-tests-ansible-automatises","title":"g) Tests Ansible automatis\u00e9s","text":"<ul> <li><code>uri:</code> module pour tester HTTP et HTTPS</li> <li>Code de retour attendu : 301 et 200</li> </ul>"},{"location":"dmz/rproxyold/#5-points-de-securite","title":"5. Points de S\u00e9curit\u00e9","text":"<ul> <li>TLS 1.2 et 1.3 uniquement.</li> <li>Cl\u00e9 priv\u00e9e jamais copi\u00e9e en clair.</li> <li>Proxy interne en HTTP (environnement ma\u00eetris\u00e9).</li> <li>Reverse proxy positionn\u00e9 en DMZ avec firewall.</li> </ul>"},{"location":"dmz/rproxyold/#6-playbooks-ansible","title":"6. Playbooks Ansible","text":"<p>Tous les playbooks li\u00e9s \u00e0 la configuration (certificat, nginx, vhost, tests) sont disponibles dans le r\u00e9pertoire <code>roles/dmz-rproxy/</code>.</p> <p>\u27a1\ufe0f Voir les playbooks ici : [Lien vers les fichiers Ansible] (indiquez le chemin ou repo Git ici).</p>"},{"location":"dmz/rproxyold/#7-conclusion","title":"7. Conclusion","text":"<p>Cette architecture assure une s\u00e9curit\u00e9 p\u00e9rim\u00e9trique efficace, une gestion centralis\u00e9e du chiffrement, et une facilit\u00e9 d\u2019administration via Ansible. Elle permet de s\u00e9parer les acc\u00e8s publics des services internes tout en conservant un haut niveau de s\u00e9curit\u00e9 gr\u00e2ce \u00e0 l\u2019utilisation d\u2019une PKI interne et des bonnes pratiques SSL/TLS.</p>"},{"location":"dmz/smtp/","title":"DMZ-SMTP (<code>mail.itway.fr</code>)","text":"<p>Playbook Ansible complet</p>"},{"location":"dmz/smtp/#1-objectifs","title":"1. Objectifs","text":"<p>Le serveur DMZ-SMTP agit comme passerelle SMTP s\u00e9curis\u00e9e entre Internet et le r\u00e9seau interne de l\u2019entreprise. Il est con\u00e7u pour :</p> <ul> <li>Recevoir les mails externes et les relayer vers le serveur interne (SRV-MAIL),</li> <li>Relayer les mails sortants du serveur interne vers Internet,</li> <li>Filtrer les spams et les menaces avec SpamAssassin,</li> <li>Fournir un webmail (Roundcube) accessible depuis l\u2019ext\u00e9rieur via HTTPS.</li> </ul>"},{"location":"dmz/smtp/#2-presentation-du-service","title":"2. Pr\u00e9sentation du service","text":"<p>Un serveur SMTP (Simple Mail Transfer Protocol) est un composant essentiel de l\u2019envoi d\u2019emails.</p>"},{"location":"dmz/smtp/#21-quest-ce-quun-serveur-smtp","title":"2.1 Qu'est-ce qu'un serveur SMTP ?","text":"<p>C\u2019est un serveur qui envoie, re\u00e7oit ou transf\u00e8re des emails d\u2019un exp\u00e9diteur vers un ou plusieurs destinataires via le protocole SMTP.</p>"},{"location":"dmz/smtp/#22-que-fait-concretement-un-serveur-smtp","title":"2.2 Que fait concr\u00e8tement un serveur SMTP ?","text":"R\u00f4le Description Envoi d\u2019e-mails Re\u00e7oit les mails des clients (ex : Outlook, Thunderbird, Roundcube) et les transmet au serveur du destinataire. Relais Transf\u00e8re les mails entre plusieurs serveurs SMTP (par ex. d\u2019un serveur interne \u00e0 un relais en DMZ). R\u00e9ception Peut aussi recevoir des mails d'autres serveurs SMTP (Internet \u2192 entreprise)."},{"location":"dmz/smtp/#23-comment-ca-marche-dans-linsfrastructure","title":"2.3 Comment ca marche dans l'insfrastructure ?","text":""},{"location":"dmz/smtp/#fonctionnement-dun-envoi-de-mail","title":"Fonctionnement d\u2019un envoi de mail","text":"<ol> <li>Un utilisateur envoie un mail via Roundcube (webmail) :<ul> <li>Roundcube utilise le port 587 et le protocole SMTP avec authentification (SMTP AUTH).</li> <li>Le mail est transmis au serveur SRV-MAIL (Postfix).</li> </ul> </li> <li>SRV-MAIL agit comme MTA (Mail Transfer Agent) :<ul> <li>Il relaye le mail \u00e0 DMZ-SMTP (Postfix) via le port 25 (SMTP classique).</li> <li>Le trafic est souvent chiffr\u00e9 avec STARTTLS.</li> </ul> </li> <li>DMZ-SMTP transf\u00e8re le mail vers Internet :<ul> <li>Il contacte le serveur SMTP du destinataire et livre le message via le port 25.</li> </ul> </li> </ol>"},{"location":"dmz/smtp/#reception-de-mails-depuis-internet","title":"R\u00e9ception de mails depuis Internet","text":"<ol> <li>Un mail provenant de <code>user@gmail.com</code> est envoy\u00e9 \u00e0 <code>user@itway.fr</code> :<ul> <li>Le serveur SMTP de Google se connecte au serveur DMZ-SMTP (Postfix) sur le port 25.</li> <li>Le message est re\u00e7u et filtr\u00e9 par SpamAssassin.</li> </ul> </li> <li>DMZ-SMTP le relaie \u00e0 SRV-MAIL (Postfix) en interne via SMTP.</li> <li>SRV-MAIL stocke le mail avec Dovecot, accessible via :<ul> <li>IMAP (port 143 ou 993) pour les clients lourds (Thunderbird, Outlook),</li> <li>Webmail Roundcube (HTTP/S) pour consultation en ligne.</li> </ul> </li> </ol>"},{"location":"dmz/smtp/#24-pourquoi-un-relais-smtp-en-dmz","title":"2.4 Pourquoi un relais SMTP en DMZ ?","text":"Objectif Explication S\u00e9curit\u00e9 Le serveur DMZ agit comme un tampon entre l\u2019ext\u00e9rieur et le r\u00e9seau interne. Filtrage Int\u00e8gre SpamAssassin pour bloquer les spams avant qu\u2019ils n\u2019atteignent le c\u0153ur du r\u00e9seau. Conformit\u00e9 Permet de contr\u00f4ler et de journaliser les flux mail entrants/sortants. Haute disponibilit\u00e9 En cas de coupure du serveur interne, le relais peut temporairement mettre en file d\u2019attente les emails."},{"location":"dmz/smtp/#application-utilisees","title":"Application utilis\u00e9es","text":"Service R\u00f4le Postfix Serveur SMTP en mode relais (entr\u00e9es/sorties) SpamAssassin D\u00e9tection et marquage des spams Roundcube Webmail pour consulter les courriels (via HTTPS + reverse proxy) iptables Pare-feu limitant les flux entrants (SMTP, HTTPS uniquement)"},{"location":"dmz/smtp/#3-role-dans-linfrastructure-itway","title":"3. R\u00f4le dans l'infrastructure ITWay","text":"<p>Dans l\u2019infrastructure ITWay, le serveur SMTP DMZ-SMTP joue un r\u00f4le **central de </p> <p>Le serveur <code>DMZ-SMTP</code> (mail.itway.fr) a pour fonction principale de transporter les courriers \u00e9lectroniques entre :</p> <ul> <li>l\u2019ext\u00e9rieur (Internet)</li> <li>l\u2019int\u00e9rieur (r\u00e9seau ITWay, via SRV-MAIL)</li> </ul>"},{"location":"dmz/smtp/#31-reception-des-mails-entrants-depuis-internet","title":"3.1 R\u00e9ception des mails entrants (depuis Internet)","text":"<ul> <li>Il re\u00e7oit les emails destin\u00e9s \u00e0 <code>@itway.fr</code> depuis les serveurs des exp\u00e9diteurs externes (Gmail, Orange, etc.).</li> <li>Les mails sont d\u2019abord filtr\u00e9s (SpamAssassin), puis relay\u00e9s vers <code>SRV-MAIL</code>, qui les stocke via Dovecot.</li> </ul>"},{"location":"dmz/smtp/#32-relais-des-mails-sortants","title":"3.2 Relais des mails sortants","text":"<ul> <li> <p>Quand un utilisateur interne envoie un email :</p> <ul> <li>Il est d\u2019abord envoy\u00e9 \u00e0 <code>SRV-MAIL</code> via SMTP (avec authentification).</li> <li>Puis, <code>SRV-MAIL</code> transf\u00e8re le message \u00e0 <code>DMZ-SMTP</code>.</li> <li>Le serveur DMZ-SMTP d\u00e9livre alors le mail vers Internet (MTA externe).</li> </ul> </li> </ul>"},{"location":"dmz/smtp/#33-interface-dacces-web-via-roundcube","title":"3.3 Interface d\u2019acc\u00e8s web via Roundcube","text":"<ul> <li>Les utilisateurs peuvent acc\u00e9der \u00e0 leurs mails via le Webmail Roundcube install\u00e9 sur <code>DMZ-SMTP</code>.</li> <li>Ce service est accessible depuis Internet et l\u2019interne, via un reverse proxy s\u00e9curis\u00e9.</li> </ul>"},{"location":"dmz/smtp/#4-justification-des-choix","title":"4. Justification des choix","text":"<ul> <li>Isolation du relais SMTP dans une DMZ,</li> <li>Postfix pour sa robustesse et sa compatibilit\u00e9 avec les filtres,</li> <li>SpamAssassin int\u00e9gr\u00e9 via Milter pour le filtrage des spams,</li> <li>Roundcube comme client web complet et simple,</li> <li>Pare-feu pour restreindre strictement les acc\u00e8s.</li> </ul>"},{"location":"dmz/smtp/#5-structure-ansible","title":"5. Structure Ansible","text":"<pre><code>\u251c\u2500\u2500 inventory/group_vars/dmz-smtp/\n\u2502   \u251c\u2500\u2500 main.yml\n\u2502   \u2514\u2500\u2500 vault.yml\n\u251c\u2500\u2500 roles/dmz-smtp/\n\u2502   \u251c\u2500\u2500 tasks/\n\u2502   \u2502   \u251c\u2500\u2500 main.yml\n\u2502   \u2502   \u251c\u2500\u2500 cert.yml\n\u2502   \u2502   \u251c\u2500\u2500 postfix.yml\n\u2502   \u2502   \u251c\u2500\u2500 iptables.yml\n\u2502   \u2502   \u2514\u2500\u2500 roundcube.yml\n\u2502   \u251c\u2500\u2500 templates/\n\u2502   \u2502   \u251c\u2500\u2500 main.cf.j2\n\u2502   \u2502   \u251c\u2500\u2500 master.cf.j2\n\u2502   \u2502   \u251c\u2500\u2500 webmail-ssl.conf.j2\n\u2502   \u2502   \u251c\u2500\u2500 roundcube-config.inc.php.j2\n\u2502   \u2502   \u2514\u2500\u2500 rules.v4.j2\n\u2502   \u251c\u2500\u2500 handlers/main.yml\n\u2502   \u2514\u2500\u2500 files/\n\u2502       \u2514\u2500\u2500 transport\n</code></pre>"},{"location":"dmz/smtp/#6-ce-que-fait-le-playbook-ansible","title":"6. Ce que fait le Playbook Ansible","text":"<p>Le r\u00f4le <code>dmz-smtp</code> configure automatiquement un serveur de messagerie en DMZ, jouant le r\u00f4le de relais SMTP s\u00e9curis\u00e9 avec :</p> <ul> <li>Certificat SSL via SRV-PKI</li> <li>Postfix (en mode relais)</li> <li>Antispam (SpamAssassin, SPF, DMARC)</li> <li>Pare-feu via iptables</li> <li>Webmail Roundcube (HTTPS via Apache)</li> </ul>"},{"location":"dmz/smtp/#1-certificat-ssl-certyml","title":"1. Certificat SSL (<code>cert.yml</code>)","text":"<ul> <li>G\u00e9n\u00e9ration cl\u00e9 + CSR sur DMZ-SMTP</li> <li>Signature via SRV-PKI (<code>openssl ca</code>)</li> <li>R\u00e9cup\u00e9ration &amp; d\u00e9ploiement du certificat + CA</li> </ul>"},{"location":"dmz/smtp/#2-services-essentiels-mainyml","title":"2. Services essentiels (<code>main.yml</code>)","text":"<ul> <li>Installation de Postfix + antispam</li> <li>D\u00e9marrage manuel de <code>spamass-milter</code> si absent</li> <li>Import des autres t\u00e2ches</li> </ul>"},{"location":"dmz/smtp/#3-configuration-smtp-postfixyml","title":"3. Configuration SMTP (<code>postfix.yml</code>)","text":"<ul> <li>D\u00e9ploiement <code>main.cf</code>, <code>master.cf</code></li> <li>Configuration de la table de transport</li> <li>Correction des permissions Postfix (essentiel pour conteneurs)</li> </ul>"},{"location":"dmz/smtp/#4-pare-feu-iptablesyml","title":"4. Pare-feu (<code>iptables.yml</code>)","text":"<ul> <li>D\u00e9ploiement <code>rules.v4</code> pour IPv4</li> <li>Activation automatique au boot</li> </ul>"},{"location":"dmz/smtp/#5-roundcube-roundcubeyml","title":"5. Roundcube (<code>roundcube.yml</code>)","text":"<ul> <li>Installation Apache + PHP + Roundcube</li> <li>D\u00e9ploiement HTTPS (vhost)</li> <li>V\u00e9rifications d\u2019acc\u00e8s locales &amp; distantes</li> </ul>"},{"location":"dmz/smtp/#7-fichiers-de-configuration","title":"7. Fichiers de configuration","text":""},{"location":"dmz/smtp/#maincfj2","title":"<code>main.cf.j2</code>","text":"<p>Ce fichier configure Postfix en tant que serveur relais SMTP s\u00e9curis\u00e9. Il d\u00e9termine les domaines relay\u00e9s, l'authentification, le TLS, les restrictions, et l'int\u00e9gration antispam.</p>"},{"location":"dmz/smtp/#contenu","title":"Contenu","text":"<pre><code>myhostname = {{ smtp_fqdn }}\nmydomain   = {{ smtp_domain }}\nmyorigin   = $mydomain\n\ninet_interfaces = all\nmydestination = localhost\nrelay_domains = $mydomain\ntransport_maps = hash:/etc/postfix/transport\n</code></pre>"},{"location":"dmz/smtp/#explication-des-directives-principales","title":"Explication des directives principales","text":"Directive Description <code>myhostname</code> Nom d\u2019h\u00f4te du serveur <code>mydomain</code> Domaine g\u00e9r\u00e9 <code>inet_interfaces</code> Interface d\u2019\u00e9coute (<code>all</code> = toutes) <code>mydestination</code> Postfix ne distribue pas localement, seulement localhost <code>relay_domains</code> Domaine pour lequel Postfix agit comme MX relais <code>transport_maps</code> Table personnalis\u00e9e des destinations (ex: envoyer tout \u00e0 SRV-MAIL) <code>mynetworks</code> Adresses IP autoris\u00e9es \u00e0 relayer (interne uniquement) <code>smtpd_relay_restrictions</code> R\u00e8gles anti-relay : n\u2019autoriser que le LAN ou utilisateurs authentifi\u00e9s <code>smtpd_tls_*</code> / <code>smtp_tls_*</code> Param\u00e8tres TLS c\u00f4t\u00e9 serveur et client (certificats SSL) <code>smtpd_sasl_auth_enable</code> Active l\u2019authentification SASL (SMTP Auth) <code>smtpd_milters</code> Int\u00e8gre SpamAssassin via socket <code>spamass-milter</code> <code>disable_vrfy_command</code> D\u00e9sactive la commande <code>VRFY</code> (s\u00e9curit\u00e9) <code>smtpd_helo_required</code> Requiert une commande <code>HELO</code> pour commencer la session SMTP"},{"location":"dmz/smtp/#mastercfj2","title":"<code>master.cf.j2</code>","text":"<p>Ce fichier d\u00e9finit les services que Postfix \u00e9coute, comme <code>SMTP</code>, <code>SMTPS</code>, <code>submission</code>, ainsi que les options sp\u00e9cifiques \u00e0 chaque protocole.</p>"},{"location":"dmz/smtp/#contenu-du-fichier","title":"Contenu du fichier","text":"<pre><code># Postfix master.cf \u2013 services \u00e9cout\u00e9s\nsmtp      inet  n  -  y  -  -  smtpd\n  -o smtpd_milters=unix:/var/spool/postfix/var/run/spamass-milter.sock\n\nsubmission inet n - y - - smtpd\n  -o smtpd_tls_security_level=encrypt\n  -o smtpd_sasl_auth_enable=yes\n  -o smtpd_milters=unix:/var/spool/postfix/var/run/spamass-milter.sock\n\nsmtps     inet n - y - - smtpd\n  -o smtpd_tls_wrappermode=yes\n  -o smtpd_sasl_auth_enable=yes\n  -o smtpd_milters=unix:/var/spool/postfix/var/run/spamass-milter.sock\n</code></pre>"},{"location":"dmz/smtp/#explication-des-blocs","title":"Explication des blocs","text":"Service Port Description <code>smtp</code> 25 Re\u00e7oit les mails depuis Internet et autres serveurs SMTP <code>submission</code> 587 Port pour les clients mail authentifi\u00e9s (ex. Thunderbird, Outlook) <code>smtps</code> 465 Port SMTPS (SMTP sur TLS implicite) \u2013 alternative s\u00e9curis\u00e9e au port 587"},{"location":"dmz/smtp/#options-utilisees","title":"Options utilis\u00e9es","text":"Option Description <code>smtpd_tls_security_level=encrypt</code> Force le chiffrement TLS <code>smtpd_tls_wrappermode=yes</code> Utilise TLS d\u00e8s la connexion (mode SMTPS) <code>smtpd_sasl_auth_enable=yes</code> Active l'authentification SASL (n\u00e9cessaire pour <code>submission</code> et <code>smtps</code>) <code>smtpd_milters=...</code> Applique le filtre antispam (SpamAssassin via milter) sur chaque service"},{"location":"dmz/smtp/#roundcube-configincphpj2","title":"<code>roundcube-config.inc.php.j2</code>","text":"<p>Ce fichier configure Roundcube, l\u2019interface webmail utilis\u00e9e dans la DMZ pour acc\u00e9der aux mails de mani\u00e8re s\u00e9curis\u00e9e. Il d\u00e9finit la connexion \u00e0 la base de donn\u00e9es, au serveur IMAP/SMTP, les param\u00e8tres de langue, s\u00e9curit\u00e9 TLS, et autres options syst\u00e8me.</p>"},{"location":"dmz/smtp/#contenu-du-fichier_1","title":"Contenu du fichier","text":"<pre><code>&lt;?php\n\n$config['db_dsnw'] = 'mysql://{{ roundcube_db_user }}:{{ roundcube_db_pass }}@tcp(srv-mail.itway.local:3306)/roundcube';\n$config['product_name'] = 'ITWay Webmail';\n$config['language'] = 'fr_FR';\n\n$config['log_driver'] = 'file';\n$config['log_dir'] = '/var/log/roundcube/';\n\n$config['default_host'] = 'tls://srv-mail.itway.local';\n$config['default_port'] = 993;\n\n$config['smtp_host'] = 'tls://srv-mail.itway.local';\n$config['smtp_port'] = 587;\n\n$config['smtp_user'] = '%u';\n$config['smtp_pass'] = '%p';\n\n$config['imap_conn_options'] = [\n  'ssl' =&gt; [\n    'verify_peer'       =&gt; true,\n    'verify_peer_name'  =&gt; true,\n    'cafile'            =&gt; '/etc/ssl/certs/itway-ca.crt',\n  ],\n];\n\n$config['smtp_conn_options'] = $config['imap_conn_options'];\n\n$config['enable_installer'] = false;\n$config['log_logins'] = true;\n$config['debug_level'] = 1;\n$config['charset'] = 'UTF-8';\n\n$config['plugins'] = [];\n\n$config['des_key'] = '{{ roundcube_secret_key }}';\n\n?&gt;\n</code></pre>"},{"location":"dmz/smtp/#explication-des-principaux-parametres","title":"Explication des principaux param\u00e8tres","text":"Param\u00e8tre Description <code>db_dsnw</code> Connexion MySQL \u00e0 la base Roundcube sur SRV-MAIL <code>product_name</code> Nom affich\u00e9 dans l\u2019interface webmail <code>language</code> Langue par d\u00e9faut <code>log_driver</code> / <code>log_dir</code> Active la journalisation des connexions dans <code>/var/log/roundcube/</code> <code>default_host</code> / <code>default_port</code> Serveur IMAP utilis\u00e9 (connexion chiffr\u00e9e via TLS sur le port 993) <code>smtp_host</code> / <code>smtp_port</code> Serveur SMTP utilis\u00e9 (port 587 avec authentification STARTTLS) <code>smtp_user</code> / <code>smtp_pass</code> Permet l\u2019authentification avec les identifiants de l\u2019utilisateur <code>%u/%p</code> <code>imap_conn_options</code> Exige la v\u00e9rification du certificat TLS c\u00f4t\u00e9 client <code>smtp_conn_options</code> Reprend les m\u00eames options que pour IMAP <code>enable_installer</code> D\u00e9sactive l\u2019assistant d\u2019installation (s\u00e9curit\u00e9) <code>log_logins</code> Journalise les connexions <code>plugins</code> Liste des plugins Roundcube (ici vide mais modifiable) <code>des_key</code> Cl\u00e9 de chiffrement utilis\u00e9e pour stocker certains param\u00e8tres sensibles"},{"location":"dmz/smtp/#rulesv4j2","title":"<code>rules.v4.j2</code>","text":"<p>Ce fichier configure le pare-feu IPv4 via <code>iptables</code>, pour restreindre les connexions entrantes sur le serveur DMZ-SMTP. Il d\u00e9finit pr\u00e9cis\u00e9ment quels ports et r\u00e9seaux sont autoris\u00e9s \u00e0 communiquer, et bloque tout le reste.</p>"},{"location":"dmz/smtp/#contenu-du-fichier_2","title":"Contenu du fichier","text":"<pre><code>*filter\n:INPUT DROP [0:0]\n:FORWARD DROP [0:0]\n:OUTPUT ACCEPT [0:0]\n\n# \u00c9tats \u00e9tablis\n-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT\n\n# SSH seulement depuis VLAN admin (exemple 172.16.0.0/24)\n-A INPUT -p tcp -s 172.16.0.0/24 --dport 22 -j ACCEPT\n\n# SMTP + SMTPS + SUBMISSION\n-A INPUT -p tcp --dport 25  -j ACCEPT\n-A INPUT -p tcp --dport 465 -j ACCEPT\n-A INPUT -p tcp --dport 587 -j ACCEPT\n\n# HTTPS Roundcube (appel\u00e9 par le reverse-proxy)\n-A INPUT -p tcp --dport 443 -j ACCEPT\n\n# ICMP optionnel\n-A INPUT -p icmp -j ACCEPT\nCOMMIT\n</code></pre>"},{"location":"dmz/smtp/#explication-des-regles","title":"Explication des r\u00e8gles","text":"R\u00e8gle / Section Description <code>:INPUT DROP</code> Tout le trafic entrant est bloqu\u00e9 par d\u00e9faut <code>:OUTPUT ACCEPT</code> Tout le trafic sortant est autoris\u00e9 <code>--ctstate ESTABLISHED,RELATED</code> Autorise les connexions d\u00e9j\u00e0 \u00e9tablies ou connexions associ\u00e9es <code>SSH - 172.16.0.0/24</code> Autorise l\u2019acc\u00e8s SSH uniquement depuis le VLAN d\u2019administration <code>--dport 25 / 465 / 587</code> Ouvre les ports pour SMTP, SMTPS et Submission <code>--dport 443</code> Ouvre le port HTTPS (pour acc\u00e9der \u00e0 Roundcube depuis le reverse proxy) <code>icmp</code> Autorise le ping (pour le d\u00e9bogage)"},{"location":"dmz/smtp/#webmail-sslconfj2","title":"<code>webmail-ssl.conf.j2</code>","text":"<p>Ce fichier d\u00e9finit le VirtualHost Apache pour exposer Roundcube en HTTPS sur le serveur DMZ-SMTP, via le nom de domaine <code>webmail.itway.fr</code>. Il active le chiffrement SSL, configure les chemins des certificats, et permet l\u2019acc\u00e8s web au webmail.</p>"},{"location":"dmz/smtp/#contenu-du-fichier_3","title":"Contenu du fichier","text":"<pre><code>&lt;VirtualHost *:443&gt;\n    ServerName webmail.itway.fr\n    DocumentRoot /var/lib/roundcube\n\n    SSLEngine on\n    SSLCertificateFile {{ smtp_ssl_dir }}/{{ smtp_crt_filename }}\n    SSLCertificateKeyFile {{ smtp_ssl_dir }}/{{ smtp_key_filename }}\n    SSLCertificateChainFile {{ smtp_ssl_dir }}/{{ smtp_ca_filename }}\n\n    &lt;Directory /var/lib/roundcube&gt;\n        Options +FollowSymLinks\n        AllowOverride All\n        Require all granted\n    &lt;/Directory&gt;\n\n    ErrorLog  ${APACHE_LOG_DIR}/webmail_ssl_error.log\n    CustomLog ${APACHE_LOG_DIR}/webmail_ssl_access.log combined\n&lt;/VirtualHost&gt;\n</code></pre>"},{"location":"dmz/smtp/#description-des-directives","title":"Description des directives","text":"Directive R\u00f4le <code>VirtualHost *:443</code> \u00c9coute sur le port HTTPS (443) <code>ServerName</code> Nom DNS associ\u00e9 au site (ici : <code>webmail.itway.fr</code>) <code>DocumentRoot</code> R\u00e9pertoire o\u00f9 se trouve l\u2019application Roundcube <code>SSLEngine on</code> Active le SSL <code>SSLCertificateFile</code> Fichier du certificat TLS sign\u00e9 <code>SSLCertificateKeyFile</code> Cl\u00e9 priv\u00e9e associ\u00e9e au certificat <code>SSLCertificateChainFile</code> Cha\u00eene de certification (inclut la CA) <code>&lt;Directory ...&gt;</code> R\u00e8gles d\u2019acc\u00e8s HTTP sur le r\u00e9pertoire Roundcube <code>ErrorLog</code> / <code>CustomLog</code> Journaux d\u2019erreurs et d\u2019acc\u00e8s Apache <p>Parfait\u202f! Voici la derni\u00e8re partie :</p>"},{"location":"dmz/smtp/#transport","title":"<code>transport</code>","text":"<p>Le fichier <code>transport</code> est utilis\u00e9 par Postfix pour d\u00e9finir comment router les e-mails vers des serveurs sp\u00e9cifiques en fonction du domaine. Ici, ce fichier permet au serveur DMZ-SMTP de rediriger tous les e-mails du domaine <code>itway.fr</code> vers le serveur interne <code>srv-mail.itway.local</code>.</p>"},{"location":"dmz/smtp/#contenu-du-fichier_4","title":"Contenu du fichier","text":"<pre><code># transport_maps \u2013 tout le domaine va vers le serveur mail interne\nitway.fr   smtp:[srv-mail.itway.local]:25\n</code></pre>"},{"location":"dmz/smtp/#explication-des-parametres","title":"Explication des param\u00e8tres","text":"Ligne Signification <code>itway.fr</code> Domaine concern\u00e9 par cette r\u00e8gle <code>smtp:[srv-mail.itway.local]:25</code> Utilise le protocole SMTP pour envoyer vers le port 25 de <code>srv-mail</code> <code>[...]</code> autour de l'h\u00f4te Emp\u00eache la r\u00e9solution MX, envoie directement \u00e0 l'h\u00f4te sp\u00e9cifi\u00e9"},{"location":"dmz/smtp/#utilisation-avec-postfix","title":"Utilisation avec Postfix","text":"<p>Ce fichier est transform\u00e9 en base de donn\u00e9es <code>.db</code> via la commande Ansible :</p> <pre><code>postmap /etc/postfix/transport\n</code></pre> <p>Et activ\u00e9 dans <code>main.cf</code> via :</p> <pre><code>transport_maps = hash:/etc/postfix/transport\n</code></pre> <p>Cela garantit que tout mail destin\u00e9 \u00e0 <code>itway.fr</code> passe obligatoirement par <code>srv-mail.itway.local</code>.</p>"},{"location":"dmz/smtp/#8-securite-conformite","title":"8. S\u00e9curit\u00e9 &amp; conformit\u00e9","text":"<ul> <li>Chiffrement TLS actif sur tous les services,</li> <li>Fichiers sensibles avec permissions restrictives (<code>postfix:postfix</code>),</li> <li>Filtrage par adresse IP, anti-relay (<code>mynetworks</code>),</li> <li>Webmail en HTTPS uniquement,</li> <li>Services s\u00e9par\u00e9s en DMZ pour prot\u00e9ger le r\u00e9seau interne.</li> </ul>"},{"location":"dmz/smtp/#9-problemes-rencontres-solutions","title":"9. Probl\u00e8mes rencontr\u00e9s &amp; solutions","text":"Probl\u00e8me constat\u00e9 Solution appliqu\u00e9e Certificat non reconnu dans le navigateur Ajout manuel des entr\u00e9es <code>subjectAltName</code> dans la configuration OpenSSL Acc\u00e8s web Roundcube refus\u00e9 Activation du VirtualHost HTTPS via <code>a2ensite</code> et red\u00e9marrage d\u2019Apache Impossible d'envoyer un mail (port 465 ferm\u00e9) V\u00e9rification de la configuration <code>master.cf</code> + red\u00e9marrage Postfix Transport non pris en compte par Postfix G\u00e9n\u00e9ration manuelle de la table de hash avec <code>postmap</code> SpamAssassin inactif au d\u00e9marrage Ajout d\u2019un lancement manuel dans Ansible en cas d\u2019absence de processus Permissions incorrectes sur <code>/var/spool/postfix</code> Correction des droits avec <code>chown</code> et <code>chmod</code> adapt\u00e9s"},{"location":"dmz/smtp/#conclusion","title":"Conclusion","text":"<p>La mise en place du serveur DMZ-SMTP permet de s\u00e9curiser et ma\u00eetriser les flux de messagerie entre l\u2019ext\u00e9rieur et l\u2019int\u00e9rieur du r\u00e9seau ITWay. En jouant le r\u00f4le de relais SMTP, il filtre les e-mails via SpamAssassin, chiffre les communications avec des certificats TLS sign\u00e9s par une autorit\u00e9 interne, et assure un relais fiable vers le serveur de messagerie principal.</p> <p>L\u2019installation de Roundcube, accessible depuis Internet via HTTPS, offre une interface conviviale aux utilisateurs tout en conservant un bon niveau de s\u00e9curit\u00e9 gr\u00e2ce au reverse proxy et au chiffrement TLS.</p> <p>Les choix techniques et les automatisations via Ansible garantissent :</p> <ul> <li>une configuration reproductible,</li> <li>une s\u00e9curit\u00e9 coh\u00e9rente avec la politique du syst\u00e8me d'information,</li> <li>et une maintenance simplifi\u00e9e.</li> </ul> <p>Ce serveur constitue ainsi un maillon essentiel dans l\u2019architecture de messagerie s\u00e9curis\u00e9e de l\u2019entreprise.</p>"},{"location":"dmz/web/","title":"Serveur DMZ-WEB (<code>dmz-web.itway.fr</code>)","text":"<p>Playbook Ansible complet</p>"},{"location":"dmz/web/#1-objectifs","title":"1. Objectifs","text":"<p>Mettre en place un serveur Web s\u00e9curis\u00e9 dans la DMZ, accessible\u2009:</p> <ul> <li>Depuis Internet (site vitrine publique)</li> <li>Depuis tous les r\u00e9seaux internes de confiance</li> </ul> <p>Ce serveur devra\u202f:</p> <ul> <li>Publier le site principal WordPress de l\u2019entreprise\u202f: <code>https://itway.fr</code></li> <li>Servir le trafic en HTTPS (certificat sign\u00e9 par la PKI interne \u2013 SRV\u2011PKI)</li> <li>Reposer sur Nginx (choisi pour ses performances &amp; sa simplicit\u00e9) sur Debian</li> <li>\u00catre enti\u00e8rement automatis\u00e9 via Ansible (r\u00f4le <code>dmz-web</code>)</li> </ul>"},{"location":"dmz/web/#2-serveur-web","title":"2. Serveur Web","text":""},{"location":"dmz/web/#21-cest-quoi-un-serveur-web","title":"2.1  C\u2019est quoi un serveur Web\u202f?","text":"<p>Un serveur Web (Apache,\u202fNginx\u2026) \u00e9coute sur un port HTTP(S) et renvoie des pages HTML aux navigateurs.</p>"},{"location":"dmz/web/#22-pourquoi-un-serveur-web-dans-la-dmz","title":"2.2  Pourquoi un serveur Web dans la DMZ\u202f?","text":"Besoin R\u00f4le du serveur DMZ-WEB H\u00e9berger le site vitrine Stocke le code WordPress et ses m\u00e9dias S\u00e9curit\u00e9 r\u00e9seau Plac\u00e9 dans la DMZ\u202f: isolation vis\u2011\u00e0\u2011vis du LAN S\u00e9curit\u00e9 applicative Mises \u00e0 jour WordPress / plugins via Ansible Chiffrement Terminaison TLS locale (certificat sign\u00e9 par SRV\u2011PKI) Haute disponibilit\u00e9 possible Peut \u00eatre r\u00e9pliqu\u00e9 / load\u2011balanc\u00e9 par DMZ\u2011RPROXY (Nginx)"},{"location":"dmz/web/#3-justification-des-choix","title":"3. Justification des choix","text":"Composant Choix effectu\u00e9 Justification Serveur HTTP Nginx L\u00e9ger, performant, configuration claire (reverse proxy + static) CMS WordPress\u00a06.8.1 Facile \u00e0 utiliser pour un site vitrine, plugins &amp; th\u00e8mes nombreux Base de donn\u00e9es MariaDB Rempla\u00e7ant libre / performant de MySQL PHP PHP\u2011FPM\u00a08.3 Compatible WP\u202f; isol\u00e9 du serveur Web Certificats PKI interne (SRV\u2011PKI) Conformit\u00e9, contr\u00f4le complet, pas de d\u00e9pendance externe Automatisation Ansible + r\u00f4les r\u00e9utilisables D\u00e9ploiement idempotent, versionnage Git"},{"location":"dmz/web/#4-structure-du-projet-ansible","title":"4. Structure du projet Ansible","text":"<pre><code>\u251c\u2500\u2500 inventory/\n|   \u251c\u2500\u2500 hosts.ini\n\u2502   \u2514\u2500\u2500 group_vars/\n\u2502       \u2514\u2500\u2500 dmz-web/\n\u2502           \u251c\u2500\u2500 main.yml \n\u2502           \u2514\u2500\u2500 vault.yml \n\u251c\u2500\u2500 roles/\n\u2502   \u2514\u2500\u2500 dmz-web/\n\u2502       \u251c\u2500\u2500 files/\n\u2502       \u2502   \u251c\u2500\u2500 functions.php\n\u2502       \u2502   \u251c\u2500\u2500 footer.php\n\u2502       \u2502   \u251c\u2500\u2500 header.php\n\u2502       \u2502   \u251c\u2500\u2500 index.php\n\u2502       \u2502   \u251c\u2500\u2500 main.js\n\u2502       \u2502   \u2514\u2500\u2500 style.css\n\u2502       \u251c\u2500\u2500 handlers/\n\u2502       \u2502   \u2514\u2500\u2500 main.yml\n\u2502       \u251c\u2500\u2500 tasks/\n\u2502       \u2502   \u251c\u2500\u2500 main.yml\n\u2502       \u2502   \u251c\u2500\u2500 wordpress.yml\n\u2502       \u2502   \u251c\u2500\u2500 php-fpm.yml\n\u2502       \u2502   \u2514\u2500\u2500 cert.yml\n\u2502       \u251c\u2500\u2500 templates/\n\u2502       \u2502   \u251c\u2500\u2500 default.conf.j2\n\u2502       \u2502   \u251c\u2500\u2500 nginx.conf.j2\n\u2502       \u2502   \u251c\u2500\u2500 ssl_params.conf.j2\n\u2502       \u2502   \u2514\u2500\u2500 wp-config.php.j2\n\u2502       \u2514\u2500\u2500 vars/\n\u2502           \u2514\u2500\u2500 main.yml\n</code></pre> <p>Les r\u00f4les sont isol\u00e9s, facilitant les r\u00e9utilisations et les mises \u00e0 jour.</p>"},{"location":"dmz/web/#5-variables-principales","title":"5. Variables principales","text":"<p>Extrait de <code>roles/dmz-web/vars/main.yml</code>\u00a0:</p> <pre><code># Ports &amp; chemins\ndmz_web_port_http: 80\ndmz_web_port_https: 443\ndmz_web_ssl_dir: \"/etc/nginx/ssl\"\n\n# FQDN &amp; SAN\ndmz_web_fqdn: \"dmz-web.itway.fr\"\ndmz_web_alt_names:\n  - itway.fr\n  - dmz-web.itway.fr\n\n# Versions logicielles\nwp_version: \"6.8.1\"\nphp_fpm_version: \"8.3\"\n</code></pre> <p>Variables sensibles (mots de passe DB, etc.) sont stock\u00e9es dans <code>group_vars/dmz-web/vault.yml</code> (chiffr\u00e9 avec Ansible\u00a0Vault).</p>"},{"location":"dmz/web/#6-role-et-organisation-des-playbooks","title":"6. R\u00f4le et organisation des playbooks","text":"<p>Ce r\u00f4le Ansible <code>dmz-web</code> est structur\u00e9 autour de plusieurs fichiers de t\u00e2ches qui d\u00e9finissent clairement les diff\u00e9rentes \u00e9tapes du d\u00e9ploiement.</p>"},{"location":"dmz/web/#61-fichier-principal-mainyml","title":"6.1 Fichier principal <code>main.yml</code>","text":"<p>Ce fichier constitue le point d'entr\u00e9e du r\u00f4le <code>dmz-web</code>. Il orchestre l'ex\u00e9cution des sous-t\u00e2ches suivantes :</p> <ol> <li>Installation de Nginx via le module apt</li> <li>Importation du r\u00f4le de gestion de certificat TLS (<code>cert.yml</code>)</li> <li>Importation du r\u00f4le de d\u00e9ploiement WordPress (<code>wordpress.yml</code>)</li> <li>D\u00e9clenchement conditionnel des handlers si n\u00e9cessaire</li> </ol>"},{"location":"dmz/web/#62-gestion-des-certificats-certyml","title":"6.2 Gestion des certificats <code>cert.yml</code>","text":"<p>Ce fichier permet de g\u00e9rer le cycle de vie complet du certificat TLS sign\u00e9 par la PKI interne\u00a0:</p> <ol> <li>G\u00e9n\u00e9ration de la cl\u00e9 priv\u00e9e locale</li> <li>Cr\u00e9ation de la CSR (Certificate Signing Request)</li> <li>Transfert vers le serveur SRV-PKI via <code>delegate_to</code></li> <li>R\u00e9cup\u00e9ration et d\u00e9ploiement du certificat sign\u00e9 (CRT + cha\u00eene)</li> <li>Placement dans le bon r\u00e9pertoire {{ dmz_web_ssl_dir }} sur la cible</li> </ol>"},{"location":"dmz/web/#63-deploiement-de-wordpress-wordpressyml","title":"6.3 D\u00e9ploiement de WordPress <code>wordpress.yml</code>","text":"<p>Ce fichier automatise l\u2019installation et le durcissement de WordPress :</p> <ol> <li>Installation de MariaDB, PHP-FPM et d\u00e9pendances WP</li> <li>T\u00e9l\u00e9chargement de WordPress et du CLI associ\u00e9 (wp-cli)</li> <li>Cr\u00e9ation de la base de donn\u00e9es et des utilisateurs MariaDB</li> <li>D\u00e9ploiement des fichiers du site vitrine (th\u00e8me, config, index\u2026)</li> <li>G\u00e9n\u00e9ration du wp-config.php avec cl\u00e9s al\u00e9atoires</li> <li>Installation automatique du site (titre, URL, admin, etc.)</li> <li>S\u00e9curisation des acc\u00e8s (DISALLOW_FILE_EDIT, xmlrpc, wp-config)</li> <li>Fixation des permissions correctes (chown www-data)</li> </ol>"},{"location":"dmz/web/#7-gestion-du-certificat-tls-taskscertyml","title":"7. Gestion du certificat TLS (<code>tasks/cert.yml</code>)","text":""},{"location":"dmz/web/#71-detail-du-processus-automatise","title":"7.1 D\u00e9tail du processus automatis\u00e9","text":"<p>Ce r\u00f4le met en \u0153uvre un processus complet et s\u00e9curis\u00e9 d'obtention de certificat via notre PKI interne. Voici les \u00e9tapes d\u00e9taill\u00e9es\u00a0:</p> <ol> <li>G\u00e9n\u00e9ration de la cl\u00e9 priv\u00e9e &amp; CSR sur DMZ-WEB<ul> <li>La cible DMZ-WEB g\u00e9n\u00e8re localement une cl\u00e9 priv\u00e9e RSA (2048 bits) avec <code>openssl genrsa</code></li> <li>Une CSR (Certificate Signing Request) est g\u00e9n\u00e9r\u00e9e \u00e0 partir de cette cl\u00e9 avec <code>openssl req -new</code></li> <li>Ces fichiers sont cr\u00e9\u00e9s localement sur la cible pour \u00e9viter toute fuite de la cl\u00e9 priv\u00e9e</li> </ul> </li> <li>R\u00e9cup\u00e9ration de la CSR par le contr\u00f4leur Ansible<ul> <li>Le fichier <code>.csr</code> est r\u00e9cup\u00e9r\u00e9 gr\u00e2ce au module fetch, ce qui copie le fichier depuis DMZ-WEB vers le contr\u00f4leur (machine Ansible)</li> </ul> </li> <li>Signature par la PKI interne via <code>delegate_to</code><ul> <li>Le playbook ex\u00e9cute une commande de signature X.509 sur le serveur <code>SRV-PKI</code> gr\u00e2ce \u00e0 <code>delegate_to</code></li> <li>Typiquement\u00a0: <code>openssl ca -in csr.pem -out cert.crt -config /etc/pki/openssl.cn</code></li> <li>La PKI utilise une CA locale, et signe avec sa propre cl\u00e9, en respectant les contraintes du domaine itway.fr</li> </ul> </li> <li>R\u00e9cup\u00e9ration du certificat sign\u00e9 + certificat de la CA<ul> <li>Une fois le certificat sign\u00e9 par SRV-PKI, le contr\u00f4leur Ansible r\u00e9cup\u00e8re les fichiers <code>cert.crt</code> et <code>ca.crt</code></li> <li>Ces deux fichiers sont n\u00e9cessaires pour constituer une cha\u00eene de confiance compl\u00e8te (<code>fullchain</code>)</li> </ul> </li> <li>D\u00e9ploiement sur DMZ-WEB<ul> <li>Les fichiers sont ensuite copi\u00e9s sur DMZ-WEB avec <code>copy/template</code></li> <li>Le certificat client (<code>cert.crt</code>) est concat\u00e9n\u00e9 avec <code>ca.crt</code> pour produire un <code>fullchain.crt</code> utilis\u00e9 par Nginx</li> <li>Les droits sont fix\u00e9s pour \u00eatre lisibles uniquement par <code>www-data</code></li> </ul> </li> </ol>"},{"location":"dmz/web/#72-schema-du-flux-pki","title":"7.2 Sch\u00e9ma du flux PKI","text":"<pre><code>sequenceDiagram\n    participant A as DMZ-WEB (cible)\n    participant B as Contr\u00f4leur Ansible\n    participant C as SRV-PKI\n\n    A-&gt;&gt;A: G\u00e9n\u00e8re cl\u00e9 priv\u00e9e + CSR\n    A--&gt;&gt;B: fetch CSR\n    B-&gt;&gt;C: D\u00e9l\u00e8gue la signature de la CSR\n    C--&gt;&gt;B: Retourne le certificat sign\u00e9 (CRT) + ca.crt\n    B--&gt;&gt;A: Copie fullchain.crt sur DMZ-WEB\n</code></pre> <p>Aucun flux direct DMZ \u2194 PKI : tout est orchestr\u00e9 par Ansible via delegate_to, avec un contr\u00f4le total du processus et une s\u00e9curit\u00e9 maximale.</p>"},{"location":"dmz/web/#8-configuration-nginx","title":"8. Configuration Nginx","text":"<p>La configuration Nginx est enti\u00e8rement g\u00e9n\u00e9r\u00e9e via templates Jinja2 dans Ansible. Chaque fichier <code>.j2</code> est automatiquement rendu avec les variables personnalis\u00e9es et copi\u00e9 dans <code>/etc/nginx/</code>.</p>"},{"location":"dmz/web/#81-nginxconfj2","title":"8.1 <code>nginx.conf.j2</code>","text":"<p>Le fichier <code>nginx.conf.j2</code> correspond \u00e0 la configuration globale de Nginx. Il est responsable des comportements principaux du serveur :</p>"},{"location":"dmz/web/#bloc-1-parametres-globaux","title":"Bloc 1 : Param\u00e8tres globaux","text":"<pre><code>user  www-data;\nworker_processes auto;\npid /run/nginx.pid;\n</code></pre> Ligne Description <code>user www-data;</code> D\u00e9finit l\u2019utilisateur syst\u00e8me utilis\u00e9 par Nginx <code>worker_processes auto;</code> Nombre de processus g\u00e9r\u00e9 automatiquement selon les c\u0153urs CPU <code>pid /run/nginx.pid;</code> PID stock\u00e9 dans ce fichier pour g\u00e9rer le service"},{"location":"dmz/web/#bloc-2-gestion-des-connexions","title":"Bloc 2 : Gestion des connexions","text":"<pre><code>events {\n    worker_connections 768;\n}\n</code></pre> Ligne Description <code>worker_connections 768;</code> Nombre max de connexions simultan\u00e9es par worker"},{"location":"dmz/web/#bloc-3-bloc-http-principal","title":"Bloc 3 : Bloc HTTP principal","text":"<pre><code>http {\n  include       /etc/nginx/mime.types;\n  default_type  application/octet-stream;\n\n  sendfile      on;\n  keepalive_timeout 65;\n\n  access_log /var/log/nginx/access.log;\n  error_log  /var/log/nginx/error.log;\n\n  include /etc/nginx/conf.d/*.conf;\n  include /etc/nginx/sites-enabled/*;\n}\n</code></pre> Ligne Description <code>include /etc/nginx/mime.types;</code> Types MIME standards (html, jpg, pdf\u2026) <code>default_type application/octet-stream;</code> Type par d\u00e9faut en absence de d\u00e9tection <code>sendfile on;</code> Optimisation pour fichiers statiques <code>keepalive_timeout 65;</code> D\u00e9lai d\u2019inactivit\u00e9 avant fermeture de connexion <code>access_log</code>, <code>error_log</code> Fichiers journaux pour les acc\u00e8s / erreurs <code>include conf.d/*.conf</code> Inclut configs suppl\u00e9mentaires (SSL\u2026) <code>include sites-enabled/*</code> Charge les virtualhosts (dont celui du site WordPress)"},{"location":"dmz/web/#82-defaultconfj2","title":"8.2 <code>default.conf.j2</code>","text":"<p>Ce fichier est le virtualhost principal de Nginx qui sert le site WordPress. Il force la redirection HTTPS et configure tous les chemins n\u00e9cessaires \u00e0 l\u2019ex\u00e9cution du CMS.</p>"},{"location":"dmz/web/#bloc-1-redirection-http-vers-https","title":"Bloc 1 : Redirection HTTP vers HTTPS","text":"<pre><code>server {\n    listen 80;\n    listen [::]:80;\n    server_name itway.fr dmz-web.itway.fr;\n    return 301 https://$host$request_uri;\n}\n</code></pre> Ligne Description <code>listen 80;</code> / <code>listen [::]:80;</code> \u00c9coute en IPv4/IPv6 sur le port HTTP <code>server_name</code> FQDN du serveur (site principal + alias DMZ) <code>return 301 https://...</code> Redirige tout le trafic vers HTTPS"},{"location":"dmz/web/#bloc-2-virtualhost-https","title":"Bloc 2 : Virtualhost HTTPS","text":"<pre><code>server {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n    server_name itway.fr dmz-web.itway.fr;\n\n    ssl_certificate     {{ dmz_web_ssl_dir }}/fullchain.crt;\n    ssl_certificate_key {{ dmz_web_ssl_dir }}/{{ dmz_web_key_filename }};\n    include /etc/nginx/snippets/ssl_params.conf;\n\n    root {{ wp_root }}/wordpress;\n    index index.php;\n\n    client_max_body_size 32M;\n\n    location / {\n        try_files $uri $uri/ /index.php?$args;\n    }\n\n    location ~ \\\\.php$ {\n        include snippets/fastcgi-php.conf;\n        fastcgi_pass unix:/run/php/php{{ php_fpm_version }}-fpm.sock;\n    }\n\n    location ~* wp-config\\\\.php { deny all; }\n    location = /xmlrpc.php     { deny all; }\n\n    location ~* \\\\.(jpg|jpeg|gif|png|css|js|ico|webp)$ {\n        expires 365d;\n        access_log off;\n    }\n}\n</code></pre> \u00c9l\u00e9ment Description <code>ssl_certificate / ssl_key</code> Chemins vers les certificats TLS <code>include ssl_params.conf</code> Param\u00e8tres de chiffrement \u00e0 part <code>root</code> + <code>index</code> R\u00e9pertoire WordPress et fichier par d\u00e9faut <code>location /</code> Route par d\u00e9faut qui relance vers <code>index.php</code> <code>location ~ \\\\.php$</code> Ex\u00e9cution s\u00e9curis\u00e9e des fichiers PHP via FPM <code>deny all</code> S\u00e9curit\u00e9 : emp\u00eache l\u2019acc\u00e8s \u00e0 <code>wp-config.php</code> et <code>xmlrpc.php</code> <code>expires 365d</code> Cache long pour les ressources statiques"},{"location":"dmz/web/#83-ssl_paramsconfj2","title":"8.3 <code>ssl_params.conf.j2</code>","text":"<p>Ce fichier contient les param\u00e8tres TLS appliqu\u00e9s \u00e0 tous les serveurs <code>ssl</code> de Nginx.</p> <pre><code>ssl_protocols {{ dmz_web_ssl_protocols }};\nssl_ciphers   {{ dmz_web_ssl_ciphers }};\nssl_prefer_server_ciphers on;\nssl_session_cache shared:SSL:10m;\nssl_session_timeout 10m;\n</code></pre> Directive Description <code>ssl_protocols</code> Protocoles accept\u00e9s (ex. TLSv1.2, TLSv1.3) <code>ssl_ciphers</code> Liste de suites cryptographiques autoris\u00e9es <code>ssl_prefer_server_ciphers on</code> Privil\u00e9gie les choix du serveur sur ceux du client <code>ssl_session_cache</code> Cache partag\u00e9 pour les connexions SSL <code>ssl_session_timeout</code> Dur\u00e9e de validit\u00e9 d\u2019une session TLS"},{"location":"dmz/web/#84-wp-configphpj2","title":"8.4 <code>wp-config.php.j2</code>","text":"<p>Ce fichier est le template principal de configuration WordPress, g\u00e9n\u00e9r\u00e9 dynamiquement avec Ansible. Il permet de connecter WordPress \u00e0 la base de donn\u00e9es, d\u2019activer certaines s\u00e9curit\u00e9s, et d\u2019injecter automatiquement les cl\u00e9s de salage.</p>"},{"location":"dmz/web/#contenu-du-template","title":"Contenu du template","text":"<pre><code>&lt;?php\n// D\u00e9finition des informations de connexion \u00e0 la base de donn\u00e9es\ndefine('DB_NAME', '{{ wp_db_name }}');           // Nom de la base de donn\u00e9es\ndefine('DB_USER', '{{ wp_db_user }}');           // Nom d'utilisateur de la base\ndefine('DB_PASSWORD', '{{ wp_db_pass }}');       // Mot de passe utilisateur\ndefine('DB_HOST', '127.0.0.1');                  // Adresse du serveur MariaDB\ndefine('DB_CHARSET', 'utf8mb4');                 // Encodage pour WordPress\ndefine('DB_COLLATE', '');                        // Collation (vide = valeur par d\u00e9faut)\n\n// S\u00e9curit\u00e9 : forcer l'administration en HTTPS\ndefine('FORCE_SSL_ADMIN', true);                 // Acc\u00e8s au dashboard uniquement en HTTPS\ndefine('DISALLOW_FILE_EDIT', true);              // D\u00e9sactive l'\u00e9diteur de th\u00e8me/plugin depuis l'admin WP\n\n// Pr\u00e9fixe des tables WordPress dans la base\n$table_prefix = 'wp_';                           // Personnalisable pour plus de s\u00e9curit\u00e9\n\n/* Cl\u00e9s de salage WordPress \u2013 utilis\u00e9es pour s\u00e9curiser les sessions et cookies */\n// Ces cl\u00e9s sont g\u00e9n\u00e9r\u00e9es dynamiquement via Ansible\n{% for key in ['AUTH_KEY','SECURE_AUTH_KEY','LOGGED_IN_KEY','NONCE_KEY','AUTH_SALT','SECURE_AUTH_SALT','LOGGED_IN_SALT','NONCE_SALT'] %}\ndefine('{{ key }}', '{{ lookup(\"password\", \"/dev/null length=64 chars=ascii_letters,digits\") }}'); // Cl\u00e9 {{ key }}\n{% endfor %}\n\n// D\u00e9sactive le mode debug \ndefine('WP_DEBUG', false);\n\n// D\u00e9finition du chemin absolu vers WordPress\nif ( ! defined('ABSPATH') ) {\n    define('ABSPATH', __DIR__ . '/');            // D\u00e9finit le dossier racine de WP\n}\n\n// Chargement des fichiers principaux de WordPress\nrequire_once ABSPATH . 'wp-settings.php';\n</code></pre>"},{"location":"dmz/web/#explication-des-blocs","title":"Explication des blocs","text":"\u00c9l\u00e9ment Description <code>DB_NAME</code>, <code>DB_USER</code>, etc. Variables inject\u00e9es depuis Ansible pour connecter WordPress \u00e0 MariaDB <code>FORCE_SSL_ADMIN</code> Force l'acc\u00e8s \u00e0 l'interface admin via HTTPS uniquement <code>DISALLOW_FILE_EDIT</code> D\u00e9sactive l\u2019\u00e9diteur de th\u00e8me/plugin via le tableau de bord (s\u00e9curit\u00e9) <code>$table_prefix</code> Pr\u00e9fixe des tables WP, personnalisable pour \u00e9viter les injections Cl\u00e9s <code>AUTH_KEY</code> ... <code>NONCE_SALT</code> Cl\u00e9s de s\u00e9curit\u00e9 g\u00e9n\u00e9r\u00e9es dynamiquement (al\u00e9atoires \u00e0 chaque d\u00e9ploiement) <code>WP_DEBUG</code> Debug d\u00e9sactiv\u00e9 en production <code>ABSPATH</code> + <code>wp-settings.php</code> D\u00e9marre le c\u0153ur WordPress"},{"location":"dmz/web/#9-installation-durcissement-wordpress-wordpressyml","title":"9. Installation &amp; durcissement WordPress (<code>wordpress.yml</code>)","text":"\u00c9tape Action 1 Installation paquets PHP\u2011FPM, MariaDB, biblioth\u00e8ques indispensables 2 T\u00e9l\u00e9chargement &amp; installation WP\u2011CLI 3 D\u00e9marrage MariaDB (service) + cr\u00e9ation comptes / base 4 T\u00e9l\u00e9chargement et extraction WordPress <code>{{ wp_version }}</code> 5 G\u00e9n\u00e9ration wp\u2011config.php (salts uniques) 6 Installation WP en ligne de commande (titre, admin, URL) 7 D\u00e9ploiement du th\u00e8me ITWay (files/style.css, etc.) 8 Fixation des permissions (www\u2011data) <p>Plus de s\u00e9curit\u00e9\u202f: <code>DISALLOW_FILE_EDIT</code> dans <code>wp\u2011config.php</code> d\u00e9sactive l\u2019\u00e9diteur de code WordPress c\u00f4t\u00e9 admin.</p>"},{"location":"dmz/web/#10-securite-conformite","title":"10. S\u00e9curit\u00e9 &amp; conformit\u00e9","text":"Mesure appliqu\u00e9e Description Chiffrement forc\u00e9 (301 \u2192\u00a0HTTPS) Aucune page en clair TLS 1.2/1.3 uniquement <code>ssl_protocols</code> Ciphers forts <code>ssl_ciphers</code> Headers de s\u00e9curit\u00e9 <code>X\u2011Frame\u2011Options</code>, <code>X\u2011Content\u2011Type\u2011Options</code>, HSTS (optionnel) Isolation r\u00e9seau Serveur plac\u00e9 en DMZ, non joignable depuis Internet en SSH WP hardening <code>xmlrpc.php</code> bloqu\u00e9, <code>wp\u2011config.php</code> inaccessible, mises \u00e0 jour Least privilege Service <code>www-data</code>, pas de root Healthcheck automatis\u00e9 \u00c9chec = alerte dans le playbook Ansible"},{"location":"dmz/web/#11-tests-fonctionnels","title":"11. Tests fonctionnels","text":""},{"location":"dmz/web/#111-redirection-http-https","title":"11.1 Redirection HTTP \u2192 HTTPS","text":"<pre><code>curl -I http://itway.fr\n# HTTP/1.1 301 Moved Permanently\n</code></pre>"},{"location":"dmz/web/#112-page-daccueil-wordpress","title":"11.2 Page d\u2019accueil WordPress","text":"<pre><code>curl -k https://itway.fr | grep \"&lt;title&gt;\"\n# &lt;title&gt;ITWay \u2013 Just another WordPress site&lt;/title&gt;\n</code></pre>"},{"location":"dmz/web/#12-problemes-rencontres","title":"12. Probl\u00e8mes rencontr\u00e9s","text":"Probl\u00e8me R\u00e9solution <code>service nginx start</code> indisponible (systemd) Utiliser <code>nginx -s reload</code> via handler MariaDB ne d\u00e9marre pas dans le conteneur Lancer <code>service mariadb start</code> + socket <code>/run/mysqld</code> Erreur \"test failed\" <code>nginx -t</code> V\u00e9rifier pr\u00e9sence du CRT avant le test (<code>stat</code>) WP\u2011CLI timeouts (DNS) Forcer <code>--path</code> + d\u00e9sactiver validation certs si besoin"},{"location":"dmz/web/#13-liens-utiles","title":"13. Liens utiles","text":"<ul> <li>Playbook complet Ansible et r\u00f4les</li> <li>R\u00e9f\u00e9rence officielle Nginx TLS</li> <li>Documentation WordPress Hardening</li> </ul>"},{"location":"dmz/web/#conclusion","title":"Conclusion","text":"<p>La mise en place de DMZ\u2011WEB assure la publication s\u00e9curis\u00e9e du site vitrine\u202f: certificat interne, CMS WordPress \u00e0 jour, r\u00f4le Ansible idempotent. Plac\u00e9 derri\u00e8re DMZ\u2011RPROXY, le serveur profite d\u2019une double couche\u202f: filtrage du reverse proxy et durcissement applicatif local.</p> <p>Gr\u00e2ce \u00e0 cette architecture, l\u2019entreprise garantit\u202f:</p> <ul> <li>Disponibilit\u00e9 du site (DMZ d\u00e9di\u00e9e, supervision Healthcheck)</li> <li>Confidentialit\u00e9 &amp; int\u00e9grit\u00e9 (TLS\u00a01.3, ciphers forts)</li> <li>Facilit\u00e9 d\u2019exploitation (Ansible + PKI interne)</li> </ul> <p>Le r\u00f4le <code>dmz-web</code> peut \u00eatre r\u00e9\u2011ex\u00e9cut\u00e9 \u00e0 tout moment pour appliquer des mises \u00e0 jour ou d\u00e9ployer de nouvelles instances.</p>"},{"location":"it/ansible/","title":"IT-ANSIBLE (<code>it-ansible.itway.local</code>)","text":"<p>Playbook Ansible complet</p>"},{"location":"it/ansible/#objectif","title":"Objectif","text":"<p>Configurer et administrer la machine IT-ANSIBLE (<code>it-ansible.itway.local</code>), en tant que serveur d\u2019automatisation Ansible pour d\u00e9ployer, configurer et maintenir les services de l'infrastructure IT-WAY de mani\u00e8re centralis\u00e9e, s\u00e9curis\u00e9e et reproductible.</p>"},{"location":"it/ansible/#1-preparation-initiale","title":"1. Pr\u00e9paration initiale","text":""},{"location":"it/ansible/#11-configuration-reseau-en-dhcp","title":"1.1. Configuration r\u00e9seau en DHCP","text":"<p>Configurer le conteneur en adresse IP comme on le montre ici.</p>"},{"location":"it/ansible/#12-installation-des-paquets-necessaires","title":"1.2. Installation des paquets n\u00e9cessaires","text":"<pre><code>apt update\napt install ansible sshpass python3-apt -y\n</code></pre> <ul> <li><code>ansible</code> : Le c\u0153ur du syst\u00e8me. Il s'agit de l\u2019outil principal d'automatisation</li> <li><code>sshpass</code> : Permet \u00e0 Ansible (ou ssh) d\u2019utiliser un mot de passe en ligne de commande.</li> <li><code>python3-apt</code> : Librairie Python permettant d\u2019utiliser les modules APT d\u2019Ansible pour Debian/Ubuntu.</li> </ul>"},{"location":"it/ansible/#2-securisation-ssh-avec-cles","title":"2. S\u00e9curisation SSH avec cl\u00e9s","text":""},{"location":"it/ansible/#21-generation-dune-cle-ssh","title":"2.1. G\u00e9n\u00e9ration d\u2019une cl\u00e9 SSH","text":"<p>On g\u00e9n\u00e8re une cl\u00e9 SSH pour permettre \u00e0 Ansible de se connecter de mani\u00e8re s\u00e9curis\u00e9e et automatis\u00e9e aux machines distantes sans avoir \u00e0 entrer de mot de passe \u00e0 chaque fois.</p> <p>La commande suivante permet de cr\u00e9\u00e9 la cl\u00e9 : </p> <pre><code>ssh-keygen -t ed25519\n</code></pre> <ul> <li>Chemin par d\u00e9faut (<code>~/.ssh/id_ed25519</code>)</li> <li>Sans passphrase</li> </ul>"},{"location":"it/ansible/#22-diffusion-de-la-cle-publique","title":"2.2. Diffusion de la cl\u00e9 publique","text":"<p>On diffuse la cl\u00e9 SSH publique pour permettre \u00e0 la machine distante de reconna\u00eetre la machine IT-ANSIBLE comme un client autoris\u00e9 \u00e0 se connecter sans mot de passe.</p> <p>Voici la commande qui permet de copi\u00e9 la cl\u00e9 sur les autres machines :  <pre><code>ssh-copy-id -i ~/.ssh/id_ed25519.pub ansible@&lt;IP&gt;\n</code></pre></p> <p>\u26a0\ufe0f Si probl\u00e8me de \"No route to host\" :</p> <ul> <li>Ajouter une route statique dans CORE-RT (ex. vers DMZ)</li> <li>V\u00e9rifier les ACL et les objets r\u00e9seaux sur l\u2019interface de configuration</li> </ul>"},{"location":"it/ansible/#23-configuration-simplifiee-avec-sshconfig","title":"2.3. Configuration simplifi\u00e9e avec <code>~/.ssh/config</code>","text":"<p>C\u2019est le fichier de configuration client SSH, qui permet de pr\u00e9configurer les options de connexion pour chaque h\u00f4te distant.</p> <pre><code>Host dmz-smtp\n  HostName 10.10.10.3\n  User ansible\n  IdentityFile ~/.ssh/id_ed25519\n</code></pre>"},{"location":"it/ansible/#3-arborescence-ansible-recommandee","title":"3. Arborescence Ansible recommand\u00e9e","text":"<p>Ansible recommande de structurer un projet en r\u00f4les, avec une arborescence comme celle-ci : <pre><code>project/\n\u251c\u2500\u2500 ansible.cfg\n\u251c\u2500\u2500 inventory/\n\u2502   \u2514\u2500\u2500 hosts.ini\n\u251c\u2500\u2500 group_vars/\n\u2502   \u2514\u2500\u2500 all.yml\n\u251c\u2500\u2500 roles/\n\u2502   \u251c\u2500\u2500 webserver/\n\u2502   \u2502   \u251c\u2500\u2500 tasks/\n\u2502   \u2502   \u251c\u2500\u2500 handlers/\n\u2502   \u2502   \u251c\u2500\u2500 templates/\n\u2502   \u2502   \u251c\u2500\u2500 files/\n\u2502   \u2502   \u2514\u2500\u2500 vars/\n\u251c\u2500\u2500 playbooks/\n\u2502   \u251c\u2500\u2500 site.yml\n\u2502   \u2514\u2500\u2500 install-web.yml\n</code></pre></p> <p>Consulter le site Ansible ici.</p>"},{"location":"it/ansible/#detail-des-composants","title":"D\u00e9tail des composants :","text":"<ul> <li><code>ansible.cfg</code> : configuration globale (inventaire, user par d\u00e9faut, etc.)</li> <li><code>inventory/hosts.ini</code> : liste des h\u00f4tes par groupe</li> <li><code>group_vars/</code> : variables propres \u00e0 chaque groupe ou machine</li> <li><code>roles/</code> : chaque dossier repr\u00e9sente un service avec :<ul> <li><code>tasks/</code> :  Contient les t\u00e2ches principales \u00e0 ex\u00e9cuter (souvent dans main.yml)</li> <li><code>handlers/</code> :  Actions d\u00e9clench\u00e9es par notification (apr\u00e8s modification)</li> <li><code>templates/</code> :  Fichiers de configuration dynamiques avec variables Jinja2 (*.j2)</li> <li><code>files/</code> : Fichiers statiques copi\u00e9s tels quels sur la machine cible</li> <li><code>vars</code>: Variables internes au r\u00f4le (priorit\u00e9 haute)</li> </ul> </li> <li><code>playbooks/</code> : chaque fichier YAML lance un ou plusieurs r\u00f4les sur une cible sp\u00e9cifique</li> </ul>"},{"location":"it/ansible/#4-ansible-vault-gestion-des-secrets","title":"4. Ansible Vault \u2013 Gestion des secrets","text":""},{"location":"it/ansible/#41-a-quoi-sert-vault","title":"4.1 \u00c0 quoi sert Vault ?","text":"<p>Ansible Vault permet de chiffrer des informations sensibles dans nos fichiers :</p> <ul> <li>Mots de passe</li> <li>Cl\u00e9s API</li> <li>Identifiants SMTP, LDAP, etc.</li> </ul> <p>Cela \u00e9vite de stocker en clair des secrets dans <code>group_vars/*.yml</code> ou dans les playbooks.</p>"},{"location":"it/ansible/#42-creer-un-fichier-chiffre","title":"4.2 Cr\u00e9er un fichier chiffr\u00e9","text":"<pre><code>ansible-vault create group_vars/srv-mail.yml\n</code></pre>"},{"location":"it/ansible/#43-chiffrer-un-fichier","title":"4.3 Chiffrer un fichier","text":"<pre><code>ansible-vault encrypt group_vars/srv-mail.yml\n</code></pre> <ul> <li>Le fichier devient chiffr\u00e9 avec AES256</li> <li>Ansible nous demandera un mot de passe pour le d\u00e9chiffrer \u00e0 l\u2019ex\u00e9cution</li> </ul>"},{"location":"it/ansible/#44-modifier-un-fichier-chiffre","title":"4.4. Modifier un fichier chiffr\u00e9","text":"<pre><code>ansible-vault edit group_vars/srv-mail.yml\n</code></pre>"},{"location":"it/ansible/#45-dechiffrer-un-fichier-temporairement","title":"4.5. D\u00e9chiffrer un fichier (temporairement)","text":"<pre><code>ansible-vault view group_vars/srv-mail.yml\n</code></pre> <p>Sert dans des cas pr\u00e9cis o\u00f9 on veut consulter ou modifier temporairement un secret chiffr\u00e9, sans le laisser en clair durablement.</p>"},{"location":"it/ansible/#46-lancer-un-playbook-avec-vault","title":"4.6. Lancer un playbook avec Vault","text":"<pre><code>ansible-playbook setup-mail.yml --ask-vault-pass\n</code></pre> <p>Ou utiliser un fichier de mot de passe :</p> <pre><code>ansible-playbook setup-mail.yml --vault-password-file ~/.vault_pass.txt\n</code></pre>"},{"location":"it/ansible/#5-bonnes-pratiques-generales","title":"5. Bonnes pratiques g\u00e9n\u00e9rales","text":"<ul> <li>Organiser les r\u00f4les et variables par service</li> <li>Ne jamais dupliquer des informations : centralisez via <code>group_vars/</code></li> <li>\u00c9viter les <code>shell:</code>/<code>command:</code> au profit de modules d\u00e9di\u00e9s</li> <li>Toujours chiffrer les secrets avec Vault</li> <li>Tester les r\u00f4les avec des cibles de test (ex. VMs ou containers)</li> <li>Maintenir un inventaire clair, document\u00e9 et versionn\u00e9</li> </ul>"},{"location":"it/ansible/#6-exemple-de-commande-typique","title":"6. Exemple de commande typique","text":"<pre><code>ansible-playbook playbooks/setup-mail.yml -i inventory/hosts.ini --ask-vault-pass\n</code></pre>"},{"location":"it/ansible/#conclusion","title":"Conclusion","text":"<p>Ansible s\u2019av\u00e8re \u00eatre un outil extr\u00eamement pratique et puissant pour g\u00e9rer une infrastructure informatique moderne. Gr\u00e2ce \u00e0 sa capacit\u00e9 \u00e0 automatiser le d\u00e9ploiement, la configuration et la maintenance des serveurs, il permet non seulement de gagner un temps pr\u00e9cieux, mais aussi d\u2019\u00e9viter les erreurs humaines et d\u2019assurer une homog\u00e9n\u00e9it\u00e9 dans les environnements.</p> <p>En cas de faille de s\u00e9curit\u00e9, de corruption syst\u00e8me ou m\u00eame de perte totale d\u2019un serveur, Ansible permet de r\u00e9installer et reconfigurer une machine en quelques minutes \u00e0 partir de z\u00e9ro, simplement en relan\u00e7ant les bons playbooks. Cela garantit une r\u00e9silience op\u00e9rationnelle et une r\u00e9duction drastique du temps d\u2019indisponibilit\u00e9.</p> <p>De plus, son int\u00e9gration avec Ansible Vault permet de g\u00e9rer en toute s\u00e9curit\u00e9 les donn\u00e9es sensibles (mots de passe, cl\u00e9s, tokens\u2026), ce qui renforce la s\u00e9curit\u00e9 globale de l\u2019infrastructure.</p>"},{"location":"it/grafana/","title":"IT-GRAFANA","text":""},{"location":"it/grafana/#it-grafana-it-graphanaitwaylocal","title":"IT-GRAFANA (<code>it-graphana.itway.local</code>)","text":"<p>Playbook Ansible complet</p>"},{"location":"it/grafana/#cahier-des-charges","title":"Cahier des charges","text":"<p>Le serveur IT-GRAFANA est un serveur de monitoring qui assure la supervision de l\u2019ensemble des \u00e9quipements de l\u2019entreprise. Il est accessible pour son interface WEB depuis le r\u00e9seau IT uniquement. Il est configur\u00e9 pour superviser l\u2019ensemble des \u00e9quipements de l\u2019entreprise</p>"},{"location":"it/grafana/#objectif-et-role-de-grafana","title":"Objectif et r\u00f4le de Grafana","text":"<p>Grafana est un outil de visualisation et de supervision open source.  Il permet de cr\u00e9er des tableaux de bord dynamiques, d\u2019agr\u00e9ger des m\u00e9triques provenant de multiples sources (syst\u00e8mes, bases de donn\u00e9es, API\u2026), et d\u2019afficher des donn\u00e9es sous forme de graphiques, jauges ou alertes visuelles.</p> <p>Dans ce projet, Grafana a \u00e9t\u00e9 install\u00e9 comme point central de supervision de l'infrastructure, permettant aux \u00e9quipes IT de surveiller les services critiques (pare-feux, serveurs, switches, etc.) au sein du r\u00e9seau itway.local.</p> <p>Le serveur <code>IT-GRAPHANA</code> est d\u00e9ploy\u00e9 sur l\u2019IP 172.16.10.3</p>"},{"location":"it/grafana/#_1","title":"IT-GRAFANA","text":""},{"location":"it/grafana/#contraintes-rencontrees-incompatibilite-avec-systemd","title":"Contraintes rencontr\u00e9es : incompatibilit\u00e9 avec systemd","text":"<p>Lors de l\u2019installation, une difficult\u00e9 majeure est apparue :</p> <p>L\u2019installation par d\u00e9faut de Grafana tente de lancer un service <code>grafana-server</code> via <code>systemd</code>. Or, dans un conteneur Docker (environnement utilis\u00e9 ici), <code>systemd</code> n\u2019est pas disponible, ce qui provoquait une erreur critique lors de l\u2019installation avec Ansible.</p>"},{"location":"it/grafana/#solution-de-contournement-usage-de-supervisord","title":"Solution de contournement : usage de supervisord","text":"<p>Pour contourner cette limitation, nous avons utilis\u00e9 supervisord, un gestionnaire de processus l\u00e9ger compatible avec les environnements Docker. Celui-ci permet de g\u00e9rer le processus <code>grafana-server</code> sans avoir recours \u00e0 <code>systemd</code>.</p>"},{"location":"it/grafana/#quest-ce-que-supervisord","title":"Qu\u2019est-ce que <code>supervisord</code> ?","text":"<p><code>supervisord</code> est un gestionnaire de processus l\u00e9ger, \u00e9crit en Python, qui permet de d\u00e9marrer, surveiller et red\u00e9marrer automatiquement des processus (services, scripts, applications...) sur un syst\u00e8me Linux.</p> <p>Contrairement \u00e0 <code>systemd</code>, qui est le syst\u00e8me d'initialisation complet des distributions modernes, <code>supervisord</code> est ind\u00e9pendant de l'init syst\u00e8me. Il est donc id\u00e9al dans des environnements o\u00f9 <code>systemd</code> n\u2019est pas disponible (comme dans notre cas avec les conteneurs Docker ou autre environnement all\u00e9g\u00e9)</p>"},{"location":"it/grafana/#deploiement-avec-ansible","title":"D\u00e9ploiement avec Ansible","text":"<p>Nous avons con\u00e7u un r\u00f4le Ansible d\u00e9di\u00e9, <code>it-grafana</code>, permettant d'automatiser enti\u00e8rement l\u2019installation et la configuration du serveur Grafana (reproductibilit\u00e9 et maintenance simplifi\u00e9es). Voici une vue d\u2019ensemble des \u00e9tapes cl\u00e9s :</p>"},{"location":"it/grafana/#playbook-initial","title":"Playbook initial","text":"<p>Il utilisait systemd ce qui nous causait des erreurs : le d\u00e9marrage ne fonctionnait pas. <code>- name: Installer Grafana</code> <code>apt:</code> <code>name: grafana</code> <code>state: present</code></p> <p><code>- name: D\u00e9marrer et activer grafana-server</code> <code>systemd:</code> <code>name: grafana-server</code> <code>enabled: yes</code> <code>state: started</code></p> <p>\u26a0\ufe0f Probl\u00e8me : Ce code \u00e9choue dans Docker car <code>systemd</code> n\u2019est pas pr\u00e9sent, d'o\u00f9 l\u2019erreur : <code>System has not been booted with systemd as init system (PID 1). Can't operate.</code></p>"},{"location":"it/grafana/#playbook-final-version-corrigee","title":"Playbook final (version corrig\u00e9e)","text":"<p><code>- name: Installer Grafana sans d\u00e9marrer le service systemd</code> <code>apt:</code> <code>name: grafana</code> <code>state: present</code> <code>update_cache: yes</code></p> <p><code>- name: Cr\u00e9er le fichier de configuration supervisord pour grafana</code> <code>copy:</code> <code>dest: /etc/supervisor/conf.d/grafana.conf</code> <code>content: |</code> <code>[program:grafana]</code> <code>command=/usr/sbin/grafana-server --config=/etc/grafana/grafana.ini --homepath=/usr/share/grafana</code> <code>autostart=true</code> <code>autorestart=true</code> <code>stdout_logfile=/var/log/grafana.log</code> <code>stderr_logfile=/var/log/grafana.err</code></p> <p><code>- name: Cr\u00e9er les dossiers de log pour Grafana</code> <code>file:</code> <code>path: \"{{ item }}\"</code> <code>state: directory</code> <code>mode: '0755'</code> <code>loop:</code> <code>- /var/log</code> <code>- /var/log/grafana</code></p> <p><code>- name: V\u00e9rifier si supervisord est lanc\u00e9</code> <code>shell: pgrep supervisord || /usr/bin/supervisord -c /etc/supervisor/supervisord.conf</code> <code>changed_when: false</code></p> <p><code>- name: Recharger la configuration de supervisord</code> <code>command: supervisorctl reread &amp;&amp; supervisorctl update</code></p>"},{"location":"it/grafana/#detail-des-taches","title":"D\u00e9tail des t\u00e2ches","text":"T\u00e2che Description <code>apt</code> Installe Grafana sans tenter de d\u00e9marrer le service via <code>systemd</code> <code>copy</code> G\u00e9n\u00e8re un fichier de configuration pour <code>supervisord</code> afin de g\u00e9rer le processus <code>grafana-server</code> <code>file</code> S\u2019assure que les r\u00e9pertoires de logs existent pour \u00e9viter les erreurs d\u2019ex\u00e9cution <code>shell</code> D\u00e9marre supervisord uniquement s\u2019il n\u2019est pas d\u00e9j\u00e0 en cours d\u2019ex\u00e9cution <code>command</code> Recharge la configuration pour prendre en compte le nouveau programme supervis\u00e9 (Grafana)"},{"location":"it/grafana/#securite-et-accessibilite","title":"S\u00e9curit\u00e9 et accessibilit\u00e9","text":"<p>Acc\u00e8s restreint \u00e0 l\u2019interface Grafana via le port <code>3000</code>, autoris\u00e9 uniquement depuis le r\u00e9seau IT. HTTPS via le reverse proxy n\u2019est donc pas requis ici.  </p>"},{"location":"it/it/","title":"IT","text":""},{"location":"it/it/#it-reseau-administratif-et-supervision","title":"IT \u2013 R\u00e9seau Administratif et Supervision","text":""},{"location":"it/it/#1-en-quoi-consiste-le-it-network","title":"1. En quoi consiste le IT-NETWORK ?","text":"<p>Le IT-NETWORK est un sous-r\u00e9seau d\u00e9di\u00e9 exclusivement \u00e0 l\u2019administration, au d\u00e9ploiement automatis\u00e9 et \u00e0 la supervision de l\u2019ensemble de l\u2019infrastructure IT-WAY. Il est isol\u00e9 des autres r\u00e9seaux pour garantir un niveau de s\u00e9curit\u00e9 maximal.</p> <p>Seuls les administrateurs y ont acc\u00e8s, et tous les services pr\u00e9sents dans ce r\u00e9seau sont critiques pour le bon fonctionnement, la maintenance et le suivi de l\u2019infrastructure.</p>"},{"location":"it/it/#2-objectifs-du-it-network-dans-le-projet-it-way","title":"2. Objectifs du IT-NETWORK dans le projet IT-WAY","text":"<ul> <li>Centraliser les outils d\u2019administration, de supervision et d\u2019automatisation</li> <li>Isoler les outils d\u2019exploitation du reste de l\u2019infrastructure</li> <li>Offrir un environnement s\u00e9curis\u00e9 pour les t\u00e2ches sensibles</li> <li>Fournir une interface unique de gestion pour tous les services d\u00e9ploy\u00e9s</li> </ul>"},{"location":"it/it/#3-services-presents-dans-le-it-network","title":"3. Services pr\u00e9sents dans le IT-NETWORK","text":"Nom d\u2019h\u00f4te R\u00f4le Domaine IT-ANSIBLE D\u00e9ploiement et gestion de configuration it-ansible.itway.local IT-GRAPHANA Supervision et monitoring de l\u2019infra it-graphana.itway.local IT-MGMT Poste de travail d\u2019administration it-mgmt.itway.local"},{"location":"it/it/#4-adressage-ip-reseau-it","title":"4. Adressage IP \u2013 R\u00e9seau IT","text":"<p>Le r\u00e9seau IT-NETWORK est adress\u00e9 sur la plage 172.16.10.0/24, r\u00e9serv\u00e9 \u00e0 l\u2019administration uniquement.</p> Machine Adresse IP Interface accessible IT-ANSIBLE 172.16.10.2 D\u00e9ploiement vers tous les r\u00e9seaux internes IT-GRAPHANA 172.16.10.3 Interface Web accessible uniquement depuis IT IT-MGMT 172.16.10.4 Acc\u00e8s complet \u00e0 toute l\u2019infrastructure"},{"location":"it/it/#5-resume-technique","title":"5. R\u00e9sum\u00e9 technique","text":"<ul> <li>Acc\u00e8s restreint au r\u00e9seau IT : seuls les administrateurs y sont autoris\u00e9s</li> <li>IT-ANSIBLE d\u00e9ploie les configurations via playbooks Ansible</li> <li>IT-GRAPHANA supervise l\u2019ensemble des \u00e9quipements (serveurs, routeurs, services)</li> <li>IT-MGMT est le poste central d\u2019administration (Windows) avec tous les outils n\u00e9cessaires</li> <li>Tous les \u00e9quipements du r\u00e9seau IT sont administrables uniquement depuis ce r\u00e9seau</li> <li>Aucun service de ce r\u00e9seau n\u2019est accessible directement depuis Internet</li> </ul>"},{"location":"srv/ad/","title":"SRV-ADS01 Windows Server 2022","text":""},{"location":"srv/ad/#objectifs","title":"Objectifs  :","text":"<ol> <li>R\u00f4le du serveur : SRV-ADS01 est un contr\u00f4leur de domaine Active Directory charg\u00e9 de l\u2019authentification des utilisateurs et des machines, accessible depuis tous les r\u00e9seaux internes de confiance.  </li> <li>Gestion Active Directory : Concevoir une architecture AD coh\u00e9rente pour g\u00e9rer les utilisateurs, groupes, machines et strat\u00e9gies de groupe (GPO) selon les besoins de l\u2019entreprise.</li> </ol> <p>Groupes de s\u00e9curit\u00e9 \u00e0 cr\u00e9er :</p> <ul> <li>GRP-SECU-IT : Administrateurs du service informatique.  </li> <li>GRP-SECU-COM : Administrateurs du service communication.  </li> <li>GRP-SECU-DIR : Administrateurs du service commercial.  </li> <li>GRP-SECU-PROD : Administrateurs du service production.  </li> <li>Autres groupes selon les besoins identifi\u00e9s.</li> </ul> <p>Configurations sp\u00e9cifiques :</p> <p>\u2192Profils utilisateurs :</p> <ul> <li>Configurer des profils itin\u00e9rants stock\u00e9s dans un dossier d\u00e9di\u00e9.  </li> <li>Attribuer un lecteur r\u00e9seau personnel (X:) \u00e0 chaque utilisateur, mont\u00e9 automatiquement.  </li> <li>Limiter chaque dossier personnel \u00e0 un quota de 100 Mo.</li> </ul> <p>\u2192Restrictions et s\u00e9curit\u00e9 :</p> <ul> <li>Bloquer l\u2019enregistrement de fichiers ex\u00e9cutables (.exe) sur les lecteurs r\u00e9seau.  </li> <li>Afficher un message d\u2019accueil \u00e0 la connexion : \u00ab Les acc\u00e8s \u00e0 ce poste de travail sont r\u00e9serv\u00e9s aux utilisateurs autoris\u00e9s. Toute tentative d\u2019acc\u00e8s non autoris\u00e9e sera sanctionn\u00e9e. \u00bb  </li> <li>Activer l\u2019audit des connexions/d\u00e9connexions et des modifications des strat\u00e9gies.  </li> <li>Configurer le chiffrement RDP \u00e0 un niveau \u00e9lev\u00e9.  </li> <li>D\u00e9sactiver le compte invit\u00e9 sur tous les postes.  </li> <li>Impl\u00e9menter IPSec avec authentification Kerberos.</li> </ul> <p>\u2192Pare-feu Windows :</p> <ul> <li>Autoriser uniquement les services WINRM, RDP, Remote Assistance, Network Discovery et autres services n\u00e9cessaires.</li> </ul> <p>\u2192Gestion DNS :</p> <ul> <li>Cr\u00e9er une entr\u00e9e DNS statique pour chaque machine interne sur le serveur DNS interne.  </li> <li>Configurer les zones DNS inverses pour les r\u00e9seaux internes.</li> </ul>"},{"location":"srv/ad/#1-mise-en-place","title":"1. Mise en place","text":""},{"location":"srv/ad/#11-preparation-du-serveur","title":"1.1. Pr\u00e9paration du serveur","text":"<ul> <li><code>ncpa.cpl</code> \u2192 IP statique  </li> <li>DNS primaire : IP du serveur AD  </li> <li>DNS secondaire : Google (8.8.8.8) ou Cloudflare (1.1.1.1)  </li> <li>Renommer le serveur \u2192 <code>SRV-ADS01</code> \u2192 red\u00e9marrage</li> </ul>"},{"location":"srv/ad/#12-installation-du-role-adds-dns","title":"1.2. Installation du r\u00f4le ADDS + DNS","text":"<ul> <li>Gestionnaire de serveur \u2192 G\u00e9rer \u2192 Ajouter des r\u00f4les  </li> <li>Cocher : Active Directory Domain Services et DNS Server </li> <li>Installer &gt; Fermer apr\u00e8s l'installation</li> </ul>"},{"location":"srv/ad/#13-promouvoir-en-controleur-de-domaine","title":"1.3. Promouvoir en contr\u00f4leur de domaine","text":"<ul> <li>Cliquer sur la notification jaune \u2192 Promouvoir ce serveur\u2026 </li> <li>Nouvelle for\u00eat \u2192 nom : <code>itway.local</code> </li> <li>Niveau fonctionnel : <code>Windows Server 2016</code> </li> <li>D\u00e9finir le mot de passe DSRM  </li> <li>Valider les options DNS et NetBIOS  </li> <li>Suivant jusqu'\u00e0 la v\u00e9rification \u2192 Installer \u2192 Red\u00e9marrage</li> </ul>"},{"location":"srv/ad/#14-configurer-le-dns","title":"1.4. Configurer le DNS","text":"<p>Gestionnaire DNS \u2192 v\u00e9rifier : -Zone de recherche directe : <code>itway.local</code> -Pr\u00e9sence de <code>SOA</code>, <code>NS</code>, <code>A</code></p> <p>Test de la r\u00e9solution DNS avec :  <code>nslookup itway.local</code> <code>nslookup [IP du serveur]</code></p>"},{"location":"srv/ad/#15-creation-zone-de-recherche-inversee","title":"1.5. Cr\u00e9ation zone de recherche invers\u00e9e","text":"<ul> <li>DNS &gt; clic droit sur \u201cZone de recherche invers\u00e9e\u201d &gt; Nouvelle zone  </li> <li>Zone principale &gt; enregistrer dans AD &gt; nom : <code>IPv4</code> </li> <li>ID r\u00e9seau : <code>172.16.50.2</code> </li> <li>Cr\u00e9er un enregistrement pointeur (<code>PTR</code>) :  </li> <li>IP : 172.16.50.2  </li> <li> <p>Nom d'h\u00f4te : <code>SRV-ADS01.itway.local</code></p> </li> <li> <p>V\u00e9rifier avec : </p> </li> </ul> <p><code>nslookup 172.16.50.2</code></p>"},{"location":"srv/ad/#2-creation-de-larchitecture-active-directory","title":"2. Cr\u00e9ation de l\u2019architecture Active Directory","text":""},{"location":"srv/ad/#21-creation-des-uo","title":"2.1 Cr\u00e9ation des UO","text":"<p>L\u2019objectif est de structurer les utilisateurs et ordinateurs dans des OU logiques pour appliquer des GPO cibl\u00e9es.</p> <p>Dans la console Utilisateurs et ordinateurs AD, nous avons cr\u00e9\u00e9 l\u2019arborescence suivante :</p> <p>ITWAY \u251c\u2500\u2500 Utilisateurs \u251c\u2500\u2500 Groupes \u251c\u2500\u2500 Machines \u251c\u2500\u2500 Services     \u251c\u2500\u2500 IT     \u251c\u2500\u2500 COM     \u251c\u2500\u2500 DIR     \u251c\u2500\u2500 PROD</p>"},{"location":"srv/ad/#22-creation-des-groupes-de-securite","title":"2.2 Cr\u00e9ation des groupes de s\u00e9curit\u00e9","text":"<p>L\u2019objectif est de permettre une gestion des droits par service (GPO, partages, acc\u00e8s, etc.)</p> <p>Dans l\u2019OU Groupes :</p> <p>Clic droit &gt; Nouveau &gt; Groupe Nom : <code>GRP-SECU-IT</code> Type : S\u00e9curit\u00e9 \u00c9tendue : Global</p> <p>\u00c0 reproduire pour les autres groupes</p>"},{"location":"srv/ad/#23-profils-itinerants","title":"2.3 Profils itin\u00e9rants","text":"<p>L\u2019objectif est de permettre aux utilisateurs de retrouver leur environnement (bureau, documents, etc\u2026) sur n\u2019importe quel poste du domaine.</p>"},{"location":"srv/ad/#231-creation-du-dossier-partage-sur-srv-ads01","title":"2.3.1 Cr\u00e9ation du dossier partag\u00e9 sur SRV-ADS01","text":"<ul> <li>Dossier : <code>D:\\Profils</code> </li> <li>Clic droit &gt; Propri\u00e9t\u00e9s &gt; Partage &gt; Partage avanc\u00e9 &gt; Partager &gt; Nom : <code>Profils$</code> (le <code>$</code> cache le partage)  </li> <li>Autorisations : <code>Everyone</code> &gt; Lecture/\u00c9criture (sera ensuite s\u00e9curis\u00e9 par NTFS)</li> </ul>"},{"location":"srv/ad/#232-creation-des-repertoires-utilisateurs","title":"2.3.2 Cr\u00e9ation des r\u00e9pertoires utilisateurs :","text":"<ul> <li>Pour chaque utilisateur : cr\u00e9er un dossier <code>D:\\Profils\\%username%</code> </li> <li>Attribuer les droits NTFS : <code>%username%</code> \\= Contr\u00f4le total</li> </ul>"},{"location":"srv/ad/#233-affectation-du-profil-itinerant","title":"2.3.3 Affectation du profil itin\u00e9rant","text":"<p>Dans \"Utilisateurs et ordinateurs AD\" :</p> <ul> <li>Ouvrir la fiche utilisateur  </li> <li>Onglet Profil : Chemin du profil : <code>\\\\SRV-ADS01\\Profils$\\%username%</code></li> </ul>"},{"location":"srv/ad/#234-test","title":"2.3.4 Test :","text":"<p>- Cr\u00e9er un dossier ou fichier sur le bureau puis se d\u00e9connecter</p> <p>- Se connecter avec le m\u00eame utilisateur sur un autre PC du domaine</p> <p>- V\u00e9rifier que ce fichier appara\u00eet</p> <p>- V\u00e9rifier que l\u2019utilisateur ne voit pas les autres dossiers</p>"},{"location":"srv/ad/#24-message-daccueil-lors-de-la-connexion","title":"2.4 Message d\u2019accueil lors de la connexion","text":"<p>L\u2019objectif est d\u2019afficher un avertissement l\u00e9gal \u00e0 la connexion d\u2019un utilisateur.</p> <ul> <li> <p>Cr\u00e9er une GPO : <code>GPO_message_connexion</code></p> </li> <li> <p>\u00c9diter :</p> </li> </ul> <p><code>Configuration ordinateur &gt; Param\u00e8tres Windows &gt; Param\u00e8tres de s\u00e9curit\u00e9 &gt; Options de s\u00e9curit\u00e9</code></p> <ul> <li>Message texte d\u2019avertissement : \"Les acc\u00e8s \u00e0 ce poste de travail sont r\u00e9serv\u00e9s aux utilisateurs autoris\u00e9s. Toute tentative d\u2019acc\u00e8s non autoris\u00e9e sera sanctionn\u00e9e.\"  </li> <li>Titre : \"Avertissement de s\u00e9curit\u00e9\"</li> </ul> <p>Le banni\u00e8re contenant le message doit s\u2019afficher avant toute tentative de connexion.</p>"},{"location":"srv/ad/#25-audit-des-connexions-deconnexions-ainsi-que-des-modifications-gpo","title":"2.5 Audit des connexions / d\u00e9connexions, ainsi que des modifications GPO","text":"<p>L\u2019objectif est de surveiller l'activit\u00e9 des connexions et d\u00e9connexions.</p> <p>Cr\u00e9er une GPO <code>Audit_AD</code> :</p> <p><code>Configuration ordinateur &gt; Param\u00e8tres Windows &gt; Param\u00e8tres de s\u00e9curit\u00e9 &gt; Strat\u00e9gies locales &gt; Strat\u00e9gie d\u2019audit</code></p> <ul> <li>Audit des \u00e9v\u00e9nements d'ouverture de session : Activ\u00e9 (Succ\u00e8s + \u00c9chec)  </li> <li>Audit des modifications de strat\u00e9gie : Activ\u00e9</li> </ul> <p>Pour tester, il suffit de se rendre dans les journaux windows &gt; S\u00e9curit\u00e9 : </p> <p>\u2192 constater les Logon et Logoff pour les connexions/d\u00e9connexions </p> <p>\u2192constater les ID de modification</p>"},{"location":"srv/ad/#_1","title":"SRV-AD","text":""},{"location":"srv/ad/#25-chiffrement-eleve-pour-le-protocole-rdp","title":"2.5 Chiffrement \u00e9lev\u00e9 pour le protocole RDP","text":"<p>L\u2019Objectif est d\u2019assurer la s\u00e9curit\u00e9 des sessions RDP.</p> <p>\u00c9tapes :</p> <p><code>Configuration ordinateur &gt; Mod\u00e8les d\u2019administration &gt; Composants Windows &gt; Services Bureau \u00e0 distance &gt; H\u00f4te de session Bureau \u00e0 distance &gt; S\u00e9curit\u00e9</code></p> <ul> <li>Chiffrement des connexions client : Activ\u00e9, Niveau : Haut</li> </ul>"},{"location":"srv/ad/#26-desactiver-le-compte-invite-sur-tous-les-postes","title":"2.6 D\u00e9sactiver le compte invit\u00e9 sur tous les postes","text":"<p>L\u2019objectif est d\u2019\u00e9viter l\u2019usage du compte Guest car non s\u00e9curis\u00e9.</p> <p>\u00c9tapes :</p> <p><code>Configuration ordinateur &gt; Param\u00e8tres Windows &gt; Param\u00e8tres de s\u00e9curit\u00e9 &gt; Strat\u00e9gies locales &gt; Options de s\u00e9curit\u00e9</code></p> <p>\u2192Comptes : statut du compte invit\u00e9 : D\u00e9sactiv\u00e9</p> <p>Pour v\u00e9rifier, depuis un poste client ouvrir <code>lusrmgr.msc</code> et v\u00e9rifier que le compte invit\u00e9 poss\u00e8de une ic\u00f4ne avec une fl\u00e8che vers le bas.</p> <p>Cette GPO est \u00e0 appliquer sur l\u2019UO Ordinateurs.</p>"},{"location":"srv/ad/#27-implementer-ipsec-avec-authentification-kerberos","title":"2.7 Impl\u00e9menter IPSec avec authentification Kerberos","text":"<p>L\u2019objectif est de s\u00e9curiser les communications entre postes (chiffrement et authentification).</p> <p>\u00c9tapes :</p> <ul> <li>Ouvrir <code>secpol.msc</code> &gt; Strat\u00e9gies IPSec  </li> <li>Cr\u00e9er une strat\u00e9gie : <code>IPSec-Kerberos</code> <code>\u2192</code> Mode de s\u00e9curit\u00e9 : Kerberos</li> </ul> <p>\u2192 Filtrer les communications sensibles (ex. entre contr\u00f4leurs de domaine)</p> <p>Le d\u00e9ploiement se fait via GPO pour toutes les machines mais h\u00e9las nous n\u2019avons pas su trouver le bon filtrage ni r\u00e9ussi \u00e0 trouver la mani\u00e8re de tester cette GPO qui est donc existante sans que nous sachions si elle fonctionne ou non.</p>"},{"location":"srv/ad/#28-entrees-dns-statiques-pour-chaque-machine","title":"2.8. Entr\u00e9es DNS statiques pour chaque machine","text":"<p>L\u2019objectif est d\u2019assurer une r\u00e9solution fiable des noms internes.</p> <p>\u00c9tapes :</p> <p>Dans la console DNS (<code>dnsmgmt.msc</code>) :</p> <ul> <li>Aller dans la zone <code>itway.local</code> </li> <li>Ajouter une nouvelle entr\u00e9e de type A pour chaque machine :   \u2192Nom : <code>SRV-X</code> <code>\u2192</code>IP : <code>172.16.X.X</code></li> </ul>"},{"location":"srv/ad/#29-creation-des-zones-dns-inverses","title":"2.9 Cr\u00e9ation des zones DNS inverses","text":"<p>Cela permet la r\u00e9solution inverse (IP \u2192 nom), cette fonctionnalit\u00e9 est notamment utile pour logs, s\u00e9curit\u00e9, audits.</p> <p>\u00c9tapes :</p> <ul> <li>Console DNS &gt; Zone de recherche invers\u00e9e &gt; Nouvelle zone  </li> <li>Exemple : r\u00e9seau <code>192.168.10.0/24</code> <code>\u2192</code> Zone : <code>10.168.192.in-addr.arpa</code> </li> <li>Ajouter les enregistrements PTR correspondant aux entr\u00e9es A</li> </ul>"},{"location":"srv/ad/#3-configuration-complete-du-serveur-pki-sur-lad","title":"3. Configuration compl\u00e8te du serveur PKI sur l\u2019AD :","text":"<p>Voici l\u2019enregistrement DNS et l\u2019ensemble de la configuration du serveur PKI sur l\u2019active Directory : </p>"},{"location":"srv/ad/#31-creation-de-lenregistrement-dns-pour-srv-pki","title":"3.1 Cr\u00e9ation de l'enregistrement DNS pour SRV-PKI","text":"<p>Depuis le serveur DNS de l\u2019AD (172.16.50.2) :</p> <ul> <li>Ouvrir le Gestionnaire DNS (<code>dnsmgmt.msc</code>)  </li> <li>D\u00e9velopper Zones de recherche directes &gt; itway.local </li> <li>Clic droit sur itway.local &gt; Nouvel h\u00f4te (A ou AAAA)... </li> <li> <p>Remplir les champs suivants :</p> </li> <li> <p>Nom : srv-pki</p> </li> <li> <p>Adresse IP : 172.16.50.3</p> </li> <li> <p>Cocher la case \"Cr\u00e9er un enregistrement de pointeur associ\u00e9\"</p> </li> <li> <p>Cliquer sur Ajouter un h\u00f4te </p> </li> <li>V\u00e9rification de la r\u00e9solution DNS pour le nom d'h\u00f4te srv-pki.itway.local. </li> </ul> <p><code>nslookup srv-pki.itway.local</code></p> <p>R\u00e9sultat attendu : 172.16.50.3 (Cela permet de s'assurer que le syst\u00e8me peut trouver l'adresse IP associ\u00e9e \u00e0 ce nom via le serveur DNS configur\u00e9)</p>"},{"location":"srv/ad/#32-export-du-certificat-racine-depuis-le-serveur-pki","title":"3.2 Export du certificat racine depuis le serveur PKI","text":"<p>Depuis le serveur PKI :</p> <ol> <li>V\u00e9rifier les chemins dans le fichier de configuration qui se trouve dans notre fichier de config ansible suivant :</li> </ol> <p><code># Configuration des chemins</code> <code>pki_ca_dir: \"/etc/pki\"</code> <code>pki_ca_key_name: \"ca.key\"</code> <code>pki_ca_cert_name: \"ca.crt\"</code> <code>pki_openssl_conf: \"/etc/ssl/openssl.cnf\"</code></p> <p>Donc le chemin complet du ca.crt est  : <code>/etc/pki/certs/ca.crt</code></p> <ol> <li>Convertir le certificat en format compatible Windows :</li> </ol> <p>Depuis le serveur PKI (Debian) : <code>openssl x509 -in /etc/pki/certs/ca.crt -out  /etc/pki/certs/ca.cer -outform DER</code></p> <p>Cette commande convertit un certificat depuis un format .crt en PEM vers un .cer en DER compatible avec Windows.</p>"},{"location":"srv/ad/#33-transfert-du-certificat-vers-le-controleur-de-domaine","title":"3.3 Transfert du certificat vers le contr\u00f4leur de domaine","text":"<ol> <li>Cr\u00e9er un r\u00e9pertoire de r\u00e9ception sur le contr\u00f4leur de domaine pour y stocker notre certificat :</li> </ol> <p><code>mkdir C:\\Certs</code></p> <ol> <li>V\u00e9rifier que la disponibilit\u00e9 du service SSH :</li> </ol> <p>Nous avons besoin du service ssh sur windows pour effectuer notre transfert de certificat depuis le serveur PKI vers notre contr\u00f4leur de domaine. Il faut donc v\u00e9rifier d\u2019abord s\u2019il est bien install\u00e9. Ouvrir PowerShell en administrateur sur le serveur Windows et v\u00e9rifier s\u2019il est en cours d\u2019ex\u00e9cution :  <code>Get-Service sshd</code></p> <p>Si le statut est \"Running\", alors tout est ok. Sinon, il faut le d\u00e9marrer : <code>Start-Service sshd</code></p> <p>Et s\u2019il appara\u00eet impossible de trouver un service assorti du nom \u201csshd\u201d, il faut l\u2019installer. <code>Get-WindowsCapability -Online | Where-Object Name -like 'OpenSSH*'</code></p> <p>V\u00e9rifier s\u2019il le service est install\u00e9s c\u00f4t\u00e9 client et serveur, sinon installer celui qui est manquant, dans notre cas il nous manquait le serveur que nous avons t\u00e9l\u00e9charg\u00e9 et install\u00e9 :  <code>Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0</code></p> <p>Puis v\u00e9rifier l\u2019installation :  <code>Get-Service sshd</code></p> <p>Si tout s\u2019est bien pass\u00e9, le service sera list\u00e9, probablement avec le statut \u201cStopped\u201d, alors il faudra le d\u00e9marrer :  <code>Start-Service sshd</code></p> <ol> <li>Transf\u00e9rer le certificat :</li> </ol> <p>Maintenant que tout est pr\u00eat, il faut copier le certificat ca.cer sur le contr\u00f4leur de domaine :  <code>scp /etc/pki/certs/ca.cer Administrator@172.16.50.2:C:\\Certs</code></p> <p>La commande scp (Secure Copy) est utilis\u00e9e pour transf\u00e9rer des fichiers de mani\u00e8re s\u00e9curis\u00e9e entre des syst\u00e8mes (locaux et distants ou bien 2 syst\u00e8mes distants).</p>"},{"location":"srv/ad/#34-deploiement-du-certificat-racine-via-gpo","title":"3.4 D\u00e9ploiement du certificat racine via GPO","text":"<p>Sur le contr\u00f4leur de domaine (172.16.50.2) :</p> <ol> <li>Ouvrir la console de gestion des strat\u00e9gies de groupe : gpmc.msc  </li> <li>Cr\u00e9er une nouvelle GPO ou modifier une existante :  </li> <li>Aller dans For\u00eat &gt; Domaines &gt; itway.local  </li> <li>Clic droit sur Objet de strat\u00e9gie de groupe &gt; Nouveau  </li> <li>Nommer la GPO : D\u00e9ploiement Certificat Racine  </li> <li>\u00c9diter la GPO :  </li> <li>Aller dans Configuration ordinateur &gt; Strat\u00e9gies &gt; Param\u00e8tres Windows &gt; Param\u00e8tres de s\u00e9curit\u00e9 &gt; Strat\u00e9gies de cl\u00e9 publique &gt; Autorit\u00e9s de certification racines de confiance  </li> <li>Clic droit &gt; Importer  </li> <li>S\u00e9lectionner C:\\Certs\\ca.cer et valider  </li> <li>Appliquer la GPO aux unit\u00e9s organisationnelles souhait\u00e9es :  </li> <li>Dans la console de gestion des strat\u00e9gies de groupe (gpmc.msc), naviguer jusqu'\u00e0 la GPO D\u00e9ploiement Certificat Racine.  </li> <li>Clic droit sur la GPO &gt; Lier un objet de strat\u00e9gie de groupe existant.  </li> <li>S\u00e9lectionner l'unit\u00e9 organisationnelle (OU) contenant les ordinateurs concern\u00e9s.  </li> <li>Valider et fermer la console.  </li> <li>Forcer la mise \u00e0 jour des strat\u00e9gies sur le contr\u00f4leur de domaine : <code>gpupdate /force</code> </li> <li>V\u00e9rification de l\u2019application de la GPO sur le domaine : <code>gpresult /r</code></li> </ol>"},{"location":"srv/ad/#35-verification-sur-un-poste-client","title":"3.5. V\u00e9rification sur un poste client","text":"<ol> <li> <p>Aller dans le Panneau de configuration &gt; Options Internet &gt; Contenu &gt; Certificats &gt; Autorit\u00e9s de certification (ou certmgr.msc dans la barre de recherches)</p> </li> <li> <p>Dans l\u2019onglet Autorit\u00e9s de certification racines de confiance, v\u00e9rifier la pr\u00e9sence du certificat srv-pki.itway.local</p> </li> </ol> <p>Pour terminer : </p> <ul> <li>Chaque GPO a \u00e9t\u00e9 plac\u00e9e dans l\u2019OU qui nous a sembl\u00e9 adapt\u00e9e ou \u00e0 la racine  </li> <li>Toutes les GPO ont \u00e9t\u00e9 forc\u00e9es avec la commande gpupdate /force</li> </ul>"},{"location":"srv/brouillon/","title":"Serveur Mail SRV-MAIL : Cours Complet &amp; Guide de Mise en Place","text":""},{"location":"srv/brouillon/#1-introduction-quest-ce-quun-serveur-mail","title":"1. Introduction : Qu'est-ce qu'un serveur mail ?","text":"<p>Un serveur de messagerie (ou serveur mail) est une machine charg\u00e9e de transmettre, recevoir et stocker les courriels (\u00e9mails). Il est constitu\u00e9 de plusieurs composants logiciels, chacun assurant une fonction bien d\u00e9finie :</p> <ul> <li>MTA (Mail Transfer Agent) : transmet les mails d'un serveur \u00e0 un autre (Postfix)</li> <li>MDA (Mail Delivery Agent) : d\u00e9livre le mail dans la bo\u00eete de r\u00e9ception (Dovecot)</li> <li>IMAP/POP3 : protocoles permettant aux clients (Serveur SMTP) de r\u00e9cup\u00e9rer leurs mails</li> <li>SMTP : protocole d\u2019envoi des mails</li> </ul> <p>Dans ce projet, nous construisons un serveur MDA + IMAP/POP.</p>"},{"location":"srv/brouillon/#2-role-de-srv-mail-dans-linfrastructure","title":"2. R\u00f4le de SRV-MAIL dans l'infrastructure","text":"H\u00f4te Domaine OS R\u00f4le principal SRV-MAIL srv-mail.itway.local Debian Stockage et distribution des e-mails internes <p>Le serveur SRV-MAIL re\u00e7oit les mails transmis par DMZ-SMTP, les stocke dans des bo\u00eetes utilisateurs, et les met \u00e0 disposition via IMAP/POP. Il utilise une base MariaDB pour g\u00e9rer les comptes, via l\u2019interface PostfixAdmin.</p>"},{"location":"srv/brouillon/#3-solutions-logicielles-choisies","title":"3. Solutions logicielles choisies","text":"Fonction Logiciel choisi Raison du choix MDA / SMTP local Postfix L\u00e9ger, tr\u00e8s populaire, facile \u00e0 int\u00e9grer avec Dovecot IMAP/POP3 Dovecot Performance, s\u00e9curit\u00e9, support SQL Base de donn\u00e9es MariaDB Fiable, communautaire, compatible MySQL Interface admin PostfixAdmin Interface web simple pour g\u00e9rer domaines/utilisateurs Authentification Dovecot SQL Permet l\u2019auth avec une base MariaDB"},{"location":"srv/brouillon/#4-protocoles-de-messagerie-utilises","title":"4. Protocoles de messagerie utilis\u00e9s","text":"Protocole Port Utilit\u00e9 SMTP 25 Envoi de mails (entre serveurs) SMTPS 465 Envoi de mails avec SSL (depuis clients) Submission 587 Envoi de mails avec authentification (STARTTLS) IMAP 143 R\u00e9cup\u00e9ration des mails depuis un client IMAPS 993 Idem, avec chiffrage SSL POP3 110 R\u00e9cup\u00e9ration, suppression locale des mails POP3S 995 POP3 chiffr\u00e9 <p>Dovecot est responsable de la gestion IMAP/POP, tandis que Postfix g\u00e8re SMTPS (465).</p>"},{"location":"srv/brouillon/#5-architecture-fonctionnelle-de-srv-mail","title":"5. Architecture fonctionnelle de SRV-MAIL","text":"<pre><code>Client mail  &lt;--- IMAP/POP3 (SSL) ---&gt;  SRV-MAIL  &lt;--- SMTP --- DMZ-SMTP  &lt;--&gt; Internet\n                            ^\n                            |\n                  MariaDB (auth, bo\u00eetes)\n                            |\n                     PostfixAdmin (admin web)\n</code></pre>"},{"location":"srv/brouillon/#6-mise-en-place-technique","title":"6. Mise en place technique","text":""},{"location":"srv/brouillon/#a-securisation-ssltls","title":"a. S\u00e9curisation SSL/TLS","text":"<ul> <li>Certificat g\u00e9n\u00e9r\u00e9 par le serveur SRV-PKI interne</li> <li>D\u00e9ploy\u00e9 dans <code>/etc/postfix/ssl</code></li> <li>Utilis\u00e9 pour chiffrer SMTPS/IMAPS</li> </ul>"},{"location":"srv/brouillon/#b-stockage-des-mails","title":"b. Stockage des mails","text":"<ul> <li>Format Maildir dans <code>/var/mail/vhosts/&lt;domaine&gt;/&lt;utilisateur&gt;/Maildir/</code></li> <li>Droit utilisateur <code>vmail</code> UID/GID 5000</li> </ul>"},{"location":"srv/brouillon/#c-authentification-sql","title":"c. Authentification SQL","text":"<ul> <li>Dovecot interroge MariaDB pour valider les utilisateurs</li> <li>Requ\u00eates SQL d\u00e9finies dans <code>dovecot-sql.conf.ext</code></li> </ul>"},{"location":"srv/brouillon/#d-postfixadmin","title":"d. PostfixAdmin","text":"<ul> <li>Interface de gestion des bo\u00eetes</li> <li>Setup via <code>config.local.php</code> + mot de passe chiffr\u00e9</li> </ul>"},{"location":"srv/brouillon/#e-integration-avec-dmz-smtp","title":"e. Int\u00e9gration avec DMZ-SMTP","text":"<ul> <li>DMZ-SMTP relaie tous les mails entrants vers SRV-MAIL</li> <li>SRV-MAIL ne communique pas directement avec Internet</li> </ul>"},{"location":"srv/brouillon/#7-bonnes-pratiques-mises-en-place","title":"7. Bonnes pratiques mises en place","text":"<ul> <li>Services accessibles uniquement en TLS : SMTPS, IMAPS</li> <li>Aucune auth en clair autoris\u00e9e (<code>disable_plaintext_auth = yes</code>)</li> <li>Utilisation d'un utilisateur syst\u00e8me d\u00e9di\u00e9 <code>vmail</code></li> <li>Acc\u00e8s limit\u00e9s \u00e0 MariaDB avec utilisateurs sp\u00e9cifiques</li> <li>Structure des r\u00e9pertoires conforme Maildir</li> <li>Gestion via Ansible et Vault (pas de mot de passe en clair)</li> </ul>"},{"location":"srv/brouillon/#8-configuration-technique-playbook-ansible","title":"8. Configuration technique (Playbook Ansible)","text":"<p>\u27a1\ufe0f Voir tous les r\u00f4les, templates et playbooks ici : \ud83d\udcc1 R\u00e9pertoire Ansible SRV-MAIL</p>"},{"location":"srv/brouillon/#9-conclusion","title":"9. Conclusion","text":"<p>Le serveur SRV-MAIL constitue une brique centrale de l'infrastructure ITWay.</p> <p>En s'appuyant sur des composants open source robustes (Postfix, Dovecot, MariaDB), il permet de distribuer les e-mails de mani\u00e8re s\u00e9curis\u00e9e \u00e0 tous les utilisateurs internes, tout en \u00e9tant administrable et extensible.</p> <p>La s\u00e9paration des r\u00f4les (DMZ-SMTP pour le relai, SRV-MAIL pour le stockage) permet un contr\u00f4le granulaire de la s\u00e9curit\u00e9, tout en r\u00e9pondant aux bonnes pratiques syst\u00e8me et r\u00e9seau.</p> <p>Parfait ! J\u2019ai maintenant tous les \u00e9l\u00e9ments n\u00e9cessaires pour r\u00e9diger la documentation du serveur SRV-MAIL, dans le m\u00eame style et la m\u00eame structure que celle du PKI.</p> <p>Voici la documentation compl\u00e8te et homog\u00e8ne :</p>"},{"location":"srv/mail/","title":"SRV-MAIL (<code>srv-mail.itway.local</code>)","text":"<p>Playbook Ansible complet</p>"},{"location":"srv/mail/#1-objectifs","title":"1. Objectifs","text":"<p>Le serveur SRV-MAIL agit comme MDA (Mail Delivery Agent) et serveur IMAP/POP. Il est charg\u00e9 de :</p> <ul> <li>Stocker les mails des utilisateurs dans des bo\u00eetes aux lettres locales,</li> <li>Permettre leur consultation via IMAP/POP (par des clients comme Thunderbird),</li> <li>Recevoir les messages transmis par la passerelle SMTP externe (DMZ-SMTP),</li> <li>Centraliser la gestion des utilisateurs via une base MariaDB.</li> </ul>"},{"location":"srv/mail/#2-presentation-du-service","title":"2. Pr\u00e9sentation du service","text":"<p>Le r\u00f4le de SRV-MAIL est d\u2019assurer la r\u00e9ception, la consultation et l\u2019archivage s\u00e9curis\u00e9 des mails internes \u00e0 l\u2019entreprise. Il comprend plusieurs briques essentielles :</p> Service R\u00f4le Postfix MDA local (r\u00e9ception et distribution de mail vers les bo\u00eetes) Dovecot Serveur IMAP/POP (consultation des mails par les clients) MariaDB Stockage des comptes, domaines, et mots de passe PostfixAdmin Interface web d\u2019administration pour Postfix et Dovecot <p>Le serveur n\u2019envoie pas de mails directement vers l\u2019ext\u00e9rieur. Ce r\u00f4le est d\u00e9l\u00e9gu\u00e9 au serveur DMZ-SMTP.</p>"},{"location":"srv/mail/#21-quest-ce-quun-serveur-mail","title":"2.1 Qu\u2019est-ce qu\u2019un serveur mail ?","text":"<p>Un serveur mail est une machine qui g\u00e8re l\u2019envoi, la r\u00e9ception, la distribution et la consultation des courriels.</p> <p>On distingue plusieurs r\u00f4les :</p> R\u00f4le Description MTA (Mail Transfer Agent) Transf\u00e8re les mails entre serveurs (SMTP) MDA (Mail Delivery Agent) D\u00e9pose les mails dans les bo\u00eetes locales IMAP/POP Permet aux clients (Thunderbird, Outlook\u2026) de consulter leurs mails"},{"location":"srv/mail/#22-les-services-utilises-dans-le-projet","title":"2.2 Les services utilis\u00e9s dans le projet","text":""},{"location":"srv/mail/#1-postfix-mda","title":"1. Postfix (MDA)","text":"<ul> <li>Fonction : re\u00e7oit les mails (en provenance de DMZ-SMTP) et les d\u00e9pose dans les bo\u00eetes locales sur <code>/home/vmail/</code>.</li> <li>Il agit aussi comme MTA (envoi sortant), mais dans le projet, ce r\u00f4le est d\u00e9l\u00e9gu\u00e9 \u00e0 DMZ-SMTP.</li> <li>Fichier principal : <code>/etc/postfix/main.cf</code></li> </ul> <p>Ports utilis\u00e9s :</p> Port Protocole Utilisation TLS 25 SMTP Standard MTA (inbound mail) Pas de TLS obligatoire 465 SMTPS SMTP chiffr\u00e9 directement TLS d\u00e8s la connexion <p>Postfix est surtout sollicit\u00e9 en interne (port 25 entre DMZ-SMTP \u2192 SRV-MAIL).</p>"},{"location":"srv/mail/#2-dovecot-imappop","title":"2. Dovecot (IMAP/POP)","text":"<ul> <li>Fonction : permet aux utilisateurs de lire leurs mails (messages d\u00e9pos\u00e9s par Postfix)</li> <li>Supporte :<ul> <li>IMAP (synchronisation des mails sur plusieurs appareils)</li> <li>POP3 (t\u00e9l\u00e9chargement local des mails, sans conservation sur le serveur)</li> </ul> </li> </ul> <p>Ports utilis\u00e9s :</p> Port Protocole Utilisation TLS 143 IMAP IMAP classique STARTTLS 993 IMAPS IMAP avec TLS direct TLS 110 POP3 POP non s\u00e9curis\u00e9 Aucun 995 POP3S POP s\u00e9curis\u00e9 TLS <p>Dans une config s\u00e9curis\u00e9e, on privil\u00e9gie IMAP sur TLS (993).</p>"},{"location":"srv/mail/#3-mariadb-backend-des-comptes-mails","title":"3. MariaDB (Backend des comptes mails)","text":"<ul> <li>Fonction : stocke les utilisateurs, mots de passe, domaines, etc.</li> <li>Utilis\u00e9 par :<ul> <li>Postfix (pour savoir \"cet utilisateur existe-t-il ?\")</li> <li>Dovecot (pour valider l\u2019authentification IMAP)</li> <li>PostfixAdmin (interface de gestion)</li> </ul> </li> </ul> <p>Les mots de passe y sont stock\u00e9s hach\u00e9s (SHA512 ou MD5).</p>"},{"location":"srv/mail/#4-postfixadmin-interface-web-php","title":"4. PostfixAdmin (interface Web PHP)","text":"<ul> <li> <p>Fonction : permet \u00e0 l\u2019admin de :</p> </li> <li> <p>cr\u00e9er des utilisateurs</p> </li> <li>g\u00e9rer les domaines</li> <li>ajouter des redirections, alias, etc.</li> <li>Fonctionne avec Apache2 ou Nginx, en PHP</li> </ul>"},{"location":"srv/mail/#23-schema-simplifie-de-fonctionnement","title":"2.3 Sch\u00e9ma simplifi\u00e9 de fonctionnement","text":"<pre><code>+----------------+           +-------------+            +--------------+\n| Utilisateur    |  IMAP     |   Dovecot   |            |              |\n| (Thunderbird)  +---------&gt; | (IMAP/POP)  | &lt;--------+ | /home/vmail/ |\n+----------------+           +-------------+            +--------------+\n                                                             \u25b2\n                                                             |  \n                                                   (Maildir = bo\u00eetes locales)\n                                                             \u25b2\n+------------------+    SMTP     +------------+              |\n| DMZ-SMTP         +-----------&gt; |  Postfix   +--------------+\n| (relais d\u2019entr\u00e9e)|             |  (MDA)     |\n+------------------+             +------------+\n                                        |\n                          Utilise MySQL/MariaDB pour comptes\n</code></pre>"},{"location":"srv/mail/#3-role-dans-linfrastructure-itway","title":"3. R\u00f4le dans l'infrastructure ITWay","text":"<p>Dans l\u2019infrastructure ITWay, le serveur SRV-MAIL joue un r\u00f4le essentiel dans la gestion des courriels internes. Voici une explication claire de ce qu\u2019il fait pr\u00e9cis\u00e9ment :</p> <ol> <li>R\u00e9ception des mails internes et externes<ul> <li>Il re\u00e7oit les mails depuis DMZ-SMTP (le relais en DMZ),</li> <li>Et il les distribue aux bo\u00eetes mail des utilisateurs.</li> </ul> </li> <li>Stockage des messages<ul> <li>Les mails sont conserv\u00e9s en base de donn\u00e9es et accessibles \u00e0 tout moment via IMAP s\u00e9curis\u00e9 (port 993).</li> </ul> </li> <li>Distribution aux clients mail<ul> <li>Il sert les mails aux clients (Roundcube) via Dovecot (IMAP),</li> <li>Les utilisateurs acc\u00e8dent \u00e0 leurs mails en toute s\u00e9curit\u00e9, depuis leur poste.</li> </ul> </li> <li> <p>Gestion des utilisateurs et domaines</p> <ul> <li>Gr\u00e2ce \u00e0 PostfixAdmin, l\u2019administrateur peut cr\u00e9er/modifier :<pre><code>  - les adresses mail,\n  - les domaines,\n  - les bo\u00eetes aux lettres virtuelles.\n</code></pre> </li> </ul> </li> <li> <p>Utilisation de bases SQL (MySQL/MariaDB)</p> <ul> <li>Les comptes et mots de passe sont stock\u00e9s dans une base s\u00e9curis\u00e9e,</li> <li>Cela permet une gestion souple, automatis\u00e9e et \u00e9volutive des utilisateurs.</li> </ul> </li> </ol>"},{"location":"srv/mail/#4-justification-des-choix","title":"4. Justification des choix","text":"<ul> <li>MTA/MDA : Postfix (mode bo\u00eete aux lettres locales)</li> <li>IMAP/POP : Dovecot (acc\u00e8s aux messages)</li> <li>Base de donn\u00e9es : MariaDB (authentification, bo\u00eetes)</li> <li>Interface web : PostfixAdmin</li> <li>Outils : Ansible pour l'automatisation</li> </ul> <p>Pourquoi ces choix ?</p> <ul> <li>Compatibilit\u00e9 entre services (Postfix + Dovecot + PostfixAdmin),</li> <li>Open-source, document\u00e9, standard,</li> </ul>"},{"location":"srv/mail/#5-structure-du-projet","title":"5. Structure du projet","text":"<pre><code>\u251c\u2500\u2500 ansible.cfg\n\u251c\u2500\u2500 inventory/\n\u2502   \u251c\u2500\u2500 hosts.ini\n|   \u2514\u2500\u2500 group_vars/\n|       \u2514\u2500\u2500 srv-mail/\n|           \u251c\u2500\u2500 main.yml\n|           \u2514\u2500\u2500 vault.yml\n\u251c\u2500\u2500 playbooks/\n\u2502   \u2514\u2500\u2500 setup-mail.yml\n\u2514\u2500\u2500 roles/\n    \u2514\u2500\u2500 srv-mail/\n        \u251c\u2500\u2500 handlers/\n        \u2502   \u2514\u2500\u2500 main.yml\n        \u251c\u2500\u2500 tasks/\n        \u2502   \u251c\u2500\u2500 main.yml\n        |   \u251c\u2500\u2500 apache_https.yml\n        |   \u251c\u2500\u2500 cert.yml\n        |   \u251c\u2500\u2500 dovecot-ldap.yml\n        |   \u251c\u2500\u2500 dovecot-sql.yml\n        |   \u251c\u2500\u2500 mysql_setup.yml\n        |   \u2514\u2500\u2500 postfixadmin.yml\n        \u2514\u2500\u2500 templates/\n            \u251c\u2500\u2500 dovecot-ldap.conf.ext.j2 \n            \u251c\u2500\u2500 dovecot-sql.conf.ext.j2\n            \u251c\u2500\u2500 dovecot.conf.j2\n            \u251c\u2500\u2500 postfixadmin-ssl.conf.j2\n            \u251c\u2500\u2500 main.cf.j2\n            \u2514\u2500\u2500 master.cf.j2 \n</code></pre>"},{"location":"srv/mail/#6-ce-que-fait-le-playbook-ansible","title":"6. Ce que fait le Playbook Ansible","text":""},{"location":"srv/mail/#resume-global-des-taches-du-role-srv-mail","title":"R\u00e9sum\u00e9 global des t\u00e2ches du r\u00f4le <code>srv-mail</code>","text":"<p>Le r\u00f4le <code>srv-mail</code> automatise l'installation compl\u00e8te d\u2019un serveur de messagerie s\u00e9curis\u00e9, incluant Postfix, Dovecot, MariaDB, LDAP, PostfixAdmin et HTTPS.</p>"},{"location":"srv/mail/#1-installation-des-paquets-necessaires","title":"1. Installation des paquets n\u00e9cessaires","text":"<p>Les composants principaux :</p> <ul> <li>Postfix (serveur SMTP)</li> <li>Dovecot (serveur IMAP/POP3)</li> <li>MariaDB (base de donn\u00e9es)</li> <li>PostfixAdmin (interface web de gestion)</li> <li>Modules LDAP &amp; SQL pour l'authentification</li> </ul>"},{"location":"srv/mail/#2-generation-et-deploiement-du-certificat-ssl","title":"2. G\u00e9n\u00e9ration et d\u00e9ploiement du certificat SSL","text":"<ul> <li>Cr\u00e9ation de la cl\u00e9 priv\u00e9e et de la CSR sur SRV-MAIL</li> <li>Envoi de la CSR vers SRV-PKI pour signature</li> <li>R\u00e9cup\u00e9ration et d\u00e9ploiement du certificat sign\u00e9 + CA</li> </ul> <p>Permet de chiffrer les connexions (IMAPS/SMTPS/HTTPS)</p>"},{"location":"srv/mail/#3-configuration-de-postfix","title":"3. Configuration de Postfix","text":"<ul> <li>D\u00e9ploiement des fichiers <code>main.cf</code> et <code>master.cf</code> via templates</li> <li>Red\u00e9marrage automatique de Postfix en cas de modification</li> </ul>"},{"location":"srv/mail/#4-configuration-de-dovecot","title":"4. Configuration de Dovecot","text":"<ul> <li>D\u00e9ploiement de <code>10-ssl.conf</code> (connexion s\u00e9curis\u00e9e)</li> <li>Support de l'authentification LDAP via <code>dovecot-ldap.yml</code></li> <li>(Comment\u00e9) Auth SQL si activ\u00e9 via <code>dovecot-sql.yml</code></li> <li>S\u00e9curisation du fichier <code>10-auth.conf</code> (authentification stricte)</li> <li>Ajout d\u2019un socket partag\u00e9 pour compatibilit\u00e9 avec PostfixAdmin</li> </ul>"},{"location":"srv/mail/#5-configuration-de-mariadb","title":"5. Configuration de MariaDB","text":"<ul> <li>Installation de MariaDB + client + d\u00e9pendance Python</li> <li>Lancement manuel en environnement conteneuris\u00e9 (sans systemd)</li> <li> <p>Cr\u00e9ation des bases de donn\u00e9es et utilisateurs :</p> <ul> <li><code>roundcube</code> (webmail)</li> <li><code>postfixadmin</code> (interface admin)</li> </ul> </li> </ul>"},{"location":"srv/mail/#6-configuration-de-postfixadmin-interface-web","title":"6. Configuration de PostfixAdmin (interface web)","text":"<ul> <li>Pr\u00e9paration du cache (<code>templates_c</code>)</li> <li>Lien symbolique vers le r\u00e9pertoire de cache</li> <li>Cr\u00e9ation de la base et de l'utilisateur SQL</li> <li> <p>Activation de la configuration HTTPS via Apache :</p> <ul> <li>Module SSL</li> <li>Fichier <code>postfixadmin-ssl.conf</code></li> <li>Site Apache s\u00e9curis\u00e9 activ\u00e9 (<code>a2ensite</code>)</li> </ul> </li> </ul>"},{"location":"srv/mail/#7-fichiers-de-configuration","title":"7. Fichiers de configuration","text":""},{"location":"srv/mail/#dovecot-ldapconfextj2","title":"<code>dovecot-ldap.conf.ext.j2</code>","text":"<p>Ce fichier configure Dovecot pour l\u2019authentification des utilisateurs via un annuaire LDAP. Au lieu de stocker les utilisateurs localement ou dans une base SQL, Dovecot va interroger un serveur LDAP (comme Active Directory) pour :</p> <p>v\u00e9rifier les identifiants de connexion des utilisateurs,</p> <p>r\u00e9cup\u00e9rer des informations comme leur r\u00e9pertoire de mails (maildir) et leur UID/GID syst\u00e8me.</p> <p>Ce mode est particuli\u00e8rement utilis\u00e9 dans les infrastructures o\u00f9 l\u2019identit\u00e9 des utilisateurs est centralis\u00e9e (par ex. : un seul compte pour mail, VPN, intranet\u2026).</p>"},{"location":"srv/mail/#contenu-du-fichier","title":"Contenu du fichier","text":"<pre><code>uris = {{ dovecot_ldap_uri }}\n\ndn = {{ dovecot_ldap_bind_dn }}\ndnpass = {{ dovecot_ldap_bind_pw }}\n\nauth_bind = yes\nldap_version = 3\n\nbase = {{ dovecot_ldap_base }}\nscope = subtree\n\nuser_attrs = \\\n  =home=/var/vmail/%d/%n, \\\n  =mail=maildir:/var/vmail/%d/%n/Maildir, \\\n  =uid=vmail, \\\n  =gid=vmail\n\nuser_filter = (&amp;(objectClass=user)(sAMAccountName=%n))\npass_filter = (&amp;(objectClass=user)(sAMAccountName=%n))\n</code></pre>"},{"location":"srv/mail/#description-des-parametres","title":"Description des param\u00e8tres","text":"Directive Description <code>uris</code> L'adresse du serveur LDAP, au format <code>ldap://&lt;h\u00f4te&gt;:&lt;port&gt;</code> (ex : <code>ldap://ldap.itway.local</code>) \u2014 c\u2019est ici que Dovecot va se connecter pour interroger l\u2019annuaire. <code>dn</code> Le Distinguished Name (DN) du compte utilis\u00e9 pour se connecter \u00e0 LDAP (souvent un compte de service). <code>dnpass</code> Le mot de passe associ\u00e9 au DN ci-dessus. <code>auth_bind</code> Active la liaison dynamique : l\u2019utilisateur LDAP s\u2019authentifie avec ses propres identifiants (et non ceux du service). <code>ldap_version</code> Version du protocole LDAP utilis\u00e9e (3 = la plus r\u00e9cente, standard). <code>base</code> Le DN de base de recherche dans LDAP (ex : <code>dc=itway,dc=local</code>). <code>scope</code> \u00c9tendue de la recherche (<code>subtree</code> = recherche r\u00e9cursive dans tous les sous-niveaux du DN de base). <code>user_attrs</code> Attributs LDAP mapp\u00e9s vers les attributs internes de Dovecot (chemin maildir, UID, GID, etc.). <code>user_filter</code> Filtre LDAP pour retrouver l\u2019utilisateur, bas\u00e9 sur son <code>sAMAccountName</code>. <code>%n</code> = login sans domaine. <code>pass_filter</code> M\u00eame chose, mais pour trouver le mot de passe correspondant."},{"location":"srv/mail/#dovecotconfj2","title":"<code>dovecot.conf.j2</code>","text":"<p>Ce fichier permet de configurer la s\u00e9curit\u00e9 TLS/SSL de Dovecot, le serveur IMAP/POP3 utilis\u00e9 pour acc\u00e9der aux bo\u00eetes mail. Il assure que toutes les connexions entre les clients de messagerie (Thunderbird, Roundcube\u2026) et le serveur passent par une connexion chiffr\u00e9e gr\u00e2ce \u00e0 un certificat sign\u00e9 par une autorit\u00e9 de certification (CA).</p> <p>Sans ce fichier ou sans configuration SSL, les mots de passe des utilisateurs peuvent transiter en clair.</p>"},{"location":"srv/mail/#contenu-du-fichier_1","title":"Contenu du fichier :","text":"<pre><code>ssl = required\nssl_cert = &lt;{{ ssl_dir }}/{{ crt_filename }}\nssl_key = &lt;{{ ssl_dir }}/{{ key_filename }}\nssl_ca  = &lt;{{ ssl_dir }}/{{ ca_filename }}\n</code></pre>"},{"location":"srv/mail/#description-des-parametres_1","title":"Description des param\u00e8tres :","text":"Directive Description <code>ssl = required</code> Force l\u2019utilisation de SSL/TLS pour toutes les connexions (emp\u00eache les connexions non s\u00e9curis\u00e9es). <code>ssl_cert</code> Chemin vers le fichier de certificat SSL/TLS du serveur Dovecot, sign\u00e9 par la CA (<code>srv-mail.crt</code>). <code>ssl_key</code> Chemin vers la cl\u00e9 priv\u00e9e du certificat (<code>srv-mail.key</code>). Ce fichier doit rester confidentiel. <code>ssl_ca</code> Chemin vers le certificat de l\u2019autorit\u00e9 de certification (CA) qui a sign\u00e9 le certificat serveur. Permet aux clients de v\u00e9rifier l\u2019authenticit\u00e9 de la connexion."},{"location":"srv/mail/#maincfj2","title":"<code>main.cf.j2</code>","text":"<p>Ce fichier est le fichier principal de configuration de Postfix. Il d\u00e9finit :</p> <ul> <li> <p>l\u2019identit\u00e9 du serveur,</p> </li> <li> <p>comment il envoie/re\u00e7oit des e-mails,</p> </li> <li> <p>comment il g\u00e8re la s\u00e9curit\u00e9 TLS/SSL,</p> </li> <li> <p>et quelles sont les restrictions d\u2019acc\u00e8s pour \u00e9viter d\u2019\u00eatre utilis\u00e9 comme relais ouvert (SPAM).</p> </li> </ul>"},{"location":"srv/mail/#contenu-du-fichier_2","title":"Contenu du fichier","text":"<pre><code>myhostname = {{ mail_fqdn }}\nmydomain = itway.local\nmyorigin = $mydomain\ninet_interfaces = all\nmydestination = $myhostname, localhost.$mydomain, localhost\nrelayhost = [mail.itway.fr]:25\n\n# TLS\nsmtpd_tls_cert_file = {{ ssl_dir }}/{{ crt_filename }}\nsmtpd_tls_key_file  = {{ ssl_dir }}/{{ key_filename }}\nsmtpd_tls_CAfile    = {{ ssl_dir }}/{{ ca_filename }}\nsmtpd_use_tls = yes\nsmtpd_tls_security_level = encrypt\n\n# Restrictions d'acc\u00e8s\nsmtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination\n\n# S\u00e9curit\u00e9 suppl\u00e9mentaire\ndisable_vrfy_command = yes\nsmtpd_helo_required = yes\nsmtpd_tls_auth_only = yes\n#smtpd_tls_loglevel = 1\ntls_random_source = dev:/dev/urandom\n</code></pre>"},{"location":"srv/mail/#description-des-parametres_2","title":"Description des param\u00e8tres","text":"Directive Description <code>myhostname</code> Nom FQDN du serveur mail (ex. <code>srv-mail.itway.local</code>). <code>mydomain</code> Domaine auquel appartient le serveur (souvent identique \u00e0 <code>itway.local</code>). <code>myorigin</code> Domaine utilis\u00e9 pour les mails sortants (ex : <code>user@itway.local</code>). <code>inet_interfaces = all</code> Postfix \u00e9coute sur toutes les interfaces r\u00e9seau (utile pour VM/conteneurs). <code>mydestination</code> Liste des noms que le serveur consid\u00e8re comme locaux (il accepte les mails pour ces domaines). <code>relayhost</code> La directive <code>relayhost = [mail.itway.fr]:25</code> permet de rediriger tous les mails sortants du serveur interne vers le relais SMTP situ\u00e9 en DMZ (DMZ-SMTP), configur\u00e9 en passerelle s\u00e9curis\u00e9e vers Internet."},{"location":"srv/mail/#section-tls","title":"Section TLS","text":"Directive Description <code>smtpd_tls_cert_file</code> Chemin vers le certificat SSL public. <code>smtpd_tls_key_file</code> Chemin vers la cl\u00e9 priv\u00e9e du serveur. <code>smtpd_tls_CAfile</code> Certificat de la CA utilis\u00e9e pour valider les connexions. <code>smtpd_use_tls</code> Active le TLS pour les connexions entrantes (clients ou autres serveurs SMTP). <code>smtpd_tls_security_level = encrypt</code> Imposera le chiffrement (TLS) lors des \u00e9changes."},{"location":"srv/mail/#restrictions-dacces-et-securite","title":"Restrictions d'acc\u00e8s et s\u00e9curit\u00e9","text":"Directive Description <code>smtpd_relay_restrictions</code> R\u00e8gles de relais : n'autorise l'envoi de mails qu'\u00e0 partir du r\u00e9seau local ou si l'utilisateur est authentifi\u00e9. <code>disable_vrfy_command</code> D\u00e9sactive la commande SMTP <code>VRFY</code> pour emp\u00eacher la d\u00e9tection de comptes valides par les bots. <code>smtpd_helo_required</code> Oblige les clients SMTP \u00e0 s'identifier avec <code>HELO</code>. <code>smtpd_tls_auth_only</code> Refuse l\u2019authentification en clair si TLS n\u2019est pas activ\u00e9. <code>tls_random_source</code> Source d\u2019al\u00e9a utilis\u00e9e pour g\u00e9n\u00e9rer des cl\u00e9s de session TLS."},{"location":"srv/mail/#mastercfj2","title":"<code>master.cf.j2</code>","text":"<p>Le fichier <code>master.cf</code> compl\u00e8te la configuration de Postfix. Il d\u00e9finit les services de transport r\u00e9seau que Postfix propose, notamment :</p> <ul> <li> <p>le SMTP standard (port 25),</p> </li> <li> <p>le SMTPS (port 465),</p> </li> <li> <p>et le Submission (port 587).</p> </li> </ul> <p>Chaque service peut avoir ses propres options, notamment en ce qui concerne le chiffrement TLS, l\u2019authentification SASL, et le mode de fonctionnement (wrapper vs starttls).</p> <p>Ce fichier est crucial pour permettre aux clients mail externes (Thunderbird, Roundcube, etc.) d\u2019envoyer des messages via un canal s\u00e9curis\u00e9.</p>"},{"location":"srv/mail/#contenu-du-fichier_3","title":"Contenu du fichier","text":"<pre><code>smtp      inet  n       -       y       -       -       smtpd\n  -o smtpd_tls_security_level=may\n\nsmtps     inet  n       -       y       -       -       smtpd\n  -o smtpd_tls_wrappermode=yes\n  -o smtpd_sasl_auth_enable=yes\n  -o smtpd_tls_security_level=encrypt\n\nsubmission inet n       -       y       -       -       smtpd\n  -o smtpd_tls_security_level=encrypt\n  -o smtpd_sasl_auth_enable=yes\n</code></pre>"},{"location":"srv/mail/#description-des-blocs-de-service","title":"Description des blocs de service :","text":""},{"location":"srv/mail/#1-smtp-port-25","title":"1. SMTP (port 25)","text":"Champ Valeur Explication <code>smtp</code> <code>inet</code> Active le service SMTP sur le port standard 25. <code>smtpd_tls_security_level=may</code> - Le chiffrement TLS est optionnel."},{"location":"srv/mail/#2-smtps-port-465","title":"2. SMTPS (port 465)","text":"Champ Valeur Explication <code>smtps</code> <code>inet</code> Active le SMTPS sur le port 465. <code>smtpd_tls_wrappermode=yes</code> - TLS est actif d\u00e8s le d\u00e9but de la connexion (pas de STARTTLS, c\u2019est un tunnel TLS direct). <code>smtpd_sasl_auth_enable=yes</code> - Active l\u2019authentification pour les clients mail. <code>smtpd_tls_security_level=encrypt</code> - Le chiffrement est obligatoire."},{"location":"srv/mail/#3-submission-port-587","title":"3. Submission (port 587)","text":"Champ Valeur Explication <code>submission</code> <code>inet</code> Port recommand\u00e9 pour les clients authentifi\u00e9s (ex : webmail, Outlook). <code>smtpd_tls_security_level=encrypt</code> - TLS obligatoire (via STARTTLS). <code>smtpd_sasl_auth_enable=yes</code> - Authentification activ\u00e9e. <p>C\u2019est le standard moderne pour l\u2019envoi de mails authentifi\u00e9s par les utilisateurs.</p>"},{"location":"srv/mail/#postfixadmin-sslconfj2","title":"<code>postfixadmin-ssl.conf.j2</code>","text":"<p>Ce fichier est un fichier de configuration Apache (VirtualHost) destin\u00e9 \u00e0 activer le site web s\u00e9curis\u00e9 PostfixAdmin sur le serveur <code>srv-mail.itway.local</code>, via HTTPS (port 443).</p> <ul> <li> <p>PostfixAdmin est une interface web de gestion des utilisateurs, domaines et alias pour Postfix.</p> </li> <li> <p>Cette configuration permet d\u2019exposer l\u2019interface en HTTPS avec des certificats sign\u00e9s par la CA interne.</p> </li> <li> <p>Le fichier est utilis\u00e9 avec la commande <code>a2ensite</code> pour l\u2019activer.</p> </li> </ul>"},{"location":"srv/mail/#contenu-du-fichier_4","title":"Contenu du fichier","text":"<pre><code>&lt;VirtualHost *:443&gt;\n    ServerName srv-mail.itway.local\n\n    DocumentRoot /usr/share/postfixadmin\n    Alias /postfixadmin /usr/share/postfixadmin/public\n\n    SSLEngine on\n    SSLCertificateFile    /etc/postfix/ssl/srv-mail.crt\n    SSLCertificateKeyFile /etc/postfix/ssl/srv-mail.key\n    SSLCACertificateFile  /etc/postfix/ssl/ca.crt\n\n    &lt;Directory /usr/share/postfixadmin/public&gt;\n        Options FollowSymLinks\n        AllowOverride All\n        Require ip 172.16.10.0/29\n    &lt;/Directory&gt;\n\n    ErrorLog ${APACHE_LOG_DIR}/postfixadmin_error.log\n    CustomLog ${APACHE_LOG_DIR}/postfixadmin_access.log combined\n&lt;/VirtualHost&gt;\n</code></pre>"},{"location":"srv/mail/#description-des-directives","title":"Description des directives","text":"Directive Description <code>&lt;VirtualHost *:443&gt;</code> D\u00e9clare un site \u00e9coutant sur le port 443 (HTTPS). <code>ServerName srv-mail.itway.local</code> Nom DNS utilis\u00e9 pour acc\u00e9der au site. <code>DocumentRoot</code> R\u00e9pertoire principal du site PostfixAdmin. <code>Alias /postfixadmin</code> Permet d'acc\u00e9der \u00e0 l'interface via <code>https://srv-mail.itway.local/postfixadmin</code>. <code>SSLEngine on</code> Active le SSL/TLS pour ce site. <code>SSLCertificateFile</code> Chemin vers le certificat public du serveur. <code>SSLCertificateKeyFile</code> Cl\u00e9 priv\u00e9e associ\u00e9e au certificat (doit rester confidentielle). <code>SSLCACertificateFile</code> Certificat de l\u2019autorit\u00e9 de certification utilis\u00e9e (CA interne). <code>&lt;Directory&gt;</code> Contr\u00f4le les droits d\u2019acc\u00e8s et le comportement du r\u00e9pertoire contenant l\u2019interface web. <code>AllowOverride All</code> Autorise l\u2019usage de <code>.htaccess</code> pour modifier dynamiquement certaines r\u00e8gles Apache. <code>Require ip 172.16.10.0/29</code> Permet l\u2019acc\u00e8s seulement au VLAN IT NETWORK. <code>ErrorLog</code>, <code>CustomLog</code> Chemins vers les fichiers de logs sp\u00e9cifiques pour PostfixAdmin. <p>A savoir : Ce fichier s\u2019active avec <code>a2ensite postfixadmin-ssl.conf</code>, puis <code>service apache2 restart</code>.</p>"},{"location":"srv/mail/#8-securite-conformite","title":"8. S\u00e9curit\u00e9 &amp; conformit\u00e9","text":"<ul> <li>Chiffrement TLS activ\u00e9 pour Postfix, Dovecot et l\u2019interface web PostfixAdmin (certificats sign\u00e9s par une CA interne).</li> <li>Acc\u00e8s \u00e0 PostfixAdmin restreint au r\u00e9seau interne (option via <code>Require ip</code> dans Apache).</li> <li>Authentification s\u00e9curis\u00e9e (via LDAP ou SQL) avec mots de passe chiffr\u00e9s en <code>SHA512-CRYPT</code>.</li> <li>Rejet des connexions non s\u00e9curis\u00e9es (auth impossible sans TLS, <code>disable_plaintext_auth = yes</code>).</li> <li>Permissions strictes sur les fichiers sensibles (cl\u00e9s priv\u00e9es, configs).</li> <li>Relais SMTP contr\u00f4l\u00e9 : seuls les utilisateurs internes ou authentifi\u00e9s peuvent envoyer des mails.</li> </ul>"},{"location":"srv/mail/#9-problemes-rencontres-solutions","title":"9. Probl\u00e8mes rencontr\u00e9s &amp; solutions","text":""},{"location":"srv/mail/#probleme-1-resolution-dns-de-srv-mailitwaylocal","title":"Probl\u00e8me 1 : R\u00e9solution DNS de <code>srv-mail.itway.local</code>","text":"<ul> <li>Sympt\u00f4me : <code>Name or service not known</code> lors d\u2019une tentative de connexion TLS (<code>openssl s_client</code>).</li> <li>Cause : Le serveur DMZ-SMTP ne parvenait pas \u00e0 r\u00e9soudre le nom du serveur interne.</li> <li>Solution : Ajout d\u2019une entr\u00e9e manuelle dans <code>/etc/hosts</code> sur le serveur DMZ :</li> </ul> <pre><code>172.16.50.4 srv-mail.itway.local\n</code></pre>"},{"location":"srv/mail/#probleme-2-port-465-smtps-inaccessible","title":"Probl\u00e8me 2 : Port 465 (SMTPS) inaccessible","text":"<ul> <li>Sympt\u00f4me : <code>Connection refused</code> en testant avec <code>openssl s_client -connect srv-mail.itway.local:465</code>.</li> <li>Cause : Le service Postfix n\u2019\u00e9coutait pas sur le port SMTPS (465).</li> <li> <p>Solution :</p> <ul> <li>V\u00e9rification de la configuration dans <code>master.cf</code>.</li> <li>Ajout du bloc <code>smtps</code> avec <code>smtpd_tls_wrappermode=yes</code>.</li> <li>Red\u00e9marrage de Postfix.</li> </ul> </li> </ul>"},{"location":"srv/mail/#probleme-3-postfix-ne-demarre-pas-dans-le-conteneur","title":"Probl\u00e8me 3 : Postfix ne d\u00e9marre pas dans le conteneur","text":"<ul> <li> <p>Erreurs :</p> </li> <li> <p><code>System has not been booted with systemd</code></p> </li> <li> <p><code>postsuper: Permission denied on /var/spool/postfix/...</code></p> </li> <li> <p>Causes :</p> <ul> <li>Le serveur SRV-MAIL tourne dans un conteneur sans <code>systemd</code>.</li> <li>Les permissions de <code>/var/spool/postfix/</code> avaient \u00e9t\u00e9 modifi\u00e9es (probablement par des t\u00e2ches Ansible).</li> <li>Tous les fichiers appartenaient \u00e0 <code>ubuntu:ubuntu</code> au lieu de <code>postfix:postfix</code>.</li> </ul> </li> <li> <p>Solution :</p> </li> </ul> <pre><code>sudo chown -R postfix:postfix /var/spool/postfix\npostfix start\n</code></pre>"},{"location":"srv/mail/#conclusion","title":"Conclusion","text":"<p>Le serveur SRV-MAIL remplit son r\u00f4le de serveur de distribution interne des courriers \u00e9lectroniques. En s\u2019appuyant sur un stack open-source \u00e9prouv\u00e9 (Postfix + Dovecot + MariaDB), il offre :</p> <ul> <li>Une solution robuste et s\u00e9curis\u00e9e,</li> <li>Un acc\u00e8s simple et centralis\u00e9 \u00e0 la messagerie des utilisateurs,</li> <li>Une interface d\u2019administration conviviale (PostfixAdmin),</li> <li>Une int\u00e9gration propre avec la passerelle SMTP DMZ.</li> </ul> <p>Manquant :  Mettre pop3s et sans supprim\u00e9 les donn\u00e9es du serveur.</p>"},{"location":"srv/pki/","title":"SRV-PKI (<code>srv-pki.itway.local</code>)","text":"<p>Playbook Ansible complet</p>"},{"location":"srv/pki/#1-objectifs","title":"1. Objectifs","text":"<p>Le serveur SRV-PKI a pour r\u00f4le d\u2019\u00eatre l\u2019autorit\u00e9 de certification interne de l\u2019entreprise ITWay. Il est charg\u00e9 :</p> <ul> <li>G\u00e9n\u00e9rer des certificats num\u00e9riques (SSL/TLS),</li> <li>Signer les demandes de certificats pour les services internes (VPN, Webmail, etc.),</li> <li>Publier des Listes de R\u00e9vocation de Certificats (CRL).</li> </ul>"},{"location":"srv/pki/#2-presentation-du-service","title":"2. Pr\u00e9sentation du service","text":""},{"location":"srv/pki/#21-quest-ce-quune-pki","title":"2.1 Qu'est-ce qu'une PKI ?","text":"<p>Une PKI (Infrastructure \u00e0 Cl\u00e9s Publiques) est un syst\u00e8me cryptographique utilis\u00e9 pour :</p> <ul> <li>Authentifier l\u2019identit\u00e9 des utilisateurs et des machines,</li> <li>Chiffrer les communications pour les s\u00e9curiser,</li> <li>Signer num\u00e9riquement les \u00e9changes (garantie d\u2019int\u00e9grit\u00e9 et non-r\u00e9pudiation).</li> </ul> <p>Elle repose sur l\u2019utilisation de paires de cl\u00e9s :</p> <ul> <li>Une cl\u00e9 priv\u00e9e : conserv\u00e9e secr\u00e8tement,</li> <li>Une cl\u00e9 publique : diffus\u00e9e librement.</li> </ul> <p>L\u2019objectif principal : fournir des certificats num\u00e9riques valides aux entit\u00e9s internes pour s\u00e9curiser les services (HTTPS, VPN, authentification, etc.).</p> <p>Le serveur g\u00e8re aussi :</p> <ul> <li>Les CSR (Certificate Signing Requests), qui sont des demandes de certificats cr\u00e9\u00e9es par les services,</li> <li>Les SAN (Subject Alternative Name), qui permettent d\u2019avoir plusieurs noms DNS dans un m\u00eame certificat.</li> </ul>"},{"location":"srv/pki/#22-les-composants-dune-pki","title":"2.2 Les composants d'une PKI","text":"\u00c9l\u00e9ment R\u00f4le principal CA (Certificate Authority) Entit\u00e9 de confiance qui signe les certificats CRL (Certificate Revocation List) Liste des certificats r\u00e9voqu\u00e9s Certificats Fichiers d'identit\u00e9 num\u00e9riques pour utilisateurs/machines Cl\u00e9 priv\u00e9e Secr\u00e8te, utilis\u00e9e pour signer ou d\u00e9crypter Cl\u00e9 publique Accessible, utilis\u00e9e pour v\u00e9rifier une signature ou chiffrer CSR (Certificate Signing Request) Demande de certificat sign\u00e9e par une entit\u00e9"},{"location":"srv/pki/#23-cycle-de-vie-dun-certificat","title":"2.3 Cycle de vie d\u2019un certificat","text":"<ol> <li>G\u00e9n\u00e9ration d\u2019une cl\u00e9 priv\u00e9e/publique</li> <li>Cr\u00e9ation d\u2019une CSR</li> <li>Signature de la CSR par la CA \u2192 cr\u00e9ation du certificat</li> <li>Utilisation du certificat par un serveur (ex : HTTPS, VPN, RDP\u2026)</li> <li>R\u00e9vocation (si compromission, d\u00e9part, etc.) \u2192 ajout \u00e0 la CRL</li> <li>Renouvellement avant expiration</li> </ol>"},{"location":"srv/pki/#24-structure-du-pki-dans-mon-projet","title":"2.4 Structure du PKI dans mon projet","text":"<pre><code>/etc/pki/\n\u251c\u2500\u2500 certs/        \u2190 Certificats d\u00e9livr\u00e9s\n\u251c\u2500\u2500 private/      \u2190 Cl\u00e9s priv\u00e9es (permissions strictes)\n\u251c\u2500\u2500 crl/          \u2190 Listes de r\u00e9vocation\n\u251c\u2500\u2500 newcerts/     \u2190 Certificats r\u00e9cemment sign\u00e9s\n\u251c\u2500\u2500 index.txt     \u2190 Historique des certificats\n\u251c\u2500\u2500 serial        \u2190 Num\u00e9ro de s\u00e9rie courant\n\u251c\u2500\u2500 openssl.cnf   \u2190 Fichier de configuration central\n</code></pre>"},{"location":"srv/pki/#25-differents-dossiers-et-commandes","title":"2.5 Diff\u00e9rents dossiers et commandes","text":"<p>\u27a4 <code>/etc/pki/certs/</code></p> <p>Il contient tous les certificats d\u00e9livr\u00e9s par la CA, y compris le certificat de la CA (<code>ca.crt</code>). Et les certificats sign\u00e9s pour les services (<code>webmail.itway.fr.crt</code> et autre).</p> <p>Cr\u00e9ation manuelle : <pre><code>mkdir -p /etc/pki/certs\nchmod 755 /etc/pki/certs\n</code></pre> Mode <code>0755</code> : Lecture/exec publique. Parfait pour des dossiers standards.</p> <p>\u27a4 <code>certs/ca.crt</code> C'est un certificat d\u2019autorit\u00e9 (CA) auto-sign\u00e9, ce qui est souvent la premi\u00e8re \u00e9tape pour mettre en place une infrastructure PKI interne.</p> <p>Commande pour g\u00e9n\u00e9rer un certificat auto-sign\u00e9 de la CA :  <pre><code>openssl req -x509 -new -key /etc/pki/private/ca.key -sha256 -days 3650 -config /etc/ssl/openssl.cnf -extensions v3_ca -out /etc/pki/certs/ca.crt\n</code></pre></p> <p>\u27a4 <code>/etc/pki/private/</code></p> <p>Il contient les cl\u00e9s priv\u00e9es, qui sont strictement confidentielles. Par exemple (<code>ca.key</code> ou <code>webmail.itway.fr.key</code> )</p> <p>Cr\u00e9ation manuelle : <pre><code>mkdir -p /etc/pki/private\nchmod 700 /etc/pki/private\n</code></pre> Mode <code>0700</code> : Priv\u00e9 (admin seulement). Dossier private/, acc\u00e8s restreint.</p> <p>\u27a4 <code>/etc/pki/private/ca.key</code> C'est le fichier qui contient la cl\u00e9 de d\u00e9chiffrement.</p> <p>C'est la cl\u00e9 priv\u00e9, la commande suivante permet d'en cr\u00e9\u00e9 une :  <pre><code>openssl genrsa -out /etc/pki/private/ca.key 4096\n</code></pre></p> <p>\u27a4 <code>/etc/pki/crl/</code></p> <p>C'est le stocke des listes de R\u00e9vocation de Certificats (CRL), le fichier principal est le <code>crl.pem</code>.</p> <p>La commande de cr\u00e9ation de la CRL : <pre><code>openssl ca -gencrl -config /etc/ssl/openssl.cnf -out /etc/pki/crl/crl.pem\n</code></pre></p> Option Explication <code>ca</code> Utilise le mode \"CA\" d'OpenSSL (autorit\u00e9 de certification) <code>-gencrl</code> G\u00e9n\u00e9re une liste de r\u00e9vocation (CRL) <code>-config</code> Utilise le fichier <code>openssl.cnf</code> <code>-out</code> O\u00f9 stocker la CRL g\u00e9n\u00e9r\u00e9e <p>\u27a4 <code>crl/crl.pem</code> C'est un fichier de liste de r\u00e9vocation de certificats, c'est une liste CRL (Certificate Revocation List), c\u2019est-\u00e0-dire une liste de certificats r\u00e9voqu\u00e9s par une autorit\u00e9 de certification (CA).  La commande suivante permet d'en cr\u00e9\u00e9 une : <pre><code>openssl ca -gencrl -config /etc/ssl/openssl.cnf -out /etc/pki/crl/crl.pem\n</code></pre></p> \u00c9l\u00e9ment R\u00f4le <code>openssl</code> Outil en ligne de commande pour la cryptographie (librairie OpenSSL). <code>ca</code> Sous-commande pour g\u00e9rer une autorit\u00e9 de certification. <code>-gencrl</code> Demande de g\u00e9n\u00e9rer une CRL (liste de r\u00e9vocation). <code>-config /etc/ssl/openssl.cnf</code> Fichier de configuration contenant les infos de la CA (chemins, politiques, etc.). <code>-out /etc/pki/crl/crl.pem</code> Fichier de sortie de la CRL g\u00e9n\u00e9r\u00e9e, au format PEM. <p>\u27a4 <code>/etc/pki/newcerts/</code></p> <p>Il contient les certificats g\u00e9n\u00e9r\u00e9s r\u00e9cemment, avec des noms de fichiers num\u00e9rot\u00e9s automatiquement (par le fichier <code>serial</code>).</p> <p>Cr\u00e9ation manuelle : <pre><code>mkdir -p /etc/pki/newcerts\nchmod 755 /etc/pki/newcerts\n</code></pre></p> <p>\u27a4 <code>/etc/pki/serial</code></p> <p>Il contient le num\u00e9ro de s\u00e9rie courant \u00e0 attribuer au prochein certificat sign\u00e9. Il commence g\u00e9n\u00e9ralement \u00e0 <code>1</code>.</p> <p>Cr\u00e9ation manuelle : <pre><code>echo 01 &gt; /etc/pki/serial\nchmod 644 /etc/pki/serial\n</code></pre></p> <p>\u27a4 <code>/etc/pki/index.txt</code></p> <p>C\u2019est la base de donn\u00e9es des certificats. Elle garde une trace de tous les certificats sign\u00e9s par la CA, avec leurs \u00e9tat (Valid\u00e9s, Expir\u00e9s, R\u00e9voqu\u00e9s).</p> <p>Cr\u00e9ation manuelle : <pre><code>touch /etc/pki/index.txt\nchmod 644 /etc/pki/index.txt\n</code></pre> Mode <code>0644</code> : Lecture pour tous. Pour les certificats <code>.crt</code>.</p> <p>Au d\u00e9part le contenu il est vide et ensuite il est rempli automatiquement par <code>openssl ca</code>.</p> <p>\u27a4 <code>/etc/pki/crlnumber</code></p> <p>Le fichier crlnumber est utilis\u00e9 pour versionner chaque CRL qu'on \u00e9mets. C\u2019est comme un num\u00e9ro de s\u00e9rie sp\u00e9cifique aux listes de r\u00e9vocation. Il est obligatoire pour \u00eatre conforme \u00e0 la norme <code>X.509</code> et \u00e0 chaque nouvelle CRL (le num\u00e9ro est incr\u00e9ment\u00e9 automatiquement).</p> <p>Exemple de g\u00e9n\u00e9ration une CRL :  <pre><code>openssl ca -gencrl -config /etc/ssl/openssl.cnf -out /etc/pki/crl/crl.pem\n</code></pre></p> Option Explication <code>ca</code> Utilise le mode \"CA\" d'OpenSSL (autorit\u00e9 de certification) <code>-gencrl</code> G\u00e9n\u00e9re une liste de r\u00e9vocation (CRL) <code>-config</code> Utilise le fichier <code>openssl.cnf</code> <code>-out</code> O\u00f9 stocker la CRL g\u00e9n\u00e9r\u00e9e <p>Cr\u00e9ation manuelle : <pre><code>echo 01 &gt; /etc/pki/crlnumber\nchmod 644 /etc/pki/crlnumber\n</code></pre></p> <p>\u27a4 <code>reqs/*.csr</code> C'est un fichier g\u00e9n\u00e9r\u00e9 lorsqu\u2019on souhaite obtenir un certificat num\u00e9rique sign\u00e9 par une autorit\u00e9 de certification (CA).</p> <p>Demande de certificat pour un service (ex: Webmail) : <pre><code>openssl req -new -key /etc/pki/private/webmail.itway.fr.key -out /etc/pki/reqs/webmail.itway.fr.csr -config /etc/pki/openssl_webmail.cnf\n</code></pre></p> <p>\u27a4 <code>certs/*.fullchain.crt</code> Certificat du service + certificat de la CA (cha\u00eene compl\u00e8te), ce contient la cha\u00eene compl\u00e8te de certificats, ce qui est essentiel pour assurer la confiance du client (navigateur, OS, etc.) lors d'une connexion HTTPS. Ce fichier contient plusieurs certificats empil\u00e9s. <pre><code>cat webmail.itway.fr.crt ca.crt &gt; webmail.itway.fr.fullchain.crt\n</code></pre></p> <p>Pourquoi on concat\u00e8ne un certificat : Lorsqu\u2019un client (navigateur, syst\u00e8me, application) se connecte \u00e0 un site HTTPS :</p> <ul> <li>Il re\u00e7oit le certificat du serveur (ex. : itway.fr)</li> <li>Il doit v\u00e9rifier l\u2019authenticit\u00e9 de ce certificat via une cha\u00eene de confiance :<ul> <li>Le certificat du serveur a \u00e9t\u00e9 sign\u00e9 par une CA interm\u00e9diaire</li> <li>Elle-m\u00eame a \u00e9t\u00e9 sign\u00e9e par une CA racine (connue du syst\u00e8me client)</li> </ul> </li> </ul> <p>Si un maillon est manquant, le client affiche une erreur de certificat non fiable.</p> <p>\u27a4 <code>/etc/ssl/openssl.cnf</code></p> <p>C'est le fichier de configuration central pour OpenSSL. Il d\u00e9finit les chemins, dur\u00e9es de validit\u00e9 et l'usages autoris\u00e9s. Il contient \u00e9galement les sections v3_ca, v3_server, v3_client. Il sert \u00e0 la cr\u00e9ation et signature du certificat.</p> <p>Exemple d'utilisation :  <pre><code>openssl req -new -x509 -days 3650 -config /etc/ssl/openssl.cnf -key private/ca.key -out certs/ca.crt\n</code></pre></p> Option Explication <code>req</code> Lance une requ\u00eate de certificat <code>-x509</code> Cr\u00e9e un certificat auto-sign\u00e9 (pas une CSR) <code>-new</code> G\u00e9n\u00e8re un nouveau certificat <code>-key</code> Sp\u00e9cifie la cl\u00e9 priv\u00e9e <code>-sha256</code> Algorithme de signature <code>-days</code> Dur\u00e9e de validit\u00e9 <code>-config</code> Fichier <code>openssl.cnf</code> utilis\u00e9"},{"location":"srv/pki/#26-rappels-des-extensions","title":"2.6 Rappels des extensions","text":"Extension Signification Contenu <code>.key</code> Cl\u00e9 priv\u00e9e Doit rester secr\u00e8te, utilis\u00e9e pour signer <code>.csr</code> Certificate Signing Request Demande envoy\u00e9e \u00e0 la CA pour obtenir un certificat <code>.crt</code> Certificat sign\u00e9 (cl\u00e9 publique) Contient la cl\u00e9 publique + signature de la CA <code>.fullchain.crt</code> Certificat + CA Utilis\u00e9 pour les services web, inclut toute la cha\u00eene de confiance <code>.pem</code> Format texte de tous les fichiers Peut contenir cl\u00e9, certificat ou CRL"},{"location":"srv/pki/#27-resume-des-taches-du-pki","title":"2.7 R\u00e9sum\u00e9 des t\u00e2ches du PKI","text":"<ol> <li>G\u00e9n\u00e9rer une cl\u00e9 priv\u00e9e : <pre><code>openssl genrsa -out webmail.itway.fr.key 4096\n</code></pre></li> <li>Cr\u00e9er une demande de certificat (CSR) : <pre><code>openssl req -new -key webmail.itway.fr.key -out webmail.itway.fr.csr -config openssl_webmail.cnf\n</code></pre></li> <li>Signer avec la CA : <pre><code>openssl x509 -req -in webmail.itway.fr.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out webmail.itway.fr.crt -days 3650 -sha256\n</code></pre></li> <li>Cr\u00e9er un fullchain :  <pre><code>cat webmail.itway.fr.crt ca.crt &gt; webmail.itway.fr.fullchain.crt\n</code></pre></li> </ol>"},{"location":"srv/pki/#3-ce-que-fait-le-serveur-srv-pki-dans-itway","title":"3. Ce que fait le serveur SRV-PKI dans ITWay","text":"<ul> <li>G\u00e9n\u00e8re la cl\u00e9 priv\u00e9e de la CA</li> <li>Cr\u00e9e et signe un certificat auto-sign\u00e9</li> <li>G\u00e8re les demandes de certificats (CSR) internes</li> <li>Produit les certificats valides pour :<ul> <li>Web internes (HTTPS)</li> <li>Acc\u00e8s VPN</li> <li>Interfaces de supervision</li> <li>Authentification LDAPS, etc.</li> </ul> </li> <li>Publie la liste CRL, accessible en lecture pour les autres services</li> <li>Ne communique pas vers l\u2019ext\u00e9rieur, sauf en consultation interne</li> </ul>"},{"location":"srv/pki/#4-justification-des-choix","title":"4. Justification des choix","text":"<ul> <li>Outils principaux :<ul> <li><code>OpenSSL</code> pour la g\u00e9n\u00e9ration et la gestion des certificats,</li> <li><code>Ansible</code> pour le d\u00e9ploiement automatis\u00e9 (via r\u00f4les et playbook),</li> </ul> </li> <li>Structure conforme aux standards (arborescence OpenSSL, s\u00e9parations des r\u00f4les et CRL).</li> </ul> <p>Pourquoi ces choix ?</p> <ul> <li>OpenSSL : open-source, complet, bien document\u00e9.</li> <li>Ansible : permet l\u2019automatisation, la reproductibilit\u00e9, la coh\u00e9rence des installations.</li> </ul>"},{"location":"srv/pki/#5-structure-du-projet-ansible","title":"5. Structure du projet Ansible","text":"<pre><code>\u251c\u2500\u2500 ansible.cfg\n\u251c\u2500\u2500 inventory/\n\u2502   \u2514\u2500\u2500 hosts.ini\n\u251c\u2500\u2500 playbooks/\n\u2502   \u2514\u2500\u2500 setup-pki.yml\n\u2514\u2500\u2500 roles/\n    \u2514\u2500\u2500 srv-pki/\n        \u251c\u2500\u2500 files/\n        \u2502   \u2514\u2500\u2500 openssl_webmail.cnf     \n        \u251c\u2500\u2500 handlers/\n        \u2502   \u2514\u2500\u2500 main.yml                     \n        \u251c\u2500\u2500 tasks/\n        \u2502   \u251c\u2500\u2500 main.yml                    \n        \u2502   \u2514\u2500\u2500 webmail.yml                  \n        \u251c\u2500\u2500 templates/\n        \u2502   \u2514\u2500\u2500 openssl.cnf.j2              \n        \u2514\u2500\u2500 vars/\n            \u2514\u2500\u2500 main.yml\n</code></pre>"},{"location":"srv/pki/#6-ce-que-le-playbook-execute-dans-srv-pki","title":"6. Ce que le Playbook execute dans <code>SRV-PKI</code>","text":""},{"location":"srv/pki/#1-configuration-des-variables-pki","title":"1. Configuration des variables PKI","text":"<p>Pour que le playbook s'execute correctement il faut mettre en place le fichiers de variables centralis\u00e9es dans (<code>vars/main.yml</code>), qui contient les param\u00e8tre qui peuvent \u00e9voluer selon le besoin.</p>"},{"location":"srv/pki/#2-deploiement-automatise-avec-ansible","title":"2. D\u00e9ploiement automatis\u00e9 avec Ansible","text":"<ol> <li>Installation des paquets n\u00e9cessaires :<ul> <li><code>openssl</code></li> <li><code>ca-certificate</code></li> </ul> </li> <li>Cr\u00e9ation de l\u2019arborescence PKI, r\u00e9pertoires : <ul> <li>certs, </li> <li>crl, </li> <li>newcerts, </li> <li>private <p>Permissions adapt\u00e9es selon la sensibilit\u00e9 du dossier</p> </li> </ul> </li> <li>Initialisation des fichiers de base :<ul> <li><code>index.txt</code>, </li> <li><code>serial</code>, </li> <li><code>crlnumber</code> <p>G\u00e9n\u00e9r\u00e9s uniquement s\u2019ils n\u2019existent pas, avec valeurs par d\u00e9faut (01)</p> </li> </ul> </li> <li>D\u00e9ploiement du fichier de configuration OpenSSL : <ul> <li>Utilisation d\u2019un template Jinja2 (<code>openssl.cnf.j2</code>)</li> <li>Inclusion de profils <code>v3_ca</code>, <code>v3_server</code>, <code>v3_client</code>, avec gestion de SAN. </li> </ul> </li> <li>G\u00e9n\u00e9ration de la CA :<ul> <li>Cl\u00e9 priv\u00e9e : <code>ca.key</code></li> <li>Certificat auto-sign\u00e9 : <code>ca.crt</code></li> <li>Extensions sp\u00e9cifiques au r\u00f4le de CA (<code>v3_ca</code>)</li> <li>S\u00e9curisation automatique des fichiers via un handler</li> </ul> </li> <li>G\u00e9n\u00e9ration du fichier al\u00e9atoire OpenSSL :<ul> <li><code>private/.rand</code> : n\u00e9cessaire pour la g\u00e9n\u00e9ration cryptographique</li> </ul> </li> <li>G\u00e9n\u00e9ration du CRL initial :<ul> <li><code>crl.pem</code> vide, pr\u00eat \u00e0 \u00eatre utilis\u00e9 pour la r\u00e9vocation</li> </ul> </li> <li>V\u00e9rification finale : <ul> <li>Affichage lisible du certificat CA et du CRL avec openssl x509 et openssl crl</li> </ul> </li> <li>G\u00e9n\u00e9ration et signature d\u2019un certificat serveur (pour Webmail) :<ol> <li>G\u00e9n\u00e8re une cl\u00e9 priv\u00e9e d\u00e9di\u00e9e au service webmail (webmail.itway.fr).</li> <li>Copie un fichier de configuration OpenSSL sp\u00e9cifique au webmail sur le serveur.</li> <li>Cr\u00e9e une CSR (Certificate Signing Request) pour le domaine webmail.itway.fr \u00e0 l'aide de la cl\u00e9 g\u00e9n\u00e9r\u00e9e et du fichier de configuration.</li> <li>Signe la CSR avec le certificat de l'autorit\u00e9 de certification (CA) pr\u00e9c\u00e9demment cr\u00e9\u00e9e.</li> <li>G\u00e9n\u00e8re un certificat fullchain, c\u2019est-\u00e0-dire le certificat du webmail concat\u00e9n\u00e9 avec celui de la CA, pr\u00eat \u00e0 \u00eatre utilis\u00e9 sur un serveur web s\u00e9curis\u00e9.</li> </ol> </li> </ol>"},{"location":"srv/pki/#7-fichiers-de-configuration","title":"7. Fichiers de configuration","text":"<p>Le fichier <code>openssl</code> est essentiel, car il dicte comment sont cr\u00e9\u00e9s et sign\u00e9s les certificats.</p>"},{"location":"srv/pki/#ca","title":"<code>[ ca ]</code>","text":"<p>Il d\u00e9finit que la configuration par d\u00e9faut de l\u2019autorit\u00e9 de certification (CA) est celle nomm\u00e9e <code>CA_default</code>. C\u2019est le point d\u2019entr\u00e9e global utilis\u00e9 par les commandes comme <code>openssl ca</code>. <pre><code>[ ca ]\ndefault_ca = CA_default\n</code></pre></p>"},{"location":"srv/pki/#ca_default","title":"<code>[ CA_default ]</code>","text":"<p>C\u2019est la section principale de configuration de la CA.  <pre><code>[ CA_default ]\ndir             = {{ pki_ca_dir }}\ncerts           = $dir/certs\ncrl_dir         = $dir/crl\nnew_certs_dir   = $dir/newcerts\ndatabase        = $dir/{{ pki_index_file }}\nserial          = $dir/{{ pki_serial_file }}\nRANDFILE        = $dir/private/.rand\nprivate_key     = $dir/private/{{ pki_ca_key_name }}\ncertificate     = $dir/certs/{{ pki_ca_cert_name }}\ndefault_md      = {{ pki_default_md }}\npolicy          = policy_match\nemail_in_dn     = no\ndefault_days    = {{ pki_ca_days }}\ndefault_crl_days = {{ pki_crl_days }}\ncrl_days        = {{ pki_crl_days }}\nunique_subject  = no\nx509_extensions = v3_ca\n</code></pre></p> <p>Voici le r\u00f4le de chaque directive :</p> Directive Description <code>dir</code> R\u00e9pertoire de base de la PKI (<code>/etc/pki</code>) <code>certs</code> O\u00f9 stocker les certificats sign\u00e9s <code>crl_dir</code> O\u00f9 stocker les CRL (listes de r\u00e9vocation) <code>new_certs_dir</code> O\u00f9 mettre les nouveaux certificats sign\u00e9s (historique) <code>database</code> Fichier index de la CA (trace de tous les certificats) <code>serial</code> Fichier avec le prochain num\u00e9ro de s\u00e9rie <code>RANDFILE</code> Fichier d'entropie utilis\u00e9 par OpenSSL pour g\u00e9n\u00e9rer des cl\u00e9s <code>private_key</code> Fichier de la cl\u00e9 priv\u00e9e de la CA <code>certificate</code> Fichier du certificat public de la CA <code>default_md</code> Algorithme de hachage par d\u00e9faut (<code>sha256</code>) <code>policy</code> R\u00e8gles de politique pour le contenu des certificats <code>email_in_dn</code> Ne pas inclure l\u2019email dans le DN <code>default_days</code> Validit\u00e9 par d\u00e9faut des certificats sign\u00e9s <code>crl_days</code> Dur\u00e9e de validit\u00e9 de la CRL <code>x509_extensions</code> Extensions \u00e0 utiliser pour les certificats sign\u00e9s par la CA (ici <code>v3_ca</code>)"},{"location":"srv/pki/#policy_match","title":"<code>[ policy_match ]</code>","text":"<p>D\u00e9finit quelles infos doivent \u00eatre pr\u00e9sentes et valides dans les CSR (Certificate Signing Requests) :</p> <pre><code>[ policy_match ]\ncountryName             = match\nstateOrProvinceName     = match\norganizationName        = match\norganizationalUnitName  = optional\ncommonName              = supplied\nemailAddress            = optional\n</code></pre> Champ R\u00f4le <code>match</code> Doit correspondre exactement \u00e0 la CA <code>supplied</code> L'utilisateur doit le fournir <code>optional</code> Peut \u00eatre vide"},{"location":"srv/pki/#v3_ca","title":"<code>[ v3_ca ]</code>","text":"<p>Extensions utilis\u00e9es pour le certificat racine (CA) : <pre><code>[ v3_ca ]\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical, CA:true\nkeyUsage = critical, digitalSignature, cRLSign, keyCertSign\n</code></pre></p> <ul> <li><code>basicConstraints = CA:true</code> \u2192 ce certificat est une autorit\u00e9 de certification.</li> <li><code>keyUsage</code> \u2192 Ce que le certificat a le droit de faire : signer d'autres certificats (<code>keyCertSign</code>), signer des CRL (<code>cRLSign</code>).</li> <li><code>critical</code> \u2192 L\u2019extension est obligatoire pour que le certificat soit accept\u00e9.</li> </ul>"},{"location":"srv/pki/#v3_server","title":"<code>[ v3_server ]</code>","text":"<p>Extensions utilis\u00e9es pour les certificats de serveurs (ex : HTTPS) : <pre><code>[ v3_server ]\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical, CA:false\nkeyUsage = critical, digitalSignature, keyEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = DNS:itway.fr, DNS:dmz-web.itway.fr, DNS:srv-mail.itway.local, DNS:srv-mail\n</code></pre></p> <ul> <li><code>CA:false</code> \u2192 Ce certificat ne peut pas signer d'autres certificats.</li> <li><code>keyEncipherment</code> \u2192 Permet le chiffrement des \u00e9changes.</li> <li><code>extendedKeyUsage = serverAuth</code> \u2192 Utilisable pour un serveur.</li> <li><code>subjectAltName</code> (SAN) \u2192 Liste les domaines que le certificat couvre.</li> </ul>"},{"location":"srv/pki/#v3_client","title":"<code>[ v3_client ]</code>","text":"<p>Pour des certificats utilis\u00e9s par des clients (utilisateurs, VPN, etc.) : <pre><code>[ v3_client ]\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical, CA:false\nkeyUsage = critical, digitalSignature\nextendedKeyUsage = clientAuth\n</code></pre></p> <ul> <li><code>clientAuth</code> \u2192 Permet l\u2019authentification c\u00f4t\u00e9 client (par ex. dans un VPN).</li> <li>Pas de SAN ici, car ce n\u2019est pas li\u00e9 \u00e0 un nom de domaine.</li> </ul>"},{"location":"srv/pki/#alt_names","title":"<code>[ alt_names ]</code>","text":"<p>Liste des noms DNS alternatifs autoris\u00e9s dans les certificats sign\u00e9s : <pre><code>[ alt_names ]\nDNS.1 = itway.fr\nDNS.2 = dmz-web.itway.fr\nDNS.3 = srv-mail.itway.local\nDNS.4 = srv-mail\n</code></pre></p> <p>Ces noms appara\u00eetront dans le champ <code>Subject Alternative Name</code> du certificat, indispensable pour HTTPS moderne (le <code>CommonName</code> seul ne suffit plus).</p>"},{"location":"srv/pki/#8-securite-conformite","title":"8. S\u00e9curit\u00e9 &amp; conformit\u00e9","text":"<ul> <li>Les cl\u00e9s priv\u00e9es sont prot\u00e9g\u00e9es avec des permissions strictes (<code>0600</code>) dans un r\u00e9pertoire s\u00e9curis\u00e9 (<code>0700</code>).</li> <li>Les fichiers sensibles (<code>serial</code>, <code>crlnumber</code>, <code>index.txt</code>) sont cr\u00e9\u00e9s uniquement s\u2019ils n\u2019existent pas, \u00e9vitant toute perte de donn\u00e9es.</li> <li>Les certificats <code>X.509</code> sont g\u00e9n\u00e9r\u00e9s avec :<ul> <li>Algorithme de signature : <code>SHA-256</code></li> <li>Longueur de cl\u00e9 : 4096 bits</li> <li>Extensions conformes (<code>v3_ca</code>, <code>v3_server</code>) avec basicConstraints et keyUsage d\u00e9finis.</li> </ul> </li> <li>Le processus est enti\u00e8rement automatis\u00e9 et reproductible gr\u00e2ce \u00e0 Ansible.</li> <li>Acc\u00e8s restreint : seuls les utilisateurs autoris\u00e9s (ex. : ansible, root) peuvent manipuler les fichiers cl\u00e9s.</li> </ul>"},{"location":"srv/pki/#9-problemes-rencontres-et-solutions","title":"9. Probl\u00e8mes rencontr\u00e9s et solutions","text":""},{"location":"srv/pki/#1-probleme-dencodage-yaml","title":"1. Probl\u00e8me d'encodage YAML","text":"<ul> <li>Erreur : <code>Unexpected Exception: 'utf-8' codec can't encode character '\\udcc3'</code></li> <li>Cause : Caract\u00e8res accentu\u00e9s mal encod\u00e9s (souvent copi\u00e9s depuis Word)</li> <li>Solution : Conversion en UTF-8 avec <code>iconv</code> :</li> </ul> <pre><code>find . -name \"*.yml\" -exec iconv -f ISO-8859-1 -t UTF-8 \"{}\" -o \"{}\" \\;\n</code></pre>"},{"location":"srv/pki/#2-erreur-missing-sudo-password","title":"2. Erreur <code>Missing sudo password</code>","text":"<ul> <li>Cause : L'utilisateur <code>ansible</code> n'avait pas les droits <code>sudo</code> sans mot de passe</li> <li>Solution :</li> </ul> <p>Ajouter l'utilisateur dans <code>/etc/sudoers</code> :</p> <pre><code>ansible ALL=(ALL) NOPASSWD: ALL\n</code></pre>"},{"location":"srv/pki/#3-probleme-permissions-usrbinsudo","title":"3. Probl\u00e8me permissions <code>/usr/bin/sudo</code>","text":"<ul> <li>Erreur : <code>sudo must be owned by uid 0</code></li> <li>Solution :</li> </ul> <pre><code>chown root:root /usr/bin/sudo\nchmod 4755 /usr/bin/sudo\n</code></pre>"},{"location":"srv/pki/#4-erreur-de-certificat-hsts-avec-dmz-smtp","title":"4. Erreur de certificat HSTS avec DMZ-SMTP","text":"<p>Lors de l'acc\u00e8s via navigateur \u00e0 un service derri\u00e8re <code>dmz-smtp</code>, une erreur HSTS persistante apparaissait, emp\u00eachant toute connexion s\u00e9curis\u00e9e.</p> <p>Cause : Le champ <code>subjectAltName</code> n'\u00e9tait pas reconnu dans le certificat g\u00e9n\u00e9r\u00e9, bien que la section <code>[ alt_names ]</code> existait dans le fichier <code>openssl.cnf.j2</code> : <pre><code>[ alt_names ]\nDNS.1 = itway.fr\nDNS.2 = dmz-web.itway.fr\nDNS.3 = srv-mail.itway.local\nDNS.4 = srv-mail\n</code></pre> R\u00e9solution (partielle) : Apr\u00e8s plusieurs tentatives et recherches (24h), une solution de contournement a \u00e9t\u00e9 de cr\u00e9er un fichier de configuration sp\u00e9cifique au service concern\u00e9 (<code>openssl_webmail.cnf</code>) et de l'utiliser dans les commandes OpenSSL.</p> <p>Solution d\u00e9finitive (trouv\u00e9e plus tard) : Pour le serveur <code>srv-mail</code>, le probl\u00e8me a \u00e9t\u00e9 trouv\u00e9 et corrig\u00e9 en ajoutant explicitement la ligne suivante dans la section <code>[ v3_server ]</code> du fichier <code>openssl.cnf.j2</code> : <pre><code>subjectAltName = DNS:itway.fr, DNS:dmz-web.itway.fr, DNS:srv-mail.itway.local, DNS:srv-mail\n</code></pre> Cela a permis de g\u00e9n\u00e9rer un certificat fonctionnel avec les bons SANs, reconnu sans erreur HSTS par les navigateurs.</p> <p>Remarque : Par manque de temps, cette correction n'a pas \u00e9t\u00e9 appliqu\u00e9e r\u00e9troactivement au certificat dmz-smtp, qui utilise toujours le fichier d\u00e9di\u00e9 (<code>openssl_webmail.cnf</code>).</p>"},{"location":"srv/pki/#conclusion","title":"Conclusion","text":"<p>Le serveur SRV-PKI est d\u00e9sormais capable de :</p> <ul> <li>G\u00e9n\u00e9rer des certificats pour tous les services internes</li> <li>G\u00e9rer la r\u00e9vocation (CRL)</li> <li>Garantir une s\u00e9curit\u00e9 forte gr\u00e2ce \u00e0 la structure de fichiers, aux permissions strictes et \u00e0 l\u2019utilisation d\u2019Ansible</li> </ul>"},{"location":"srv/srv/","title":"SRV","text":""},{"location":"srv/srv/#srv-reseau-des-serveurs-internes","title":"SRV \u2013 R\u00e9seau des Serveurs Internes","text":""},{"location":"srv/srv/#1-en-quoi-consiste-le-srv-network","title":"1. En quoi consiste le SRV-NETWORK ?","text":"<p>Le SRV-NETWORK regroupe l\u2019ensemble des serveurs internes critiques n\u00e9cessaires au bon fonctionnement des services m\u00e9tiers et de l\u2019infrastructure de l\u2019entreprise. Contrairement \u00e0 la DMZ, ces serveurs ne sont pas accessibles depuis Internet mais uniquement depuis les r\u00e9seaux internes de confiance.</p> <p>Leur r\u00f4le est d\u2019assurer l\u2019authentification, la messagerie, la gestion des certificats et la diffusion de l\u2019information interne, dans un environnement s\u00e9curis\u00e9, cloisonn\u00e9 et hautement contr\u00f4l\u00e9.</p>"},{"location":"srv/srv/#2-objectifs-du-srv-network-dans-le-projet-it-way","title":"2. Objectifs du SRV-NETWORK dans le projet IT-WAY","text":"<ul> <li>Centraliser les services c\u0153ur (authentification, mail, intranet, PKI)</li> <li>S\u00e9curiser l\u2019acc\u00e8s et la configuration de chaque serveur</li> <li>Garantir un haut niveau d\u2019int\u00e9grit\u00e9, de confidentialit\u00e9 et de disponibilit\u00e9</li> <li>Isoler les services sensibles du reste de l\u2019infrastructure</li> </ul>"},{"location":"srv/srv/#3-services-presents-dans-le-srv-network","title":"3. Services pr\u00e9sents dans le SRV-NETWORK","text":"Nom d\u2019h\u00f4te R\u00f4le Domaine SRV-ADS01 Contr\u00f4leur de domaine Active Directory srv-ads01.itway.local SRV-INTRANET Serveur web intranet interne intranet.itway.local SRV-MAIL Serveur de messagerie interne (MDA/IMAP/POP) srv-mail.itway.local SRV-PKI Serveur d\u2019autorit\u00e9 de certification interne (PKI) srv-pki.itway.local"},{"location":"srv/srv/#4-adressage-ip-reseau-srv","title":"4. Adressage IP \u2013 R\u00e9seau SRV","text":"<p>Le r\u00e9seau SRV-NETWORK est adress\u00e9 selon le plan 10.10.20.0/24, d\u00e9di\u00e9 exclusivement aux serveurs internes.</p> Machine Adresse IP Interface accessible SRV-ADS01 172.16.50.2 R\u00e9seaux internes de confiance SRV-INTRANET 172.16.50.5 R\u00e9seaux internes (site intranet) SRV-MAIL 172.16.50.4 DMZ-SMTP (relai) + R\u00e9seaux internes SRV-PKI 172.16.50.3 IT-NET (admin) + internes (liste CRL only)"},{"location":"srv/srv/#5-resume-technique","title":"5. R\u00e9sum\u00e9 technique","text":"<ul> <li>Tous les acc\u00e8s d\u2019administration se font depuis IT-NET uniquement</li> <li>Les services utilisent des certificats sign\u00e9s par SRV-PKI</li> <li>SRV-ADS01 g\u00e8re l\u2019authentification, les GPO, profils itin\u00e9rants, IPSec, DNS interne</li> <li>SRV-INTRANET propose un site s\u00e9curis\u00e9 avec authentification LDAP</li> <li>SRV-MAIL travaille en collaboration avec DMZ-SMTP pour la distribution du courrier</li> <li>SRV-PKI est le centre de confiance pour les certificats SSL/VPN utilis\u00e9s dans toute l\u2019infrastructure</li> </ul>"}]}